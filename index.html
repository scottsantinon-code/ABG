<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Acid Base Pro</title>
  <meta name="author" content="Scott Santinon">
  <meta name="description" content="Systematic arterial blood gas interpretation tool supporting Traditional (Henderson-Hasselbalch) and Physicochemical (Stewart) approaches">
  <meta name="copyright" content="¬© 2025 Scott Santinon">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#FAFAFA">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: #FAFAFA;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F0F0F5;
      --text-primary: #000000;
      --text-secondary: #6E6E73;
      --text-tertiary: #AEAEB2;
      --accent: #0066CC;
      --accent-light: rgba(0, 102, 204, 0.08);
      --success: #30D158;
      --success-light: rgba(48, 209, 88, 0.12);
      --warning: #FF9F0A;
      --warning-light: rgba(255, 159, 10, 0.12);
      --error: #FF453A;
      --error-light: rgba(255, 69, 58, 0.12);
      --border: rgba(0, 0, 0, 0.04);
      --border-strong: rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 0 0 1px rgba(0,0,0,0.03), 0 2px 4px rgba(0,0,0,0.02);
      --shadow-md: 0 0 0 1px rgba(0,0,0,0.03), 0 4px 12px rgba(0,0,0,0.05);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --transition: 0.2s ease;
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.47059;
      min-height: 100vh;
      min-height: 100dvh;
      letter-spacing: -0.022em;
    }

    #root {
      min-height: 100vh;
      min-height: 100dvh;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 3px; }

    input[type="number"] { -moz-appearance: textfield; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    input::placeholder { color: #C7C7CC; opacity: 1; }
    input::-webkit-input-placeholder { color: #C7C7CC; }
    input::-moz-placeholder { color: #C7C7CC; opacity: 1; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in { animation: fadeIn 0.35s ease-out forwards; }
    .stagger-1 { animation-delay: 0.05s; opacity: 0; }
    .stagger-2 { animation-delay: 0.1s; opacity: 0; }
    .stagger-3 { animation-delay: 0.15s; opacity: 0; }
    .stagger-4 { animation-delay: 0.2s; opacity: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useRef } = React;

    // ============================================
    // CONSTANTS
    // ============================================

    const DEFAULTS = {
      albumin: 40,
      phosphate: 1.1,
      calcium: 1.15,
      magnesium: 0.85,
      lactate: 1.0,
      k: 4.0,
    };

    // ============================================
    // STYLES
    // ============================================

    const styles = {
      container: {
        minHeight: '100vh',
        minHeight: '100dvh',
        padding: '12px',
        paddingBottom: '32px',
        maxWidth: '440px',
        margin: '0 auto',
      },
      header: {
        textAlign: 'center',
        marginBottom: '20px',
        paddingTop: '8px',
      },
      stepIndicator: {
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        color: 'var(--accent)',
        textTransform: 'uppercase',
        marginBottom: '4px',
      },
      title: {
        fontSize: '26px',
        fontWeight: '700',
        letterSpacing: '-0.5px',
        color: 'var(--text-primary)',
        marginBottom: '4px',
      },
      subtitle: {
        fontSize: '14px',
        color: 'var(--text-secondary)',
        fontWeight: '400',
      },
      card: {
        background: 'var(--bg-secondary)',
        borderRadius: 'var(--radius-md)',
        padding: '16px',
        marginBottom: '10px',
        boxShadow: 'var(--shadow-sm)',
      },
      cardTitle: {
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '0.8px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '12px',
      },
      inputGroup: {
        marginBottom: '12px',
      },
      inputLabel: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '5px',
      },
      labelText: {
        fontSize: '13px',
        fontWeight: '500',
        color: 'var(--text-primary)',
      },
      labelUnit: {
        fontSize: '11px',
        color: 'var(--text-secondary)',
      },
      input: {
        width: '100%',
        padding: '10px 12px',
        border: '1px solid var(--border-strong)',
        borderRadius: 'var(--radius-sm)',
        fontSize: '16px',
        fontFamily: 'var(--font)',
        color: 'var(--text-primary)',
        background: 'var(--bg-tertiary)',
        transition: 'all var(--transition)',
        outline: 'none',
      },
      defaultBadge: {
        display: 'inline-flex',
        alignItems: 'center',
        padding: '2px 6px',
        background: 'var(--warning-light)',
        color: 'var(--warning)',
        borderRadius: '4px',
        fontSize: '10px',
        fontWeight: '600',
        marginLeft: '8px',
      },
      button: {
        width: '100%',
        padding: '12px 18px',
        border: 'none',
        borderRadius: 'var(--radius-sm)',
        background: 'var(--accent)',
        color: 'white',
        fontSize: '15px',
        fontWeight: '600',
        fontFamily: 'var(--font)',
        cursor: 'pointer',
        transition: 'all var(--transition)',
      },
      buttonSecondary: {
        background: 'var(--bg-tertiary)',
        color: 'var(--text-primary)',
      },
      buttonDisabled: {
        opacity: 0.4,
        cursor: 'not-allowed',
      },
      buttonSmall: {
        padding: '8px 14px',
        fontSize: '14px',
        width: 'auto',
        display: 'inline-flex',
        borderRadius: '8px',
      },
      resultBox: {
        padding: '12px',
        background: 'var(--bg-tertiary)',
        borderRadius: 'var(--radius-sm)',
        marginBottom: '10px',
      },
      resultLabel: {
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '0.5px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '2px',
      },
      resultValue: {
        fontSize: '18px',
        fontWeight: '600',
        color: 'var(--text-primary)',
      },
      statusBadge: (type) => ({
        display: 'inline-flex',
        alignItems: 'center',
        padding: '5px 10px',
        borderRadius: '6px',
        fontSize: '13px',
        fontWeight: '600',
        background: type === 'error' ? 'var(--error-light)' :
                   type === 'warning' ? 'var(--warning-light)' :
                   type === 'success' ? 'var(--success-light)' :
                   'var(--accent-light)',
        color: type === 'error' ? 'var(--error)' :
               type === 'warning' ? 'var(--warning)' :
               type === 'success' ? 'var(--success)' :
               'var(--accent)',
      }),
      divider: {
        height: '1px',
        background: 'var(--border-strong)',
        margin: '12px 0',
      },
      grid: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '8px',
      },
      backButton: {
        display: 'inline-flex',
        alignItems: 'center',
        gap: '2px',
        background: 'none',
        border: 'none',
        color: 'var(--accent)',
        fontSize: '15px',
        fontWeight: '400',
        cursor: 'pointer',
        padding: '0',
        marginBottom: '12px',
        fontFamily: 'var(--font)',
      },
      expandHeader: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        cursor: 'pointer',
        padding: '10px 0',
      },
      chevron: (expanded) => ({
        width: '18px',
        height: '18px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--text-tertiary)',
        transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)',
        transition: 'transform var(--transition)',
      }),
      workingContent: {
        fontSize: '12px',
        color: 'var(--text-secondary)',
        lineHeight: '1.5',
        paddingTop: '10px',
        borderTop: '1px solid var(--border)',
      },
      formula: {
        fontFamily: 'ui-monospace, SF Mono, Monaco, monospace',
        fontSize: '11px',
        background: 'var(--accent-light)',
        padding: '2px 6px',
        borderRadius: '4px',
        color: 'var(--accent)',
      },
      valueRow: {
        display: 'flex',
        justifyContent: 'space-between',
        padding: '5px 0',
        borderBottom: '1px solid var(--border)',
        fontSize: '13px',
      },
      optionCard: {
        padding: '14px',
        background: 'var(--bg-tertiary)',
        borderRadius: 'var(--radius-sm)',
        cursor: 'pointer',
        transition: 'all var(--transition)',
        marginBottom: '8px',
      },
      optionCardSelected: {
        background: 'var(--accent-light)',
        boxShadow: 'inset 0 0 0 2px var(--accent)',
      },
      optionTitle: {
        fontSize: '15px',
        fontWeight: '600',
        marginBottom: '2px',
      },
      optionDesc: {
        fontSize: '12px',
        color: 'var(--text-secondary)',
        lineHeight: '1.3',
      },
      infoBox: {
        padding: '10px 12px',
        background: 'var(--accent-light)',
        borderRadius: '8px',
        fontSize: '12px',
        color: 'var(--text-secondary)',
        lineHeight: '1.4',
        marginTop: '10px',
      },
      warningBox: {
        padding: '10px 12px',
        background: 'var(--warning-light)',
        borderRadius: '8px',
        fontSize: '12px',
        color: 'var(--text-primary)',
        lineHeight: '1.4',
        marginTop: '10px',
      },
      summaryRow: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '8px 0',
        borderBottom: '1px solid var(--border)',
      },
    };

    // ============================================
    // COMPONENTS
    // ============================================

    const ChevronIcon = () => (
      <svg width="10" height="6" viewBox="0 0 10 6" fill="none">
        <path d="M1 1L5 5L9 1" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );

    const BackIcon = () => (
      <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
        <path d="M7 1L1 7L7 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );

    // Progress bar component - accepts either percent or current/total
    const ProgressBar = ({ percent, current, total }) => {
      const width = percent !== undefined ? percent : (current / total) * 100;
      return (
        <div style={{ 
          position: 'fixed', 
          top: 0, 
          left: 0, 
          right: 0, 
          height: '8px', 
          background: 'var(--bg-tertiary)', 
          zIndex: 100,
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        }}>
          <div style={{ 
            height: '100%', 
            width: `${width}%`, 
            background: 'linear-gradient(90deg, var(--accent), #34C759)', 
            transition: 'width 0.3s ease',
            borderRadius: '0 4px 4px 0',
            boxShadow: '0 0 8px rgba(0, 122, 255, 0.4)'
          }} />
        </div>
      );
    };

    const Input = ({ label, unit, value, onChange, placeholder, isDefault, defaultValue, autoFocus, warning, expectedLength, onComplete, inputRef }) => {
      const [focused, setFocused] = useState(false);
      const [touched, setTouched] = useState(false);
      const strValue = value ? String(value) : '';
      const looksComplete = strValue && (strValue.length >= 2 || parseFloat(strValue) >= 10);
      const hasWarning = warning && touched && looksComplete;
      const ref = useRef(null);
      
      const handleChange = (e) => {
        const newValue = e.target.value;
        onChange(newValue);
        if (expectedLength && onComplete && newValue.length >= expectedLength) {
          setTimeout(() => onComplete(), 50);
        }
      };
      
      const handleBlur = () => {
        setFocused(false);
        setTouched(true);
      };
      
      React.useImperativeHandle(inputRef, () => ({
        focus: () => ref.current?.focus()
      }));
      
      return (
        <div style={{ marginBottom: '8px' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <span style={{ fontSize: '13px', fontWeight: '500', color: 'var(--text-primary)', minWidth: '50px' }}>
              {label}
            </span>
            <input
              ref={ref}
              type="text"
              inputMode="decimal"
              autoFocus={autoFocus}
              style={{
                flex: 1,
                padding: '10px 12px',
                border: '1.5px solid',
                borderColor: hasWarning ? 'var(--warning)' : focused ? 'var(--accent)' : 'var(--border-strong)',
                borderRadius: '10px',
                fontSize: '17px',
                fontWeight: '500',
                fontFamily: 'var(--font)',
                color: 'var(--text-primary)',
                background: 'var(--bg-secondary)',
                outline: 'none',
                boxShadow: focused ? '0 0 0 3px var(--accent-light)' : 'none',
                transition: 'all 0.15s ease',
              }}
              value={strValue}
              onChange={handleChange}
              onFocus={() => setFocused(true)}
              onBlur={handleBlur}
              placeholder={isDefault ? defaultValue : placeholder}
            />
            {unit && <span style={{ fontSize: '11px', color: 'var(--text-tertiary)', minWidth: '45px' }}>{unit}</span>}
          </div>
          {hasWarning && (
            <div style={{ fontSize: '11px', color: 'var(--warning)', marginTop: '3px', marginLeft: '58px' }}>‚ö†Ô∏è {warning}</div>
          )}
        </div>
      );
    };

    const ExpandableWorking = ({ children, label = "Show working" }) => {
      const [expanded, setExpanded] = useState(false);
      
      return (
        <div>
          <div style={styles.expandHeader} onClick={() => setExpanded(!expanded)}>
            <span style={{ fontSize: '12px', color: 'var(--text-tertiary)', fontWeight: '500' }}>
              {expanded ? 'Hide' : label}
            </span>
            <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s', display: 'inline-block' }}>‚ñº</span>
          </div>
          {expanded && <div style={styles.workingContent}>{children}</div>}
        </div>
      );
    };

    // Bottom Sheet Component - slides up from bottom
    const BottomSheet = ({ isOpen, onClose, title, children }) => {
      const [dragY, setDragY] = useState(0);
      const [isDragging, setIsDragging] = useState(false);
      const startY = useRef(0);
      
      const handleTouchStart = (e) => {
        startY.current = e.touches[0].clientY;
        setIsDragging(true);
      };
      
      const handleTouchMove = (e) => {
        if (!isDragging) return;
        const deltaY = e.touches[0].clientY - startY.current;
        if (deltaY > 0) setDragY(deltaY);
      };
      
      const handleTouchEnd = () => {
        setIsDragging(false);
        if (dragY > 100) {
          onClose();
        }
        setDragY(0);
      };
      
      if (!isOpen) return null;
      
      return (
        <div style={{
          position: 'fixed',
          top: 0, left: 0, right: 0, bottom: 0,
          zIndex: 1000,
        }}>
          {/* Backdrop */}
          <div 
            style={{
              position: 'absolute',
              top: 0, left: 0, right: 0, bottom: 0,
              background: 'rgba(0,0,0,0.4)',
              transition: 'opacity 0.3s ease',
            }}
            onClick={onClose}
          />
          
          {/* Sheet */}
          <div 
            style={{
              position: 'absolute',
              bottom: 0, left: 0, right: 0,
              background: 'var(--bg-primary)',
              borderRadius: '20px 20px 0 0',
              maxHeight: '85vh',
              transform: `translateY(${dragY}px)`,
              transition: isDragging ? 'none' : 'transform 0.3s ease',
              boxShadow: '0 -4px 20px rgba(0,0,0,0.15)',
            }}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
          >
            {/* Handle */}
            <div style={{ 
              display: 'flex', 
              justifyContent: 'center', 
              padding: '12px',
              cursor: 'grab',
            }}>
              <div style={{
                width: '36px',
                height: '4px',
                background: 'var(--border)',
                borderRadius: '2px',
              }} />
            </div>
            
            {/* Header */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '0 20px 16px',
              borderBottom: '1px solid var(--border)',
            }}>
              <h2 style={{ 
                fontSize: '18px', 
                fontWeight: '600',
                margin: 0,
              }}>{title}</h2>
              <button 
                onClick={onClose}
                style={{
                  background: 'var(--bg-tertiary)',
                  border: 'none',
                  borderRadius: '50%',
                  width: '28px',
                  height: '28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  cursor: 'pointer',
                  fontSize: '16px',
                  color: 'var(--text-secondary)',
                }}
              >√ó</button>
            </div>
            
            {/* Content */}
            <div style={{
              padding: '16px 20px 32px',
              overflowY: 'auto',
              maxHeight: 'calc(85vh - 100px)',
              WebkitOverflowScrolling: 'touch',
            }}>
              {children}
            </div>
          </div>
        </div>
      );
    };

    // Info button that opens a bottom sheet
    const InfoButton = ({ onClick, label }) => (
      <button
        onClick={onClick}
        style={{
          display: 'inline-flex',
          alignItems: 'center',
          gap: '4px',
          padding: '4px 10px',
          background: 'var(--bg-tertiary)',
          border: 'none',
          borderRadius: '12px',
          fontSize: '12px',
          color: 'var(--accent)',
          cursor: 'pointer',
          fontFamily: 'var(--font)',
          fontWeight: '500',
        }}
      >
        {label || '‚ìò Details'}
      </button>
    );

    const Formula = ({ children }) => <code style={styles.formula}>{children}</code>;
    const Divider = () => <div style={styles.divider} />;

    const ValueRow = ({ label, value, isDefault, highlight }) => (
      <div style={{
        ...styles.valueRow,
        background: highlight ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
        margin: highlight ? '0 -8px' : '0',
        padding: highlight ? '6px 8px' : '6px 0',
        borderRadius: highlight ? '4px' : '0',
      }}>
        <span>{label}</span>
        <span style={{ fontWeight: '500', color: 'var(--text-primary)' }}>
          {value}
          {isDefault && <span style={{ ...styles.defaultBadge, marginLeft: '6px' }}>default</span>}
        </span>
      </div>
    );

    // ============================================
    // SCREENS
    // ============================================

    // Landing Screen
    const LandingScreen = ({ onSelect }) => (
      <div style={styles.container}>
        <div style={styles.header} className="animate-in">
          <h1 style={styles.title}>Acid Base Pro</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Acid-Base Analysis</div>
          
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('traditional')}
          >
            <div style={styles.optionTitle}>Traditional</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>Henderson-Hasselbalch</div>
          </div>

          <div 
            style={styles.optionCard}
            onClick={() => onSelect('stewart')}
          >
            <div style={styles.optionTitle}>Physicochemical</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>Stewart approach</div>
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>Oxygenation</div>
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('oxygenation')}
          >
            <div style={styles.optionTitle}>Assess Oxygenation</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>P/F ratio, A-a gradient</div>
          </div>
        </div>

        <div style={{ ...styles.card, background: 'linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary))', border: '1px dashed var(--border)' }} className="animate-in stagger-2">
          <div style={{ ...styles.cardTitle, color: 'var(--accent)' }}>üß™ ABGlabs</div>
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('beta')}
          >
            <div style={styles.optionTitle}>Beta Testing</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>New features in development</div>
          </div>
        </div>

        <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', lineHeight: '1.5', textAlign: 'center', padding: '16px 8px' }} className="animate-in stagger-2">
          <p style={{ marginBottom: '8px' }}>
            Educational aid only. Not medical advice. Results must be interpreted in clinical context. Authors accept no responsibility for clinical decisions.
          </p>
          <p style={{ fontSize: '13px', fontWeight: '500' }}>¬© 2025 Scott Santinon</p>
        </div>
      </div>
    );

    // Beta Testing Screen
    const BetaScreen = ({ onSelect, onBack }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={{ ...styles.stepIndicator, background: 'var(--accent-light)', color: 'var(--accent)' }}>üß™ Beta</div>
          <h1 style={styles.title}>ABGlabs</h1>
          <p style={styles.subtitle}>Features in development</p>
        </div>

        <div style={{ padding: '12px', background: 'var(--warning-light)', borderRadius: '10px', marginBottom: '16px', fontSize: '12px', color: 'var(--text-secondary)', lineHeight: '1.5' }} className="animate-in stagger-1">
          These features are under active development and may change. Feedback welcome!
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Hyperglycaemic Crisis</div>
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('dkahhs')}
          >
            <div style={styles.optionTitle}>DKA/HHS Monitor</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>Classification, trends, fluid deficit</div>
          </div>
        </div>

        <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', lineHeight: '1.5', textAlign: 'center', padding: '16px 8px' }} className="animate-in stagger-2">
          <p style={{ fontSize: '13px', fontWeight: '500' }}>¬© 2025 Scott Santinon</p>
        </div>
      </div>
    );

    // Step 1: All Values (Traditional)
    const Step1_AllValues = ({ data, setData, onNext, onBack, approach }) => {
      const needsStewart = approach === 'stewart';
      const canProceed = data.pH && data.paCO2 && data.hco3 && data.na && data.cl;
      
      // Input validation - returns warning message or null
      const checkRange = (value, min, max, unit) => {
        if (!value) return null;
        const v = parseFloat(value);
        if (v < min || v > max) return `Outside typical range (${min}‚Äì${max} ${unit})`;
        return null;
      };
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 1</div>
            <h1 style={styles.title}>Enter Values</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', marginBottom: '8px' }}>
              <div>
                <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>pH</div>
                <input
                  type="text"
                  inputMode="decimal"
                  autoFocus
                  value={data.pH || ''}
                  onChange={e => setData({...data, pH: e.target.value})}
                  placeholder="7.40"
                  style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                />
              </div>
              <div>
                <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>pCO‚ÇÇ <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', fontWeight: '400' }}>mmHg</span></div>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.paCO2 || ''}
                  onChange={e => setData({...data, paCO2: e.target.value})}
                  placeholder="40"
                  style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                />
              </div>
              <div>
                <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>HCO‚ÇÉ‚Åª <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', fontWeight: '400' }}>mmol/L</span></div>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.hco3 || ''}
                  onChange={e => setData({...data, hco3: e.target.value})}
                  placeholder="24"
                  style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                />
              </div>
            </div>
            
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}>
              <div>
                <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>Na‚Å∫ <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', fontWeight: '400' }}>mmol/L</span></div>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.na || ''}
                  onChange={e => setData({...data, na: e.target.value})}
                  placeholder="140"
                  style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                />
              </div>
              <div>
                <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>Cl‚Åª <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', fontWeight: '400' }}>mmol/L</span></div>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.cl || ''}
                  onChange={e => setData({...data, cl: e.target.value})}
                  placeholder="100"
                  style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                />
              </div>
              <div>
                <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>Albumin <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', fontWeight: '400' }}>g/L</span></div>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.albumin || ''}
                  onChange={e => setData({...data, albumin: e.target.value})}
                  placeholder="40"
                  style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                />
              </div>
            </div>
            
            {needsStewart && (
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '8px', marginTop: '8px' }}>
                <div>
                  <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>K‚Å∫</div>
                  <input
                    type="text"
                    inputMode="decimal"
                    value={data.k || ''}
                    onChange={e => setData({...data, k: e.target.value})}
                    placeholder="4.0"
                    style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                  />
                </div>
                <div>
                  <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>Lactate</div>
                  <input
                    type="text"
                    inputMode="decimal"
                    value={data.lactate || ''}
                    onChange={e => setData({...data, lactate: e.target.value})}
                    placeholder="1.0"
                    style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                  />
                </div>
                <div>
                  <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>Ca¬≤‚Å∫</div>
                  <input
                    type="text"
                    inputMode="decimal"
                    value={data.ca || ''}
                    onChange={e => setData({...data, ca: e.target.value})}
                    placeholder="1.15"
                    style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                  />
                </div>
                <div>
                  <div style={{ fontSize: '12px', fontWeight: '500', marginBottom: '4px' }}>PO‚ÇÑ</div>
                  <input
                    type="text"
                    inputMode="decimal"
                    value={data.phosphate || ''}
                    onChange={e => setData({...data, phosphate: e.target.value})}
                    placeholder="1.1"
                    style={{ width: '100%', padding: '10px', border: '1.5px solid var(--border-strong)', borderRadius: '8px', fontSize: '16px', fontWeight: '500', fontFamily: 'var(--font)', background: 'var(--bg-secondary)', outline: 'none' }}
                  />
                </div>
              </div>
            )}
          </div>

          <button
            className="animate-in stagger-2"
            style={{
              ...styles.button,
              ...(canProceed ? {} : styles.buttonDisabled),
            }}
            onClick={() => {
              if (!canProceed) {
                alert(`Required: ${[!data.pH && 'pH', !data.paCO2 && 'pCO‚ÇÇ', !data.hco3 && 'HCO‚ÇÉ', !data.na && 'Na', !data.cl && 'Cl'].filter(Boolean).join(', ')}`);
                return;
              }
              onNext();
            }}
          >
            Analyse
          </button>
        </div>
      );
    };

    // Step 2: Full Analysis Results (Traditional)
    const Step2_FullAnalysis = ({ data, setData, onNext, onBack }) => {
      const pH = parseFloat(data.pH);
      const paCO2 = parseFloat(data.paCO2);
      const hco3 = parseFloat(data.hco3);
      const na = parseFloat(data.na);
      const cl = parseFloat(data.cl);
      const albumin = data.albumin ? parseFloat(data.albumin) : DEFAULTS.albumin;
      
      const [timing, setTiming] = useState(data.timing || null); // null = not yet selected
      
      // pH Status
      const pHStatus = pH < 7.35 ? 'acidaemia' : pH > 7.45 ? 'alkalaemia' : 'normal';
      const statusType = pHStatus === 'acidaemia' ? 'error' : pHStatus === 'alkalaemia' ? 'warning' : 'success';
      
      // Primary disorder
      let primaryDisorder = '';
      let isMetabolic = false;
      let isRespiratory = false;
      
      // Check for abnormal values
      const lowHCO3 = hco3 < 22;
      const highHCO3 = hco3 > 26;
      const lowPaCO2 = paCO2 < 35;
      const highPaCO2 = paCO2 > 45;
      
      if (pHStatus === 'acidaemia') {
        if (highPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory acidosis';
          isRespiratory = true;
        } else if (lowHCO3 && !highPaCO2) {
          primaryDisorder = 'Metabolic acidosis';
          isMetabolic = true;
        } else if (lowHCO3 && highPaCO2) {
          primaryDisorder = 'Metabolic + respiratory acidosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Acidaemia (indeterminate)';
          isMetabolic = true;
        }
      } else if (pHStatus === 'alkalaemia') {
        if (lowPaCO2 && !highHCO3) {
          primaryDisorder = 'Respiratory alkalosis';
          isRespiratory = true;
        } else if (highHCO3 && !lowPaCO2) {
          primaryDisorder = 'Metabolic alkalosis';
          isMetabolic = true;
        } else if (highHCO3 && lowPaCO2) {
          primaryDisorder = 'Metabolic + respiratory alkalosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Alkalaemia (indeterminate)';
          isMetabolic = true;
        }
      } else {
        // Normal pH (7.35-7.45) - determine primary based on which way pH leans
        // pH > 7.40 leans alkalotic; pH <= 7.40 leans acidotic
        const pHLeansAlkalotic = pH > 7.40;
        const pHLeansAcidotic = pH <= 7.40;
        
        if (lowHCO3 && lowPaCO2) {
          // Both low: low HCO3 pushes acidotic, low CO2 pushes alkalotic
          // Whichever matches pH direction is likely primary
          if (pHLeansAlkalotic) {
            // pH alkalotic-leaning ‚Üí low CO2 (resp alk) is primary, low HCO3 is compensation
            primaryDisorder = 'Compensated respiratory alkalosis';
            isRespiratory = true;
            isMetabolic = true; // Mark both so we explore metabolic too
          } else {
            // pH acidotic-leaning ‚Üí low HCO3 (met acid) is primary, low CO2 is compensation
            primaryDisorder = 'Compensated metabolic acidosis';
            isMetabolic = true;
            isRespiratory = true; // Mark both so we explore respiratory too
          }
        } else if (highHCO3 && highPaCO2) {
          // Both high: high HCO3 pushes alkalotic, high CO2 pushes acidotic
          if (pHLeansAlkalotic) {
            // pH alkalotic-leaning ‚Üí high HCO3 (met alk) is primary
            primaryDisorder = 'Compensated metabolic alkalosis';
            isMetabolic = true;
            isRespiratory = true;
          } else {
            // pH acidotic-leaning ‚Üí high CO2 (resp acid) is primary
            primaryDisorder = 'Compensated respiratory acidosis';
            isRespiratory = true;
            isMetabolic = true;
          }
        } else if (highPaCO2 && !highHCO3) {
          // High CO2 with normal-ish HCO3 and normal pH
          primaryDisorder = 'Respiratory acidosis (compensating)';
          isRespiratory = true;
        } else if (lowPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory alkalosis (compensating)';
          isRespiratory = true;
        } else if (lowHCO3 || highHCO3 || lowPaCO2 || highPaCO2) {
          // Some abnormality exists
          primaryDisorder = 'Mixed disorder (normal pH)';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          // All values normal - still calculate AG
          primaryDisorder = 'Check anion gap';
          isMetabolic = true;
        }
      }

      const isAcidosis = pHStatus === 'acidaemia' || primaryDisorder.toLowerCase().includes('acidosis');
      const isAlkalosis = pHStatus === 'alkalaemia' || primaryDisorder.toLowerCase().includes('alkalosis');

      // Compensation (only for pure disorders, not mixed)
      let expectedPaCO2 = null;
      let expectedHCO3 = null;
      let compensationResult = '';
      let compensationNote = '';

      const isMixed = isMetabolic && isRespiratory;

      if (isMixed) {
        compensationResult = 'Mixed disorder ‚Äî classic single-disorder compensation rules do not apply';
      } else if (isMetabolic && isAcidosis) {
        expectedPaCO2 = (1.5 * hco3) + 8;
        // Physiological floor: PaCO2 cannot go below ~10 mmHg
        if (expectedPaCO2 < 10) {
          compensationNote = 'Maximal respiratory compensation reached (PaCO‚ÇÉ floor ~10 mmHg)';
          expectedPaCO2 = 10;
        }
      } else if (isMetabolic && isAlkalosis) {
        expectedPaCO2 = (0.7 * hco3) + 20;
        // Physiological ceiling: PaCO2 rarely exceeds ~55-60 for compensation
        if (expectedPaCO2 > 55) {
          compensationNote = 'Expected PaCO‚ÇÇ exceeds usual compensatory limit (~55 mmHg)';
        }
      } else if (isRespiratory && timing) {
        // Only calculate if timing has been selected
        const deltaCO2 = Math.abs(paCO2 - 40) / 10;
        if (isAcidosis) {
          const change = timing === 'acute' ? 1 : 4;
          expectedHCO3 = 24 + (deltaCO2 * change);
          // Physiological ceiling: HCO3 rarely exceeds 45 mmol/L
          if (expectedHCO3 > 45) {
            compensationNote = 'Beyond usual physiological compensation (HCO‚ÇÉ ceiling ~45 mmol/L)';
            expectedHCO3 = 45;
          }
        } else {
          const change = timing === 'acute' ? 2 : 5;
          expectedHCO3 = 24 - (deltaCO2 * change);
          // Physiological floor: HCO3 rarely goes below 12-15 for compensation
          if (expectedHCO3 < 12) {
            compensationNote = 'Beyond usual physiological compensation (HCO‚ÇÉ floor ~12 mmol/L)';
            expectedHCO3 = 12;
          }
        }
      }

      if (!isMixed) {
        if (expectedPaCO2 !== null) {
          const diff = paCO2 - expectedPaCO2;
          if (Math.abs(diff) <= 3) compensationResult = 'Appropriate compensation';
          else if (diff > 3) compensationResult = 'Additional respiratory acidosis';
          else compensationResult = 'Additional respiratory alkalosis';
        } else if (expectedHCO3 !== null) {
          const diff = hco3 - expectedHCO3;
          if (Math.abs(diff) <= 3) compensationResult = 'Appropriate compensation';
          else if (diff > 3) compensationResult = 'Additional metabolic alkalosis';
          else compensationResult = 'Additional metabolic acidosis';
        }
      }

      const compensationType = compensationResult.includes('Appropriate') ? 'success' : 
                               compensationResult.includes('Mixed') ? 'neutral' : 'warning';

      // Anion Gap (only for metabolic acidosis)
      const rawAG = na - hco3 - cl;
      const correction = 0.25 * (40 - albumin);
      const correctedAG = rawAG + correction;
      const isHAGMA = correctedAG > 12;

      // Delta Ratio (for any HAGMA - helps identify mixed disorders)
      let deltaAG = null;
      let deltaHCO3 = null;
      let deltaRatio = null;
      let deltaInterpretation = '';
      
      if (isHAGMA) {
        deltaAG = correctedAG - 12;
        deltaHCO3 = 24 - hco3;
        
        // Only calculate ratio if HCO3 is actually low (meaningful denominator)
        if (deltaHCO3 > 1) {
          deltaRatio = deltaAG / deltaHCO3;
          
          if (deltaRatio < 0.4) deltaInterpretation = 'Concurrent NAGMA';
          else if (deltaRatio < 0.8) deltaInterpretation = 'Mixed HAGMA + NAGMA';
          else if (deltaRatio <= 2) deltaInterpretation = 'No additional disorder';
          else deltaInterpretation = 'Concurrent metabolic alkalosis';
        } else if (deltaHCO3 <= 1 && deltaHCO3 >= -2) {
          // HCO3 is near normal despite HAGMA
          deltaInterpretation = 'Concurrent metabolic alkalosis (HCO‚ÇÉ maintained)';
        } else {
          // HCO3 is elevated (frank metabolic alkalosis)
          deltaInterpretation = 'Concurrent metabolic alkalosis';
        }
      }

      const handleNext = () => {
        const updatedData = {
          ...data,
          pHStatus,
          primaryDisorder,
          isMetabolic,
          isRespiratory,
          isAcidosis,
          isAlkalosis,
          timing,
          expectedPaCO2,
          expectedHCO3,
          compensationResult,
          rawAG,
          correctedAG,
          isHAGMA,
          usedAlbumin: albumin,
          deltaAG,
          deltaHCO3,
          deltaRatio,
          deltaInterpretation,
        };
        setData(updatedData);
        onNext();
      };

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 2</div>
            <h1 style={styles.title}>Analysis</h1>
          </div>

          {/* Integrated Analysis Card */}
          <div style={styles.card} className="animate-in stagger-1">
            {/* Primary Disorder Row */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <div>
                <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', fontWeight: '600', letterSpacing: '0.5px' }}>PRIMARY DISORDER</div>
                <div style={{ fontSize: '17px', fontWeight: '600', marginTop: '2px' }}>{primaryDisorder}</div>
              </div>
              <span style={styles.statusBadge(statusType)}>
                pH {pH.toFixed(2)}
              </span>
            </div>

            {/* Compensation Row */}
            {compensationResult && !isMixed && (
              <div style={{ padding: '10px 0', borderTop: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Compensation</span>
                  <span style={{
                    fontSize: '12px', fontWeight: '500', padding: '3px 8px', borderRadius: '10px',
                    background: compensationType === 'success' ? 'var(--success-light)' : compensationType === 'warning' ? 'var(--warning-light)' : 'var(--bg-tertiary)',
                    color: compensationType === 'success' ? 'var(--success)' : compensationType === 'warning' ? 'var(--warning)' : 'var(--text-secondary)',
                  }}>{compensationResult}</span>
                </div>
                {compensationNote && (
                  <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '4px' }}>
                    {compensationNote}
                  </div>
                )}
              </div>
            )}
            {isMixed && (
              <div style={{ padding: '10px 0', borderTop: '1px solid var(--border)' }}>
                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                  Mixed disorder ‚Äî single-disorder compensation rules do not apply
                </div>
              </div>
            )}

            {/* Anion Gap Row - show for metabolic acidosis OR whenever elevated */}
            {((isMetabolic && isAcidosis) || isHAGMA) && (
              <div style={{ padding: '10px 0', borderTop: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                    <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Anion Gap</span>
                    <span style={{ fontSize: '15px', fontWeight: '600' }}>{correctedAG.toFixed(1)}</span>
                  </div>
                  <span style={{
                    fontSize: '11px', fontWeight: '500', padding: '3px 8px', borderRadius: '10px',
                    background: isHAGMA ? 'var(--error-light)' : 'var(--success-light)',
                    color: isHAGMA ? 'var(--error)' : 'var(--success)',
                  }}>
                    {isHAGMA ? '‚Üë Elevated' : 'Normal'}
                  </span>
                </div>
                {isHAGMA && !isAcidosis && (
                  <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '4px' }}>
                    ‚ÜëAG despite {pHStatus === 'normal' ? 'normal pH' : 'alkalemia'} ‚Äî mixed or compensated
                  </div>
                )}
              </div>
            )}

            {/* Delta Ratio Row - for HAGMA */}
            {isHAGMA && deltaInterpretation && (
              <div style={{ padding: '10px 0', borderTop: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                    <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Delta Ratio</span>
                    <span style={{ fontSize: '15px', fontWeight: '600' }}>{deltaRatio !== null ? deltaRatio.toFixed(2) : '‚Äî'}</span>
                  </div>
                  <span style={{
                    fontSize: '11px', fontWeight: '500', padding: '3px 8px', borderRadius: '10px',
                    background: deltaInterpretation === 'No additional disorder' ? 'var(--success-light)' : 'var(--warning-light)',
                    color: deltaInterpretation === 'No additional disorder' ? 'var(--success)' : 'var(--warning)',
                  }}>
                    {deltaInterpretation}
                  </span>
                </div>
              </div>
            )}

            {/* Respiratory timing toggle - only for pure respiratory disorders */}
            {isRespiratory && !isMixed && (
              <div style={{ paddingTop: '12px', borderTop: '1px solid var(--border)', marginTop: '2px' }}>
                <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                  How long has this respiratory problem been present?
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    style={{
                      flex: 1, padding: '10px', border: timing === 'acute' ? '2px solid var(--accent)' : '1px solid var(--border)',
                      borderRadius: '8px', background: timing === 'acute' ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                      cursor: 'pointer', fontFamily: 'var(--font)', textAlign: 'center'
                    }}
                    onClick={() => setTiming('acute')}
                  >
                    <div style={{ fontSize: '13px', fontWeight: '600', color: timing === 'acute' ? 'var(--accent)' : 'var(--text-primary)' }}>Acute</div>
                    <div style={{ fontSize: '10px', color: 'var(--text-tertiary)', marginTop: '2px' }}>hours‚Äìdays</div>
                  </button>
                  <button
                    style={{
                      flex: 1, padding: '10px', border: timing === 'chronic' ? '2px solid var(--accent)' : '1px solid var(--border)',
                      borderRadius: '8px', background: timing === 'chronic' ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                      cursor: 'pointer', fontFamily: 'var(--font)', textAlign: 'center'
                    }}
                    onClick={() => setTiming('chronic')}
                  >
                    <div style={{ fontSize: '13px', fontWeight: '600', color: timing === 'chronic' ? 'var(--accent)' : 'var(--text-primary)' }}>Chronic</div>
                    <div style={{ fontSize: '10px', color: 'var(--text-tertiary)', marginTop: '2px' }}>days‚Äìweeks</div>
                  </button>
                </div>
              </div>
            )}

            {/* Show Working - expandable at bottom */}
            <ExpandableWorking>
              {/* Compensation formula */}
              {expectedPaCO2 !== null && isMetabolic && isAcidosis && (
                <>
                  <p><strong>Winter's formula:</strong></p>
                  <p>Expected PaCO‚ÇÇ = (1.5 √ó {hco3}) + 8 = {expectedPaCO2.toFixed(0)} ¬± 2 mmHg</p>
                  <p>Actual = {paCO2} mmHg (diff: {Math.abs(paCO2 - expectedPaCO2).toFixed(0)})</p>
                </>
              )}
              {expectedPaCO2 !== null && isMetabolic && isAlkalosis && (
                <>
                  <p><strong>Met alkalosis compensation:</strong></p>
                  <p>Expected PaCO‚ÇÇ = (0.7 √ó {hco3}) + 20 = {expectedPaCO2.toFixed(0)} ¬± 5 mmHg</p>
                  <p>Actual = {paCO2} mmHg (diff: {Math.abs(paCO2 - expectedPaCO2).toFixed(0)})</p>
                </>
              )}
              {expectedHCO3 !== null && isRespiratory && timing && (
                <>
                  <p><strong>Resp {isAcidosis ? 'acidosis' : 'alkalosis'} ({timing}):</strong></p>
                  <p>Expected HCO‚ÇÉ = 24 {isAcidosis ? '+' : '‚àí'} ({timing === 'acute' ? (isAcidosis ? '1' : '2') : (isAcidosis ? '4' : '5')} √ó ŒîCO‚ÇÇ/10) = {expectedHCO3.toFixed(0)} mmol/L</p>
                  <p>Actual = {hco3} mmol/L</p>
                </>
              )}
              {/* AG calculation */}
              {((isMetabolic && isAcidosis) || isHAGMA) && (
                <>
                  <Divider />
                  <p><strong>Anion Gap:</strong></p>
                  <p>Raw AG = {na} ‚àí {cl} ‚àí {hco3} = {rawAG.toFixed(1)}</p>
                  <p>Albumin correction = +{correction.toFixed(1)}</p>
                  <p>Corrected AG = {correctedAG.toFixed(1)}</p>
                </>
              )}
              {/* Delta ratio */}
              {isHAGMA && deltaRatio !== null && (
                <>
                  <Divider />
                  <p><strong>Delta Ratio:</strong></p>
                  <p>ŒîAG/ŒîHCO‚ÇÉ = {deltaAG.toFixed(1)}/{deltaHCO3.toFixed(1)} = {deltaRatio.toFixed(2)}</p>
                  <p style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>{"<"}0.4 NAGMA | 0.4-0.8 mixed | 0.8-2 pure | {">"}2 met alk</p>
                </>
              )}
            </ExpandableWorking>
          </div>

          <button className="animate-in stagger-2" style={styles.button} onClick={handleNext}>
            Next ‚Üí
          </button>
        </div>
      );
    };

    // Step 2: Stewart/Physicochemical Analysis - COMPACT VERSION
    const Step2_StewartAnalysis = ({ data, setData, onNext, onBack, onRestart }) => {
      const [showSheet, setShowSheet] = useState(null); // 'sid', 'sig', 'atot', 'components'
      const [copied, setCopied] = useState(false);
      
      const pH = parseFloat(data.pH);
      const paCO2 = parseFloat(data.paCO2);
      const hco3 = parseFloat(data.hco3);
      const na = parseFloat(data.na);
      const cl = parseFloat(data.cl);
      const k = data.k ? parseFloat(data.k) : DEFAULTS.k;
      const ca = data.ca ? parseFloat(data.ca) : 1.15; // ionised calcium mmol/L
      const mg = data.mg ? parseFloat(data.mg) : 0.5; // ionised magnesium mmol/L
      const lactate = data.lactate ? parseFloat(data.lactate) : 1.0;
      const albumin = data.albumin ? parseFloat(data.albumin) : DEFAULTS.albumin;
      const phosphate = data.phosphate ? parseFloat(data.phosphate) : 1.1;
      
      // pH Status (for display only)
      const pHStatus = pH < 7.35 ? 'acidaemia' : pH > 7.45 ? 'alkalaemia' : 'normal';
      const statusType = pHStatus === 'acidaemia' ? 'error' : pHStatus === 'alkalaemia' ? 'warning' : 'success';

      // ========== THE THREE INDEPENDENT VARIABLES ==========
      
      // 1. SIDa (apparent Strong Ion Difference)
      // Full formula including divalent cations (√ó2 for charge)
      const SIDa = na + k + (2 * ca) + (2 * mg) - cl - lactate;
      const sidNormal = 40; // Reference point
      const sidStatus = SIDa < 38 ? 'low' : SIDa > 42 ? 'high' : 'normal';
      
      // 2. ATOT (total weak acid buffer concentration)
      // Figge-Fencl: pH-dependent charge on albumin and phosphate
      const albuminCharge = albumin * (0.123 * pH - 0.631);
      const phosphateCharge = phosphate * (0.309 * pH - 0.469);
      const ATOT = albuminCharge + phosphateCharge;
      const atotNormal = 17; // Approximate normal at pH 7.4, albumin 40, phos 1.1
      const atotStatus = ATOT < 12 ? 'low' : ATOT > 20 ? 'high' : 'normal';
      
      // 3. pCO‚ÇÇ (respiratory component) - already have this
      const pCO2Status = paCO2 < 35 ? 'low' : paCO2 > 45 ? 'high' : 'normal';
      
      // ========== DERIVED VALUES ==========
      
      // SIDe (effective SID) = HCO‚ÇÉ + ATOT
      const SIDe = hco3 + ATOT;
      
      // SIG (Strong Ion Gap) = SIDa - SIDe
      // Detects unmeasured strong anions
      const SIG = SIDa - SIDe;
      const sigElevated = SIG > 5;
      
      // ========== STEWART-BASED INTERPRETATION ==========
      // pH is determined by SID, ATOT, and pCO‚ÇÇ
      // Each abnormality has a specific effect:
      
      const disorders = [];
      
      // Metabolic (SID-related)
      if (sidStatus === 'low') {
        disorders.push({ type: 'acidosis', source: 'Low SID', detail: `SIDa ${SIDa.toFixed(1)} (<38)` });
      }
      if (sidStatus === 'high') {
        disorders.push({ type: 'alkalosis', source: 'High SID', detail: `SIDa ${SIDa.toFixed(1)} (>42)` });
      }
      
      // Unmeasured anions (SIG-related)
      if (sigElevated) {
        disorders.push({ type: 'acidosis', source: 'Unmeasured anions‚Åª', detail: `SIG ${SIG.toFixed(1)} (>5)` });
      }
      
      // Weak acids (ATOT-related)
      if (atotStatus === 'low') {
        disorders.push({ type: 'alkalosis', source: 'Low ATOT', detail: `Hypoalbuminaemia (${albumin} g/L)` });
      }
      if (atotStatus === 'high') {
        disorders.push({ type: 'acidosis', source: 'High ATOT', detail: `Hyperphosphataemia` });
      }
      
      // Respiratory (pCO‚ÇÇ-related)
      if (pCO2Status === 'high') {
        disorders.push({ type: 'acidosis', source: 'Respiratory', detail: `pCO‚ÇÇ ${paCO2} (>45)` });
      }
      if (pCO2Status === 'low') {
        disorders.push({ type: 'alkalosis', source: 'Respiratory', detail: `pCO‚ÇÇ ${paCO2} (<35)` });
      }
      
      const acidosisDisorders = disorders.filter(d => d.type === 'acidosis');
      const alkalosisDisorders = disorders.filter(d => d.type === 'alkalosis');
      
      // ========== COMPONENT BREAKDOWN (what's affecting SID) ==========
      // These show deviation from normal and direction of effect on SID
      
      const sidComponents = [
        { 
          label: 'Na‚Å∫ (water)', 
          value: na, 
          normal: 140, 
          effect: na - 140,  // ‚ÜëNa = ‚ÜëSID = alkalosis
          unit: 'mmol/L',
          interpretation: na > 142 ? 'Water deficit ‚Üí ‚ÜëSID' : na < 138 ? 'Water excess ‚Üí ‚ÜìSID' : 'Normal'
        },
        { 
          label: 'Cl‚Åª', 
          value: cl, 
          normal: 102, 
          effect: -(cl - 102),  // ‚ÜëCl = ‚ÜìSID = acidosis (inverted for display)
          unit: 'mmol/L',
          interpretation: cl > 106 ? 'Hyperchloraemia ‚Üí ‚ÜìSID' : cl < 98 ? 'Hypochloraemia ‚Üí ‚ÜëSID' : 'Normal'
        },
        { 
          label: 'Lactate', 
          value: lactate, 
          normal: 1.0, 
          effect: -(lactate - 1.0),  // ‚ÜëLactate = ‚ÜìSID = acidosis
          unit: 'mmol/L',
          interpretation: lactate > 2 ? 'Lactataemia ‚Üí ‚ÜìSID' : 'Normal'
        },
      ];
      
      const atotComponents = [
        {
          label: 'Albumin',
          value: albumin,
          normal: 40,
          effect: (40 - albumin) * 0.25,  // ‚ÜìAlbumin = ‚ÜìATOT = alkalosis
          unit: 'g/L',
          interpretation: albumin < 30 ? 'Hypoalbuminaemia ‚Üí ‚ÜìATOT ‚Üí alkalosis' : 'Normal'
        },
        {
          label: 'Phosphate',
          value: phosphate,
          normal: 1.1,
          effect: -(phosphate - 1.1) * 0.5,  // ‚ÜëPhos = ‚ÜëATOT = acidosis
          unit: 'mmol/L',
          interpretation: phosphate > 2 ? 'Hyperphosphataemia ‚Üí ‚ÜëATOT ‚Üí acidosis' : 'Normal'
        },
      ];

      const handleNext = () => {
        setData(prev => ({
          ...prev,
          pHStatus, SIDa, SIDe, SIG, ATOT, sidStatus, atotStatus, pCO2Status,
          albuminCharge, phosphateCharge, disorders,
          isHAGMA: sigElevated,
          usedAlbumin: albumin,
        }));
        onNext();
      };

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 2 ‚Äî Stewart</div>
            <h1 style={styles.title}>Analysis</h1>
          </div>

          {/* pH and Interpretation Summary */}
          <div style={{ ...styles.card, background: 'var(--bg-tertiary)' }} className="animate-in stagger-1">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <strong style={{ fontSize: '15px' }}>{pHStatus === 'normal' ? 'Normal pH' : pHStatus.charAt(0).toUpperCase() + pHStatus.slice(1)}</strong>
              <span style={styles.statusBadge(statusType)}>pH {pH.toFixed(2)}</span>
            </div>
            
            {disorders.length === 0 ? (
              <div style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                No significant acid-base disturbance identified
              </div>
            ) : (
              <div style={{ fontSize: '13px' }}>
                {acidosisDisorders.length > 0 && (
                  <div style={{ color: 'var(--error)', marginBottom: alkalosisDisorders.length > 0 ? '6px' : 0 }}>
                    <strong>‚Üì Acidosis:</strong> {acidosisDisorders.map(d => d.source).join(', ')}
                  </div>
                )}
                {alkalosisDisorders.length > 0 && (
                  <div style={{ color: 'var(--warning)' }}>
                    <strong>‚Üë Alkalosis:</strong> {alkalosisDisorders.map(d => d.source).join(', ')}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* The Three Independent Variables */}
          <div style={styles.card} className="animate-in stagger-2">
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)', letterSpacing: '0.5px', marginBottom: '12px' }}>
              THE THREE DETERMINANTS OF pH
            </div>
            
            {/* SID row */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--border)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px', fontWeight: '500' }}>SID</span>
                <InfoButton onClick={() => setShowSheet('sid')} label="‚ìò" />
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '15px', fontWeight: '600' }}>{SIDa.toFixed(1)}</span>
                <span style={{
                  fontSize: '11px', padding: '2px 8px', borderRadius: '4px',
                  background: sidStatus === 'low' ? 'var(--error-light)' : sidStatus === 'high' ? 'var(--warning-light)' : 'var(--success-light)',
                  color: sidStatus === 'low' ? 'var(--error)' : sidStatus === 'high' ? 'var(--warning)' : 'var(--success)',
                }}>{sidStatus === 'low' ? '‚Üì Acidosis' : sidStatus === 'high' ? '‚Üë Alkalosis' : 'Normal'}</span>
              </div>
            </div>
            
            {/* ATOT row */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--border)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px', fontWeight: '500' }}>A<sub>TOT</sub></span>
                <InfoButton onClick={() => setShowSheet('atot')} label="‚ìò" />
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '15px', fontWeight: '600' }}>{ATOT.toFixed(1)}</span>
                <span style={{
                  fontSize: '11px', padding: '2px 8px', borderRadius: '4px',
                  background: atotStatus === 'low' ? 'var(--warning-light)' : atotStatus === 'high' ? 'var(--error-light)' : 'var(--success-light)',
                  color: atotStatus === 'low' ? 'var(--warning)' : atotStatus === 'high' ? 'var(--error)' : 'var(--success)',
                }}>{atotStatus === 'low' ? '‚Üì Alkalosis' : atotStatus === 'high' ? '‚Üë Acidosis' : 'Normal'}</span>
              </div>
            </div>
            
            {/* pCO2 row */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0' }}>
              <span style={{ fontSize: '14px', fontWeight: '500' }}>pCO‚ÇÇ</span>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '15px', fontWeight: '600' }}>{paCO2}</span>
                <span style={{
                  fontSize: '11px', padding: '2px 8px', borderRadius: '4px',
                  background: pCO2Status === 'high' ? 'var(--error-light)' : pCO2Status === 'low' ? 'var(--warning-light)' : 'var(--success-light)',
                  color: pCO2Status === 'high' ? 'var(--error)' : pCO2Status === 'low' ? 'var(--warning)' : 'var(--success)',
                }}>{pCO2Status === 'high' ? '‚Üë Acidosis' : pCO2Status === 'low' ? '‚Üì Alkalosis' : 'Normal'}</span>
              </div>
            </div>
          </div>
          
          {/* SIG - derived value for unmeasured anions */}
          <div style={{ ...styles.card, background: sigElevated ? 'var(--error-light)' : 'var(--bg-secondary)', border: sigElevated ? '1px solid var(--error)' : '1px solid var(--border)' }} className="animate-in stagger-2">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px', fontWeight: '500' }}>SIG</span>
                <InfoButton onClick={() => setShowSheet('sig')} label="‚ìò" />
                <span style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>(unmeasured anions‚Åª)</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '15px', fontWeight: '600' }}>{SIG.toFixed(1)}</span>
                <span style={{
                  fontSize: '11px', padding: '2px 8px', borderRadius: '4px',
                  background: sigElevated ? 'var(--error)' : 'var(--success-light)',
                  color: sigElevated ? 'white' : 'var(--success)',
                }}>{sigElevated ? '‚Üë Elevated' : 'Normal'}</span>
              </div>
            </div>
            {sigElevated && (
              <div style={{ marginTop: '8px', fontSize: '12px', color: 'var(--error)' }}>
                Unmeasured strong anions present ‚Äî consider ketoacids, uraemia, toxins
              </div>
            )}
            {sigElevated && (
              <button
                onClick={() => setShowSheet('osmgap')}
                style={{ marginTop: '10px', width: '100%', padding: '8px', background: 'var(--warning-light)', border: 'none', borderRadius: '6px', fontSize: '12px', fontWeight: '500', cursor: 'pointer', fontFamily: 'var(--font)', color: 'var(--warning)' }}
              >Check Osmolar Gap (toxic alcohols)</button>
            )}
          </div>

          {/* Component Breakdown */}
          <div style={styles.card} className="animate-in stagger-3">
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)', letterSpacing: '0.5px', marginBottom: '10px' }}>
              WHAT'S AFFECTING SID?
            </div>
            
            {sidComponents.map((c, i) => (
              <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0', borderBottom: i < sidComponents.length - 1 ? '1px solid var(--border)' : 'none' }}>
                <span style={{ fontSize: '13px' }}>{c.label}</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '13px', fontWeight: '500' }}>{c.value}</span>
                  {Math.abs(c.effect) > 2 && (
                    <span style={{ fontSize: '10px', color: c.effect > 0 ? 'var(--warning)' : 'var(--error)' }}>
                      {c.effect > 0 ? '‚ÜëSID' : '‚ÜìSID'}
                    </span>
                  )}
                </div>
              </div>
            ))}
            
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)', letterSpacing: '0.5px', marginTop: '16px', marginBottom: '10px' }}>
              WHAT'S AFFECTING A<sub style={{ fontSize: '9px' }}>TOT</sub>?
            </div>
            
            {atotComponents.map((c, i) => (
              <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0', borderBottom: i < atotComponents.length - 1 ? '1px solid var(--border)' : 'none' }}>
                <span style={{ fontSize: '13px' }}>{c.label}</span>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '13px', fontWeight: '500' }}>{c.value} {c.unit}</span>
                  {Math.abs(c.effect) > 1 && (
                    <span style={{ fontSize: '10px', color: c.effect > 0 ? 'var(--warning)' : 'var(--error)' }}>
                      {c.effect > 0 ? '‚ÜìATOT' : '‚ÜëATOT'}
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Copy and restart buttons */}
          <button
            className="animate-in stagger-4"
            style={{ ...styles.button, marginTop: '12px', background: 'var(--bg-tertiary)', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}
            onClick={() => {
              let text = `ABG (Stewart): pH ${pH.toFixed(2)} | pCO‚ÇÇ ${paCO2} | SIDa ${SIDa.toFixed(1)} | ATOT ${ATOT.toFixed(1)} | SIG ${SIG.toFixed(1)}.`;
              
              if (disorders.length > 0) {
                text += ` Interpretation: ${disorders.map(d => d.source).join(', ')}.`;
              }
              
              navigator.clipboard.writeText(text).then(() => {
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
              });
            }}
          >
            {copied ? '‚úì Copied to clipboard' : 'üìã Copy for medical record'}
          </button>

          <button
            className="animate-in stagger-4"
            style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '8px' }}
            onClick={onRestart}
          >
            New Analysis
          </button>

          <div style={{ textAlign: 'center', padding: '12px 16px 8px', fontSize: '11px', color: 'var(--text-tertiary)' }}>
            For educational purposes only.<br/><span style={{ fontSize: '13px', fontWeight: '500' }}>¬© 2025 Scott Santinon</span>
          </div>

          {/* Bottom Sheets */}
          <BottomSheet isOpen={showSheet === 'sid'} onClose={() => setShowSheet(null)} title="Strong Ion Difference (SID)">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ padding: '12px', background: sidStatus === 'low' ? 'var(--error-light)' : sidStatus === 'high' ? 'var(--warning-light)' : 'var(--success-light)', borderRadius: '8px', marginBottom: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>SID</span>
                  <span style={{ fontSize: '18px', fontWeight: '700' }}>{SIDa.toFixed(1)} mEq/L</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: sidStatus === 'low' ? 'var(--error)' : sidStatus === 'high' ? 'var(--warning)' : 'var(--success)' }}>
                  {sidStatus === 'low' ? '‚Üì Low SID ‚Üí metabolic acidosis' : sidStatus === 'high' ? '‚Üë High SID ‚Üí metabolic alkalosis' : 'Normal (38-42 mEq/L)'}
                </div>
              </div>
              
              <div style={{ fontSize: '13px', marginBottom: '12px' }}>
                <p>SID is the difference between strong cations and strong anions in plasma. It's one of three independent variables that determine pH.</p>
              </div>
              
              <div style={{ marginTop: '12px', fontSize: '13px' }}>
                <p>‚Ä¢ ‚ÜìSID ‚Üí acidosis (excess anions‚Åª relative to cations‚Å∫)</p>
                <p>‚Ä¢ ‚ÜëSID ‚Üí alkalosis (excess cations‚Å∫ relative to anions‚Åª)</p>
              </div>
              
              <ExpandableWorking>
                <p><strong>SID = (Na‚Å∫ + K‚Å∫ + 2√óCa¬≤‚Å∫ + 2√óMg¬≤‚Å∫) ‚àí (Cl‚Åª + Lactate)</strong></p>
                <p style={{ marginTop: '6px' }}>= ({na} + {k} + {(2*ca).toFixed(1)} + {(2*mg).toFixed(1)}) ‚àí ({cl} + {lactate})</p>
                <p>= {(na + k + 2*ca + 2*mg).toFixed(1)} ‚àí {(cl + lactate).toFixed(1)} = <strong>{SIDa.toFixed(1)}</strong></p>
              </ExpandableWorking>
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'atot'} onClose={() => setShowSheet(null)} title="Weak Acid Buffers (ATOT)">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ padding: '12px', background: atotStatus === 'low' ? 'var(--warning-light)' : atotStatus === 'high' ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px', marginBottom: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>A<sub>TOT</sub></span>
                  <span style={{ fontSize: '18px', fontWeight: '700' }}>{ATOT.toFixed(1)} mEq/L</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: atotStatus === 'low' ? 'var(--warning)' : atotStatus === 'high' ? 'var(--error)' : 'var(--success)' }}>
                  {atotStatus === 'low' ? '‚Üì Low ATOT ‚Üí metabolic alkalosis' : atotStatus === 'high' ? '‚Üë High ATOT ‚Üí metabolic acidosis' : 'Normal'}
                </div>
              </div>
              
              <div style={{ fontSize: '13px', marginBottom: '12px' }}>
                <p>A<sub>TOT</sub> is the total concentration of weak acid buffers ‚Äî mainly <strong>albumin</strong> and phosphate.</p>
                <p style={{ marginTop: '8px', color: 'var(--text-secondary)' }}>Hypoalbuminaemia is extremely common in hospital patients and causes an apparent alkalosis that masks underlying acidosis.</p>
              </div>
              
              <div style={{ marginTop: '12px', fontSize: '13px' }}>
                <p>‚Ä¢ ‚ÜìA<sub>TOT</sub> ‚Üí alkalosis (fewer weak acids)</p>
                <p>‚Ä¢ ‚ÜëA<sub>TOT</sub> ‚Üí acidosis (more weak acids, e.g. hyperphosphataemia)</p>
              </div>
              
              <ExpandableWorking>
                <p><strong>Figge-Fencl formula (pH-dependent)</strong></p>
                <p style={{ marginTop: '6px' }}>Albumin charge = {albumin} √ó (0.123 √ó {pH.toFixed(2)} ‚àí 0.631) = {albuminCharge.toFixed(1)}</p>
                <p>Phosphate charge = {phosphate} √ó (0.309 √ó {pH.toFixed(2)} ‚àí 0.469) = {phosphateCharge.toFixed(1)}</p>
                <p style={{ marginTop: '6px' }}><strong>A<sub>TOT</sub> = {albuminCharge.toFixed(1)} + {phosphateCharge.toFixed(1)} = {ATOT.toFixed(1)}</strong></p>
              </ExpandableWorking>
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'sig'} onClose={() => setShowSheet(null)} title="Strong Ion Gap (SIG)">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ padding: '12px', background: sigElevated ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px', marginBottom: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>SIG</span>
                  <span style={{ fontSize: '18px', fontWeight: '700' }}>{SIG.toFixed(1)} mEq/L</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: sigElevated ? 'var(--error)' : 'var(--success)' }}>
                  {sigElevated ? '‚Üë Unmeasured anions‚Åª present' : 'Normal (<5 mEq/L)'}
                </div>
              </div>
              
              <div style={{ fontSize: '13px', marginBottom: '12px' }}>
                <p>SIG detects <strong>unmeasured strong anions‚Åª</strong> ‚Äî acids that aren't captured by measuring lactate alone.</p>
                <p style={{ marginTop: '8px', color: 'var(--text-secondary)' }}>Think of it as a more precise version of the anion gap that already accounts for albumin.</p>
              </div>
              
              {sigElevated && (
                <div style={{ padding: '10px', background: 'var(--error-light)', borderRadius: '8px', fontSize: '13px', marginBottom: '12px' }}>
                  <strong style={{ color: 'var(--error)' }}>Causes of elevated SIG:</strong>
                  <p style={{ marginTop: '4px' }}>‚Ä¢ Ketoacids (DKA, starvation, alcoholic)</p>
                  <p>‚Ä¢ Unmeasured lactate / hypoperfusion</p>
                  <p>‚Ä¢ Uraemic acids (renal failure)</p>
                  <p>‚Ä¢ Toxic alcohols (methanol, ethylene glycol)</p>
                  <p>‚Ä¢ Salicylate</p>
                </div>
              )}
              
              <ExpandableWorking>
                <p><strong>SIG = SIDa ‚àí SIDe</strong></p>
                <p>= {SIDa.toFixed(1)} ‚àí {SIDe.toFixed(1)} = {SIG.toFixed(1)}</p>
                <Divider />
                <p>SIDe = HCO‚ÇÉ + weak acid buffers</p>
                <p>= {hco3} + {ATOT.toFixed(1)} = {SIDe.toFixed(1)}</p>
              </ExpandableWorking>
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'osmgap'} onClose={() => setShowSheet(null)} title="Osmolar Gap">
            <OsmolarGapBottomSheetContent data={data} setData={setData} na={na} sigElevated={sigElevated} />
          </BottomSheet>
        </div>
      );
    };
    // Step 3: Osmolar Gap (optional, for HAGMA)
    const Step3_OsmolarGap = ({ data, setData, onNext, onBack }) => {
      const [wantOG, setWantOG] = useState(null);
      
      // Robust parsing helper
      const parseVal = (v) => {
        if (!v || v === '') return null;
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      };
      
      const na = parseFloat(data.na) || 140;
      const glucose = parseVal(data.glucose);
      const urea = parseVal(data.urea);
      const measuredOsm = parseVal(data.measuredOsm);
      
      let osmGap = null;
      let canCalculate = glucose !== null && urea !== null && measuredOsm !== null;
      
      if (canCalculate) {
        const calculatedOsm = (2 * na) + glucose + urea;
        osmGap = measuredOsm - calculatedOsm;
      }

      const highOG = osmGap !== null && osmGap > 10;
      const highAG = data.isHAGMA;

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 3</div>
            <h1 style={styles.title}>Osmolar Gap</h1>
          </div>

          {wantOG === null && (
            <div style={styles.card} className="animate-in stagger-1">
              <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '14px', lineHeight: '1.5' }}>
                Detects abnormal solutes in plasma. Interpreted alongside the anion gap.
              </p>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                <button
                  style={{ ...styles.button, ...styles.buttonSmall }}
                  onClick={() => setWantOG(true)}
                >
                  Calculate
                </button>
                <button
                  style={{ ...styles.button, ...styles.buttonSmall, ...styles.buttonSecondary }}
                  onClick={() => { setWantOG(false); onNext(); }}
                >
                  Skip
                </button>
              </div>
            </div>
          )}

          {wantOG === true && (
            <>
              <div style={styles.card} className="animate-in stagger-1">
                <div style={styles.grid}>
                  <Input 
                    label="Glucose" 
                    unit="mmol/L" 
                    value={data.glucose || ''} 
                    onChange={v => setData(prev => ({...prev, glucose: v}))} 
                    placeholder="5.5"
                    autoFocus
                  />
                  <Input 
                    label="Urea" 
                    unit="mmol/L" 
                    value={data.urea || ''} 
                    onChange={v => setData(prev => ({...prev, urea: v}))} 
                    placeholder="5.0"
                  />
                </div>
                <Input 
                  label="Measured Osm" 
                  unit="mOsm/kg" 
                  value={data.measuredOsm || ''} 
                  onChange={v => setData(prev => ({...prev, measuredOsm: v}))} 
                  placeholder="285"
                />
              </div>

              {canCalculate && (
                <>
                  <div style={styles.card} className="animate-in">
                    <div style={styles.resultBox}>
                      <div style={styles.resultLabel}>Osmolar Gap</div>
                      <span style={styles.statusBadge(highOG ? 'error' : 'success')}>
                        {osmGap.toFixed(0)} mOsm/kg {highOG ? '(Elevated)' : '(Normal)'}
                      </span>
                    </div>
                    
                    <ExpandableWorking>
                      <p><Formula>OG = Measured ‚àí Calculated</Formula></p>
                      <p>Calculated = (2 √ó Na) + Glucose + Urea</p>
                      <p>= (2 √ó {na}) + {glucose} + {urea} = {((2 * na) + glucose + urea).toFixed(0)}</p>
                      <p>OG = {measuredOsm} ‚àí {((2 * na) + glucose + urea).toFixed(0)} = {osmGap.toFixed(0)}</p>
                      <Divider />
                      <p style={{ fontSize: '12px' }}>Normal {"<"} 10 mOsm/kg</p>
                    </ExpandableWorking>
                  </div>

                  {/* Interpretation based on OG + AG combination */}
                  <div style={styles.card} className="animate-in stagger-2">
                    <div style={styles.cardTitle}>
                      {highOG && highAG && 'High OG + High AG'}
                      {highOG && !highAG && 'High OG + Normal AG'}
                      {!highOG && highAG && 'Normal OG + High AG'}
                      {!highOG && !highAG && 'Normal OG + Normal AG'}
                    </div>
                    
                    {highOG && highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          Foreign solute that has dissociated
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>‚Ä¢ Toxic alcohol (mid-stage)</p>
                          <p>‚Ä¢ Salicylate intoxication</p>
                          <p>‚Ä¢ Lactic acidosis</p>
                          <p>‚Ä¢ Ketoacidosis</p>
                          <p>‚Ä¢ AKI</p>
                        </div>
                      </>
                    )}
                    
                    {highOG && !highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          Foreign solute that has not dissociated
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>‚Ä¢ Mannitol</p>
                          <p>‚Ä¢ Ethanol</p>
                          <p>‚Ä¢ Toxic alcohol (early)</p>
                          <p>‚Ä¢ Glycine (TURP syndrome)</p>
                        </div>
                      </>
                    )}
                    
                    {!highOG && highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          No foreign osmoles ‚Äî consider other HAGMA causes
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>‚Ä¢ Toxic alcohol (late ‚Äî fully metabolised)</p>
                          <p>‚Ä¢ Ketoacidosis</p>
                          <p>‚Ä¢ Lactic acidosis</p>
                          <p>‚Ä¢ Uraemia</p>
                        </div>
                      </>
                    )}
                    
                    {!highOG && !highAG && (
                      <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                        No evidence of abnormal solute.
                      </p>
                    )}
                  </div>

                  {/* Toxic alcohol timeline */}
                  {highOG && (
                    <div style={styles.card} className="animate-in stagger-3">
                      <div style={styles.cardTitle}>Toxic Alcohol Timeline</div>
                      <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Early</strong> ‚Äî non-polar, not yet metabolised ‚Üí ‚ÜëOG only</p>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Middle</strong> ‚Äî partially metabolised to organic acids ‚Üí ‚ÜëOG and ‚ÜëAG</p>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Late</strong> ‚Äî fully metabolised ‚Üí ‚ÜëAG, normal OG</p>
                      </div>
                    </div>
                  )}
                </>
              )}

              <button
                className="animate-in stagger-4"
                style={styles.button}
                onClick={() => {
                  setData(prev => ({ ...prev, osmGap, highOG, ogCalculated: true }));
                  onNext();
                }}
              >
                Next ‚Üí
              </button>
            </>
          )}
        </div>
      );
    };

    // Find Cause Screen (Step Two)
    // Lactate Causes Screen (sub-screen)
    // ============================================
    // FIND CAUSE - STEPWISE WORKFLOW
    // ============================================

    // Sub-screen: Lactate Causes
    // Lactic Acidosis Bottom Sheet Content
    const LactateCausesContent = () => (
      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Tissue Hypoxia</div>
          <div style={{ paddingLeft: '12px' }}>
            Hypoxaemia, insufficient cardiac output, anaemia, regional ischaemia (limb, mesenteric), COHb, MetHb
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Metabolic</div>
          <div style={{ paddingLeft: '12px' }}>
            Ketoacidosis, hyperglycaemia, thiamine deficiency, liver failure, sepsis, malignancy, inborn errors of metabolism
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Drugs &amp; Toxins</div>
          <div style={{ paddingLeft: '12px' }}>
            Toxic alcohols, metformin, cyanide, propofol infusion syndrome, paracetamol, salicylates
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Other</div>
          <div style={{ paddingLeft: '12px' }}>
            Beta-2 agonism, seizures, strenuous exercise
          </div>
        </div>
        
        <div style={{ padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '8px' }}>
          <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '4px' }}>Lactate Gap</div>
          <div style={{ fontSize: '12px', lineHeight: '1.5' }}>
            If <strong>POC lactate ‚àí Lab lactate &gt;5</strong>, suspect <strong style={{ color: 'var(--error)' }}>ethylene glycol</strong> poisoning (POC assay cross-reacts with glycolate).
          </div>
        </div>
      </div>
    );

    // Ketoacidosis Bottom Sheet Content
    const KetoacidosisCausesContent = () => (
      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Diabetic Ketoacidosis</div>
          <div style={{ paddingLeft: '12px' }}>
            Insulin deficiency + counter-regulatory hormones. Usually glucose &gt;14 mmol/L but euglycaemic DKA exists (especially with SGLT2 inhibitors).
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Alcoholic Ketoacidosis</div>
          <div style={{ paddingLeft: '12px' }}>
            Binge drinking + poor nutrition + vomiting. Glucose often low-normal. Œ≤-hydroxybutyrate predominates (nitroprusside test may be negative).
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Starvation Ketosis</div>
          <div style={{ paddingLeft: '12px' }}>
            Prolonged fasting, anorexia, hyperemesis gravidarum. Ketones rarely high enough to cause significant acidosis.
          </div>
        </div>
      </div>
    );

    // Osmolar Gap Calculator for BottomSheet (with local state for stability)
    const OsmolarGapBottomSheetContent = ({ data, setData, na, sigElevated }) => {
      // Use local state - simpler, no syncing needed for bottom sheet context
      const [localOsm, setLocalOsm] = useState(data?.measuredOsm ? String(data.measuredOsm) : '');
      const [localGlucose, setLocalGlucose] = useState(data?.glucose ? String(data.glucose) : '');
      const [localUrea, setLocalUrea] = useState(data?.urea ? String(data.urea) : '');
      
      const parseVal = (v) => {
        if (!v || v === '') return null;
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      };
      
      const measOsm = parseVal(localOsm);
      const glucose = parseVal(localGlucose);
      const urea = parseVal(localUrea);
      const canCalculate = measOsm !== null && glucose !== null && urea !== null;
      const calcOsm = canCalculate ? (2 * na) + glucose + urea : null;
      const osmGap = canCalculate ? measOsm - calcOsm : null;
      const isElevated = osmGap !== null && osmGap > 10;
      
      return (
        <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
          <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '12px', fontSize: '13px' }}>
            <strong>What is the osmolar gap?</strong>
            <p style={{ marginTop: '4px', color: 'var(--text-secondary)' }}>
              The difference between measured and calculated osmolality. Detects unmeasured osmotically active substances.
            </p>
          </div>
          
          <div style={styles.grid}>
            <Input label="Measured Osm" unit="mOsm/kg" value={localOsm} onChange={setLocalOsm} placeholder="285" />
            <Input label="Glucose" unit="mmol/L" value={localGlucose} onChange={setLocalGlucose} placeholder="5.5" />
          </div>
          <Input label="Urea" unit="mmol/L" value={localUrea} onChange={setLocalUrea} placeholder="5.0" />
          
          {canCalculate && (
            <>
              <div style={{ marginTop: '12px', padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px' }}>
                <p>Calc Osm = 2√óNa + Glucose + Urea = 2√ó{na} + {glucose} + {urea} = <strong>{calcOsm.toFixed(0)}</strong></p>
              </div>
              
              <div style={{ marginTop: '12px', padding: '12px', background: isElevated ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>Osmolar Gap</span>
                  <span style={{ fontSize: '20px', fontWeight: '700' }}>{osmGap.toFixed(0)}</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: 'var(--text-secondary)' }}>
                  Normal: &lt;10 mOsm/kg
                </div>
              </div>
              
              {isElevated && (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--warning)' }}>Elevated OG ‚Äî causes:</strong>
                  <p style={{ marginTop: '6px', color: 'var(--text-secondary)', fontSize: '12px' }}>
                    Toxic alcohols (methanol, ethylene glycol, isopropanol), ethanol, mannitol/sorbitol, glycine (TURP syndrome), severe hyperproteinaemia/hyperlipidaemia, contrast media
                  </p>
                </div>
              )}
              
              {isElevated && sigElevated && (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--error-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--error)' }}>‚ö†Ô∏è Elevated OG + elevated SIG</strong>
                  <p style={{ marginTop: '4px', color: 'var(--text-secondary)', fontSize: '12px' }}>
                    High suspicion for toxic alcohols ‚Äî parent compound raises osmolality while metabolites (formic acid, glycolic acid) cause acidosis.
                  </p>
                </div>
              )}
            </>
          )}
        </div>
      );
    };

    // Sub-screen: Osmolar Gap Calculator
    const OsmolarGapScreen = ({ data, setData, onBack, onNext }) => {
      // Use local state for inputs - only sync back when leaving
      const [localOsm, setLocalOsm] = useState(data?.measuredOsm ? String(data.measuredOsm) : '');
      const [localGlucose, setLocalGlucose] = useState(data?.glucose ? String(data.glucose) : '');
      const [localUrea, setLocalUrea] = useState(data?.urea ? String(data.urea) : '');
      
      const na = parseFloat(data?.na) || 140;
      
      // Robust parsing - only return number if valid
      const parseVal = (v) => {
        if (!v || v === '') return null;
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      };
      
      const measOsm = parseVal(localOsm);
      const glucose = parseVal(localGlucose);
      const urea = parseVal(localUrea);
      
      const canCalculate = measOsm !== null && glucose !== null && urea !== null;
      const calcOsm = canCalculate ? (2 * na) + glucose + urea : null;
      const osmGap = canCalculate ? measOsm - calcOsm : null;
      const isElevated = osmGap !== null && osmGap > 10;
      const correctedAG = parseFloat(data?.correctedAG) || 12;
      const highAG = correctedAG > 12;
      
      // Sync back to parent when leaving
      const syncAndExit = (callback) => {
        if (setData) {
          setData(prev => ({
            ...prev, 
            measuredOsm: localOsm, 
            glucose: localGlucose, 
            urea: localUrea,
            osmGapCalculated: canCalculate,
            osmGapValue: osmGap,
            osmGapElevated: isElevated
          }));
        }
        callback();
      };
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={() => syncAndExit(onBack)}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <h1 style={styles.title}>Osmolar Gap</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
              Detects unmeasured osmotically active substances
            </div>
            <div style={styles.grid}>
              <Input label="Measured Osm" unit="mOsm/kg" value={localOsm} onChange={setLocalOsm} placeholder="285" />
              <Input label="Glucose" unit="mmol/L" value={localGlucose} onChange={setLocalGlucose} placeholder="5.5" />
            </div>
            <Input label="Urea" unit="mmol/L" value={localUrea} onChange={setLocalUrea} placeholder="5.0" />
            
            {canCalculate && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px', background: isElevated ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px', marginTop: '12px' }}>
                <div>
                  <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>Osmolar Gap</div>
                  <div style={{ fontSize: '20px', fontWeight: '700' }}>{osmGap.toFixed(0)}</div>
                  <div style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>Normal &lt;10</div>
                </div>
                <span style={styles.statusBadge(isElevated ? 'error' : 'success')}>{isElevated ? '‚ÜëElevated' : 'Normal'}</span>
              </div>
            )}
          </div>

          {canCalculate && (
            <div style={styles.card} className="animate-in stagger-2">
              <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
                Calc Osm = 2√ó{na} + {glucose} + {urea} = {calcOsm.toFixed(0)}
              </div>
              
              {isElevated && highAG && (
                <div style={{ padding: '10px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '10px' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: 'var(--error)', marginBottom: '4px' }}>‚ÜëOG + ‚ÜëAG pattern:</div>
                  <div style={{ fontSize: '12px', lineHeight: '1.6', color: 'var(--text-secondary)' }}>
                    Toxic alcohol (mid-stage), salicylate intoxication, severe lactic acidosis, ketoacidosis
                  </div>
                </div>
              )}
              {isElevated && !highAG && (
                <div style={{ padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', marginBottom: '10px' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: 'var(--warning)', marginBottom: '4px' }}>‚ÜëOG + normal AG pattern:</div>
                  <div style={{ fontSize: '12px', lineHeight: '1.6', color: 'var(--text-secondary)' }}>
                    Toxic alcohol (early), ethanol, mannitol/sorbitol, glycine (TURP syndrome), contrast media
                  </div>
                </div>
              )}
              {!isElevated && highAG && (
                <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '10px' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '4px' }}>Normal OG + ‚ÜëAG pattern:</div>
                  <div style={{ fontSize: '12px', lineHeight: '1.6', color: 'var(--text-secondary)' }}>
                    Toxic alcohol (late ‚Äî fully metabolised), ketoacidosis, lactic acidosis, uraemia
                  </div>
                </div>
              )}
              {!isElevated && !highAG && (
                <div style={{ fontSize: '12px', color: 'var(--success)' }}>No evidence of abnormal solute load.</div>
              )}
              
              {isElevated && (
                <div style={{ padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px', fontSize: '11px', color: 'var(--text-secondary)' }}>
                  <strong>Toxic alcohol timeline:</strong><br/>
                  Early: ‚ÜëOG only ‚Üí Mid: ‚ÜëOG+‚ÜëAG ‚Üí Late: ‚ÜëAG only
                </div>
              )}
            </div>
          )}

          {onNext && (
            <button className="animate-in stagger-3" style={styles.button} onClick={() => syncAndExit(onNext)}>
              Continue ‚Üí
            </button>
          )}
          
          <button className="animate-in stagger-3" style={{ ...styles.button, ...styles.buttonSecondary, marginTop: onNext ? '8px' : '0' }} onClick={() => syncAndExit(onBack)}>
            ‚Üê Back
          </button>
        </div>
      );
    };

    // Process Screen: HAGMA Workup
    const HAGMAWorkupScreen = ({ data, setData, onNext, onBack }) => {
      // Use data state for subScreen to persist across re-renders
      const subScreen = data.hagmaSubScreen || null;
      const setSubScreen = (val) => setData(prev => ({ ...prev, hagmaSubScreen: val }));
      
      const [showSheet, setShowSheet] = useState(null); // 'lactate', 'ketones', 'dlactate', 'pyroglutamic'
      const [investigatedUnexplained, setInvestigatedUnexplained] = useState(data.investigatedUnexplained || false);
      
      // Sync investigatedUnexplained to data when it changes
      const updateInvestigatedUnexplained = (val) => {
        setInvestigatedUnexplained(val);
        setData(prev => ({ ...prev, investigatedUnexplained: val }));
      };
      
      const correctedAG = parseFloat(data.correctedAG) || 12;
      const excessAG = Math.max(0, correctedAG - 12);
      const lactateVal = data.lactate && !isNaN(parseFloat(data.lactate)) ? parseFloat(data.lactate) : null;
      const lactateContribution = lactateVal !== null && lactateVal > 1 ? lactateVal - 1 : 0;
      const ketonesVal = data.ketones && !isNaN(parseFloat(data.ketones)) ? parseFloat(data.ketones) : null;
      const ketoneContribution = ketonesVal !== null && ketonesVal > 0.6 ? ketonesVal - 0.6 : 0;
      const explainedAG = lactateContribution + ketoneContribution;
      const unexplainedAG = Math.max(0, excessAG - explainedAG);
      const hasUnexplainedGap = unexplainedAG >= 2;
      const hasAnyInput = lactateVal !== null || ketonesVal !== null;
      const hasBothInputs = lactateVal !== null && ketonesVal !== null;
      
      // Can continue if: gap explained, OR haven't entered both values yet, OR user has investigated
      const canContinue = !hasUnexplainedGap || !hasBothInputs || investigatedUnexplained;
      
      // Calculate percentages for visual bar
      const totalBar = Math.max(excessAG, 1);
      const lactatePct = (lactateContribution / totalBar) * 100;
      const ketonePct = (ketoneContribution / totalBar) * 100;
      
      // Anion gap bar component - reusable
      const AnionGapBar = ({ showLegend = true }) => (
        <div>
          <div style={{ height: '28px', background: 'var(--bg-tertiary)', borderRadius: '6px', overflow: 'hidden', display: 'flex', border: '1px solid var(--border)' }}>
            {lactateContribution > 0 && (
              <div style={{ 
                width: `${lactatePct}%`, 
                background: 'linear-gradient(135deg, #FF9500, #FF6B00)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', fontWeight: '600', color: 'white',
                minWidth: lactateContribution > 0.5 ? '36px' : '0'
              }}>
                {lactateContribution >= 1 && `${lactateContribution.toFixed(1)}`}
              </div>
            )}
            {ketoneContribution > 0 && (
              <div style={{ 
                width: `${ketonePct}%`, 
                background: 'linear-gradient(135deg, #AF52DE, #8B3FC7)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', fontWeight: '600', color: 'white',
                minWidth: ketoneContribution > 0.5 ? '36px' : '0'
              }}>
                {ketoneContribution >= 1 && `${ketoneContribution.toFixed(1)}`}
              </div>
            )}
            {hasAnyInput && unexplainedAG > 0.1 && (
              <div style={{ 
                flex: 1,
                background: hasUnexplainedGap ? 'linear-gradient(135deg, #FF3B30, #D62D20)' : 'var(--success-light)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', fontWeight: '600', color: hasUnexplainedGap ? 'white' : 'var(--success)',
              }}>
                {unexplainedAG >= 0.5 && (hasUnexplainedGap ? `? ${unexplainedAG.toFixed(1)}` : '‚úì')}
              </div>
            )}
            {!hasAnyInput && (
              <div style={{ 
                flex: 1,
                background: 'repeating-linear-gradient(45deg, var(--border), var(--border) 10px, var(--bg-tertiary) 10px, var(--bg-tertiary) 20px)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', color: 'var(--text-secondary)',
              }}>
                Enter values
              </div>
            )}
          </div>
          {showLegend && hasAnyInput && (
            <div style={{ display: 'flex', gap: '12px', marginTop: '6px', fontSize: '10px', color: 'var(--text-tertiary)' }}>
              {lactateContribution > 0 && (
                <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                  <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: '#FF9500' }} />
                  <span>Lactate</span>
                </div>
              )}
              {ketoneContribution > 0 && (
                <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                  <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: '#AF52DE' }} />
                  <span>Ketones</span>
                </div>
              )}
              {hasUnexplainedGap && (
                <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                  <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: '#FF3B30' }} />
                  <span>Unexplained</span>
                </div>
              )}
            </div>
          )}
        </div>
      );
      
      if (subScreen === 'osmolar') {
        return <OsmolarGapScreen 
          data={data} 
          setData={setData} 
          onBack={() => setSubScreen(null)} 
          onNext={() => { updateInvestigatedUnexplained(true); onNext(); }}
        />;
      }
      
      if (subScreen === 'unexplained') {
        // Check if osmolar gap was calculated and elevated
        const ogElevated = data.osmGapElevated;
        const ogValue = data.osmGapValue;
        
        // Cause options for unexplained anions
        const unexplainedCauses = data.identifiedCauses?.unexplained || [];
        const toggleUnexplainedCause = (cause) => {
          const current = data.identifiedCauses?.unexplained || [];
          const updated = current.includes(cause) 
            ? current.filter(c => c !== cause)
            : [...current, cause];
          setData(prev => ({ ...prev, identifiedCauses: { ...prev.identifiedCauses, unexplained: updated }}));
        };
        
        // Selectable item style
        const itemStyle = (checked) => ({
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          padding: '8px 10px',
          marginBottom: '4px',
          background: checked ? 'var(--accent-light)' : 'var(--bg-tertiary)',
          border: checked ? '1px solid var(--accent)' : '1px solid transparent',
          borderRadius: '6px',
          cursor: 'pointer',
          fontSize: '12px',
        });
        
        const checkMark = (checked) => (
          <span style={{ 
            width: '14px', height: '14px', borderRadius: '3px',
            border: checked ? 'none' : '2px solid var(--border)',
            background: checked ? 'var(--accent)' : 'transparent',
            display: 'flex', alignItems: 'center', justifyContent: 'center',
            color: 'white', fontSize: '10px', flexShrink: 0
          }}>
            {checked && '‚úì'}
          </span>
        );
        
        return (
          <div style={styles.container}>
            <button style={styles.backButton} onClick={() => { setSubScreen(null); updateInvestigatedUnexplained(true); }}><BackIcon /> Back</button>
            
            <div style={styles.header} className="animate-in">
              <h1 style={styles.title}>Unexplained Anions‚Åª</h1>
            </div>

            <div style={styles.card} className="animate-in stagger-1">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: '8px' }}>
                <span style={{ fontSize: '13px', fontWeight: '600' }}>Excess AG</span>
                <span style={{ fontSize: '16px', fontWeight: '700', color: 'var(--error)' }}>+{excessAG.toFixed(1)}</span>
              </div>
              <AnionGapBar showLegend={true} />
              <div style={{ marginTop: '10px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                Lactate +{lactateContribution.toFixed(1)}, ketones +{ketoneContribution.toFixed(1)}.
                {ogElevated && <span style={{ display: 'block', color: 'var(--warning)', marginTop: '4px' }}>Osmolar gap elevated ({ogValue?.toFixed(0)}) ‚Äî toxic alcohols may contribute.</span>}
                {!ogElevated && data.osmGapCalculated && <span style={{ display: 'block', color: 'var(--text-secondary)', marginTop: '4px' }}>Osmolar gap normal ‚Äî toxic alcohol less likely.</span>}
                <strong style={{ display: 'block', color: 'var(--error)', marginTop: '4px' }}>+{unexplainedAG.toFixed(1)} remains unexplained.</strong>
              </div>
            </div>
            
            {/* Integrated differential with checkboxes */}
            <div style={styles.card} className="animate-in stagger-2">
              <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
                Select likely cause(s):
              </div>
              
              <div style={{ ...itemStyle(unexplainedCauses.includes('renal')), justifyContent: 'space-between' }} onClick={(e) => { e.stopPropagation(); toggleUnexplainedCause('renal'); }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  {checkMark(unexplainedCauses.includes('renal'))}
                  <span>Renal failure</span>
                </div>
                <span style={{ fontSize: '10px', color: 'var(--text-tertiary)' }}>sulphates, phosphates</span>
              </div>
              
              <div style={{ ...itemStyle(unexplainedCauses.includes('pyroglutamic')), justifyContent: 'space-between' }} onClick={(e) => { e.stopPropagation(); toggleUnexplainedCause('pyroglutamic'); }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  {checkMark(unexplainedCauses.includes('pyroglutamic'))}
                  <span>Pyroglutamic acidosis</span>
                </div>
                <button 
                  onClick={(e) => { e.stopPropagation(); setShowSheet('pyroglutamic'); }}
                  style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', padding: '2px' }}
                >
                  ‚ìò
                </button>
              </div>
              
              <div style={itemStyle(unexplainedCauses.includes('salicylate'))} onClick={(e) => { e.stopPropagation(); toggleUnexplainedCause('salicylate'); }}>
                {checkMark(unexplainedCauses.includes('salicylate'))}
                <span>Salicylate overdose</span>
              </div>
              
              <div style={{ ...itemStyle(unexplainedCauses.includes('dlactate')), justifyContent: 'space-between' }} onClick={(e) => { e.stopPropagation(); toggleUnexplainedCause('dlactate'); }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  {checkMark(unexplainedCauses.includes('dlactate'))}
                  <span>D-lactate</span>
                </div>
                <button 
                  onClick={(e) => { e.stopPropagation(); setShowSheet('dlactate'); }}
                  style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', padding: '2px' }}
                >
                  ‚ìò
                </button>
              </div>
              
              <div style={{ ...itemStyle(unexplainedCauses.includes('toxic_alcohol')), background: ogElevated ? 'var(--warning-light)' : unexplainedCauses.includes('toxic_alcohol') ? 'var(--accent-light)' : 'var(--bg-tertiary)' }} onClick={(e) => { e.stopPropagation(); toggleUnexplainedCause('toxic_alcohol'); }}>
                {checkMark(unexplainedCauses.includes('toxic_alcohol'))}
                <span>{ogElevated ? '‚ö†Ô∏è Toxic alcohol (‚ÜëOG detected)' : 'Toxic alcohol'}</span>
              </div>
            </div>

            {!data.osmGapCalculated && (
              <button 
                className="animate-in stagger-3"
                style={{ 
                  width: '100%', padding: '12px', background: 'var(--bg-tertiary)', color: 'var(--text-primary)',
                  border: '1px solid var(--border)', borderRadius: '10px', fontSize: '14px', fontWeight: '500',
                  cursor: 'pointer', fontFamily: 'var(--font)', marginBottom: '12px'
                }} 
                onClick={() => setSubScreen('osmolar')}
              >
                Check Osmolar Gap ‚Üí
              </button>
            )}
            
            {data.osmGapCalculated && (
              <div style={{ ...styles.card, background: ogElevated ? 'var(--warning-light)' : 'var(--success-light)', marginBottom: '12px' }} className="animate-in stagger-3">
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '14px' }}>{ogElevated ? '‚ö†Ô∏è' : '‚úì'}</span>
                    <div>
                      <div style={{ fontWeight: '600', fontSize: '13px' }}>Osmolar Gap: {ogValue?.toFixed(0)}</div>
                      <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                        {ogElevated ? 'Elevated' : 'Normal'}
                      </div>
                    </div>
                  </div>
                  <button 
                    style={{ fontSize: '12px', color: 'var(--accent)', background: 'none', border: 'none', padding: 0, cursor: 'pointer', fontFamily: 'var(--font)' }}
                    onClick={() => setSubScreen('osmolar')}
                  >
                    Recalculate
                  </button>
                </div>
              </div>
            )}

            <button className="animate-in stagger-4" style={styles.button} onClick={() => { updateInvestigatedUnexplained(true); onNext(); }}>
              Continue ‚Üí
            </button>
            
            {/* D-lactate info sheet */}
            <BottomSheet isOpen={showSheet === 'dlactate'} onClose={() => setShowSheet(null)} title="D-Lactate">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
                <p style={{ marginBottom: '12px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>D-lactate</strong> is produced by gut bacteria and not detected by standard L-lactate assays.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>When to suspect:</strong> Short bowel syndrome, jejunoileal bypass, or other conditions with bacterial overgrowth in a blind loop.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>Clinical features:</strong> Episodic encephalopathy, ataxia, slurred speech ‚Äî often after high-carbohydrate meals.
                </p>
                <p>
                  <strong>Diagnosis:</strong> Request specific D-lactate assay (not routine).
                </p>
              </div>
            </BottomSheet>
            
            {/* Pyroglutamic acidosis info sheet */}
            <BottomSheet isOpen={showSheet === 'pyroglutamic'} onClose={() => setShowSheet(null)} title="Pyroglutamic Acidosis">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
                <p style={{ marginBottom: '12px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>5-oxoproline (pyroglutamic acid)</strong> accumulation causes HAGMA, often unrecognised.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>Risk factors:</strong> Chronic paracetamol use + malnutrition/sepsis/renal impairment. Glutathione depletion disrupts the Œ≥-glutamyl cycle.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>Clinical clues:</strong> Elderly female, chronic paracetamol (even therapeutic doses), poor nutrition, unexplained HAGMA.
                </p>
              </div>
            </BottomSheet>
          </div>
        );
      }
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process 1</div>
            <h1 style={styles.title}>HAGMA Workup</h1>
          </div>
          
          {/* Input section FIRST */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: '10px' }}>
              <span style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)', letterSpacing: '0.5px' }}>MEASURED VALUES</span>
              <span style={{ fontSize: '14px', fontWeight: '600', color: 'var(--error)' }}>+{excessAG.toFixed(1)} to explain</span>
            </div>
            
            {/* Lactate row */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
              <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: lactateContribution > 0 ? '#FF9500' : 'var(--border)', flexShrink: 0 }} />
              <span style={{ fontSize: '13px', width: '55px', flexShrink: 0 }}>Lactate</span>
              <div style={{ width: '70px' }}>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.lactate || ''}
                  onChange={e => setData(prev => ({...prev, lactate: e.target.value}))}
                  placeholder="‚Äî"
                  style={{
                    width: '100%',
                    padding: '8px 10px',
                    fontSize: '15px',
                    fontWeight: '500',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    background: 'var(--bg-tertiary)',
                    fontFamily: 'var(--font)',
                    textAlign: 'center',
                  }}
                />
              </div>
              <span style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>mmol/L</span>
              <span style={{ marginLeft: 'auto', fontSize: '14px', fontWeight: '600', color: lactateContribution > 0 ? '#FF9500' : 'var(--text-tertiary)' }}>
                {lactateVal !== null ? `+${lactateContribution.toFixed(1)}` : ''}
              </span>
              {lactateVal > 2 && (
                <button onClick={() => setShowSheet('lactate')} style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font)', padding: '4px' }}>‚ìò</button>
              )}
            </div>
            
            {/* Ketones row */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
              <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: ketoneContribution > 0 ? '#AF52DE' : 'var(--border)', flexShrink: 0 }} />
              <span style={{ fontSize: '13px', width: '55px', flexShrink: 0 }}>Ketones</span>
              <div style={{ width: '70px' }}>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.ketones || ''}
                  onChange={e => setData(prev => ({...prev, ketones: e.target.value}))}
                  placeholder="‚Äî"
                  style={{
                    width: '100%',
                    padding: '8px 10px',
                    fontSize: '15px',
                    fontWeight: '500',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    background: 'var(--bg-tertiary)',
                    fontFamily: 'var(--font)',
                    textAlign: 'center',
                  }}
                />
              </div>
              <span style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>mmol/L</span>
              <span style={{ marginLeft: 'auto', fontSize: '14px', fontWeight: '600', color: ketoneContribution > 0 ? '#AF52DE' : 'var(--text-tertiary)' }}>
                {ketonesVal !== null ? `+${ketoneContribution.toFixed(1)}` : ''}
              </span>
              {ketonesVal > 1 && (
                <button onClick={() => setShowSheet('ketones')} style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font)', padding: '4px' }}>‚ìò</button>
              )}
            </div>
          </div>

          {/* Visual bar BELOW inputs */}
          {hasAnyInput && (
            <div style={styles.card} className="animate-in stagger-2">
              <AnionGapBar showLegend={true} />
            </div>
          )}

          {/* Unexplained gap message - only show after user has entered BOTH lactate and ketones */}
          {hasBothInputs && hasUnexplainedGap && !investigatedUnexplained && (
            <div style={{ ...styles.card, background: 'var(--warning-light)', borderLeft: '3px solid var(--warning)' }} className="animate-in stagger-3">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
                Accounting for lactataemia and ketosis, there are still <strong style={{ color: 'var(--warning)' }}>+{unexplainedAG.toFixed(1)} unexplained anions‚Åª</strong>.
              </div>
              <button 
                onClick={() => setSubScreen('unexplained')}
                style={{ 
                  marginTop: '12px', width: '100%', padding: '10px', 
                  background: 'var(--warning)', color: 'white',
                  border: 'none', borderRadius: '8px', fontSize: '13px', fontWeight: '600',
                  cursor: 'pointer', fontFamily: 'var(--font)'
                }}
              >
                Investigate unexplained gap ‚Üí
              </button>
            </div>
          )}
          
          {/* Investigated but still unexplained */}
          {hasBothInputs && hasUnexplainedGap && investigatedUnexplained && (
            <div style={{ ...styles.card, background: 'var(--bg-tertiary)' }} className="animate-in stagger-3">
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px' }}>‚ö†Ô∏è</span>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  +{unexplainedAG.toFixed(1)} remains unexplained
                </div>
              </div>
              <button 
                style={{ marginTop: '8px', fontSize: '12px', color: 'var(--accent)', background: 'none', border: 'none', padding: 0, cursor: 'pointer', fontFamily: 'var(--font)' }}
                onClick={() => setSubScreen('unexplained')}
              >
                Review differential ‚Üí
              </button>
            </div>
          )}
          
          {/* Success state when fully explained - only show after both inputs entered */}
          {hasBothInputs && !hasUnexplainedGap && (
            <div style={{ ...styles.card, background: 'var(--success-light)', borderLeft: '3px solid var(--success)' }} className="animate-in stagger-3">
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '16px' }}>‚úì</span>
                <div>
                  <div style={{ fontWeight: '600', color: 'var(--success)', fontSize: '14px' }}>Gap adequately explained</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                    Lactate and ketones account for the elevated AG
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Continue button */}
          {canContinue && (
            <button className="animate-in stagger-4" style={styles.button} onClick={onNext}>
              Continue ‚Üí
            </button>
          )}
          
          {/* Bottom sheets for lactate/ketone info */}
          <BottomSheet isOpen={showSheet === 'lactate'} onClose={() => setShowSheet(null)} title="Lactic Acidosis">
            <LactateCausesContent />
          </BottomSheet>
          
          <BottomSheet isOpen={showSheet === 'ketones'} onClose={() => setShowSheet(null)} title="Ketoacidosis">
            <KetoacidosisCausesContent />
          </BottomSheet>
        </div>
      );
    };

    // Process Screen: NAGMA
    const NAGMAScreen = ({ data, setData, onNext, onBack, processNumber }) => {
      const [showUAG, setShowUAG] = useState(false);
      
      // Initialize causes if not present
      const causes = data.identifiedCauses?.nagma || [];
      const toggleCause = (cause) => {
        const current = data.identifiedCauses?.nagma || [];
        const updated = current.includes(cause) 
          ? current.filter(c => c !== cause)
          : [...current, cause];
        setData(prev => ({ ...prev, identifiedCauses: { ...prev.identifiedCauses, nagma: updated }}));
      };
      
      // Selectable item style
      const itemStyle = (checked) => ({
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        padding: '8px 10px',
        marginBottom: '4px',
        background: checked ? 'var(--accent-light)' : 'var(--bg-tertiary)',
        border: checked ? '1px solid var(--accent)' : '1px solid transparent',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '12px',
      });
      
      const checkMark = (checked) => (
        <span style={{ 
          width: '14px', height: '14px', borderRadius: '3px',
          border: checked ? 'none' : '2px solid var(--border)',
          background: checked ? 'var(--accent)' : 'transparent',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          color: 'white', fontSize: '10px', flexShrink: 0
        }}>
          {checked && '‚úì'}
        </span>
      );
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process {processNumber}</div>
            <h1 style={styles.title}>NAGMA</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
              Normal anion gap metabolic acidosis ‚Äî select likely cause(s):
            </div>
            
            {/* GI losses */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '8px' }}>GI bicarbonate loss</div>
            <div style={itemStyle(causes.includes('diarrhoea'))} onClick={() => toggleCause('diarrhoea')}>
              {checkMark(causes.includes('diarrhoea'))}
              <span>Diarrhoea / fistulae / high-output ileostomy</span>
            </div>
            
            {/* RTA */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Renal tubular acidosis</div>
            <div style={itemStyle(causes.includes('rta'))} onClick={() => toggleCause('rta')}>
              {checkMark(causes.includes('rta'))}
              <span>RTA (Type 1, 2, or 4)</span>
            </div>
            
            {/* Chloride excess */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Chloride excess</div>
            <div style={itemStyle(causes.includes('saline'))} onClick={() => toggleCause('saline')}>
              {checkMark(causes.includes('saline'))}
              <span>0.9% saline / TPN / hyperchloraemia</span>
            </div>
            
            {/* Other */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Other</div>
            <div style={itemStyle(causes.includes('ckd'))} onClick={() => toggleCause('ckd')}>
              {checkMark(causes.includes('ckd'))}
              <span>Early renal failure</span>
            </div>
            <div style={itemStyle(causes.includes('post_dka'))} onClick={() => toggleCause('post_dka')}>
              {checkMark(causes.includes('post_dka'))}
              <span>Post-DKA recovery</span>
            </div>
            <div style={itemStyle(causes.includes('acetazolamide'))} onClick={() => toggleCause('acetazolamide')}>
              {checkMark(causes.includes('acetazolamide'))}
              <span>Acetazolamide</span>
            </div>
            
            {/* UAG info - expandable */}
            <button 
              style={{ ...styles.buttonSmall, marginTop: '12px', width: '100%', justifyContent: 'center', fontSize: '11px', padding: '6px' }}
              onClick={() => setShowUAG(!showUAG)}
            >
              {showUAG ? 'Hide' : 'Show'} UAG & RTA differentiation
            </button>
            
            {/* UAG expandable section - inline */}
            {showUAG && (
              <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '6px' }}>
                  Urine anion gap helps differentiate GI loss vs RTA:
                </div>
                <div style={{ padding: '6px 8px', background: 'var(--bg-tertiary)', borderRadius: '4px', marginBottom: '6px', fontSize: '11px' }}>
                  <Formula>UAG = Urine Na + Urine K ‚àí Urine Cl</Formula>
                </div>
                <div style={{ display: 'flex', gap: '6px', marginBottom: '8px' }}>
                  <div style={{ flex: 1, padding: '6px', background: 'var(--success-light)', borderRadius: '4px', fontSize: '10px' }}>
                    <div style={{ fontWeight: '600' }}>Negative UAG</div>
                    <div style={{ color: 'var(--text-secondary)' }}>GI loss (‚ÜëNH‚ÇÑ‚Å∫)</div>
                  </div>
                  <div style={{ flex: 1, padding: '6px', background: 'var(--warning-light)', borderRadius: '4px', fontSize: '10px' }}>
                    <div style={{ fontWeight: '600' }}>Positive UAG</div>
                    <div style={{ color: 'var(--text-secondary)' }}>RTA (‚ÜìNH‚ÇÑ‚Å∫)</div>
                  </div>
                </div>
                <div style={{ fontSize: '10px', color: 'var(--text-secondary)', lineHeight: '1.5' }}>
                  <strong>Type 1:</strong> pH &gt;5.5, ‚ÜìK‚Å∫ ‚Ä¢ <strong>Type 2:</strong> Variable pH, ‚ÜìK‚Å∫ ‚Ä¢ <strong>Type 4:</strong> pH &lt;5.5, <strong>‚ÜëK‚Å∫</strong>
                </div>
              </div>
            )}
          </div>

          <button
            className="animate-in stagger-2"
            style={styles.button}
            onClick={onNext}
          >
            Continue ‚Üí
          </button>
        </div>
      );
    };

    // Process Screen: Metabolic Alkalosis
    const MetAlkalosisScreen = ({ data, setData, onNext, onBack, processNumber }) => {
      const [showContraction, setShowContraction] = useState(false);
      
      const causes = data.identifiedCauses?.metAlk || [];
      const toggleCause = (cause) => {
        const current = data.identifiedCauses?.metAlk || [];
        const updated = current.includes(cause) 
          ? current.filter(c => c !== cause)
          : [...current, cause];
        setData(prev => ({ ...prev, identifiedCauses: { ...prev.identifiedCauses, metAlk: updated }}));
      };
      
      // Selectable item style
      const itemStyle = (checked) => ({
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        padding: '8px 10px',
        marginBottom: '4px',
        background: checked ? 'var(--accent-light)' : 'var(--bg-tertiary)',
        border: checked ? '1px solid var(--accent)' : '1px solid transparent',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '12px',
      });
      
      const checkMark = (checked) => (
        <span style={{ 
          width: '14px', height: '14px', borderRadius: '3px',
          border: checked ? 'none' : '2px solid var(--border)',
          background: checked ? 'var(--accent)' : 'transparent',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          color: 'white', fontSize: '10px', flexShrink: 0
        }}>
          {checked && '‚úì'}
        </span>
      );
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process {processNumber}</div>
            <h1 style={styles.title}>Metabolic Alkalosis</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
              Select likely cause(s):
            </div>
            
            {/* H+ loss from GIT */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px' }}>Loss of H‚Å∫ from GIT</div>
            <div style={itemStyle(causes.includes('vomiting'))} onClick={() => toggleCause('vomiting')}>
              {checkMark(causes.includes('vomiting'))}
              <span>Vomiting / NG suction</span>
            </div>
            
            {/* H+ loss from kidneys */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Loss of H‚Å∫ from kidneys</div>
            <div style={itemStyle(causes.includes('diuretics'))} onClick={() => toggleCause('diuretics')}>
              {checkMark(causes.includes('diuretics'))}
              <span>Loop or thiazide diuretics</span>
            </div>
            <div style={itemStyle(causes.includes('mineralocorticoid'))} onClick={() => toggleCause('mineralocorticoid')}>
              {checkMark(causes.includes('mineralocorticoid'))}
              <span>Mineralocorticoid excess (Conn's, Cushing's, steroids)</span>
            </div>
            
            {/* Gain of HCO3 */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Gain of HCO‚ÇÉ‚Åª</div>
            <div style={itemStyle(causes.includes('bicarb'))} onClick={() => toggleCause('bicarb')}>
              {checkMark(causes.includes('bicarb'))}
              <span>NaHCO‚ÇÉ / citrate (CRRT, transfusion)</span>
            </div>
            
            {/* Other */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Other</div>
            <div style={itemStyle(causes.includes('hypokalaemia'))} onClick={() => toggleCause('hypokalaemia')}>
              {checkMark(causes.includes('hypokalaemia'))}
              <span>Severe hypokalaemia (intracellular H‚Å∫ shift)</span>
            </div>
            <div style={{ ...itemStyle(causes.includes('contraction')), justifyContent: 'space-between' }} onClick={() => toggleCause('contraction')}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                {checkMark(causes.includes('contraction'))}
                <span>Contraction alkalosis</span>
              </div>
              <button 
                onClick={(e) => { e.stopPropagation(); setShowContraction(true); }}
                style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', padding: '2px' }}
              >
                ‚ìò
              </button>
            </div>
          </div>
          
          <div style={styles.card} className="animate-in stagger-2">
            <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '6px' }}>
              Spot urine chloride helps differentiate:
            </div>
            <div style={{ display: 'flex', gap: '6px' }}>
              <div style={{ flex: 1, padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px', fontSize: '11px' }}>
                <div style={{ fontWeight: '600', marginBottom: '2px' }}>Cl‚Åª &lt;20</div>
                <div style={{ color: 'var(--text-secondary)' }}>Vomiting, NG, remote diuretics</div>
              </div>
              <div style={{ flex: 1, padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px', fontSize: '11px' }}>
                <div style={{ fontWeight: '600', marginBottom: '2px' }}>Cl‚Åª &gt;20</div>
                <div style={{ color: 'var(--text-secondary)' }}>Mineralocorticoid, current diuretics</div>
              </div>
            </div>
          </div>
          
          {/* Contraction alkalosis info sheet */}
          {showContraction && (
            <div style={{
              position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
              background: 'rgba(0,0,0,0.5)', zIndex: 1000,
              display: 'flex', alignItems: 'flex-end', justifyContent: 'center'
            }} onClick={() => setShowContraction(false)}>
              <div 
                style={{
                  background: 'var(--bg-primary)', borderRadius: '16px 16px 0 0',
                  padding: '20px', maxWidth: '500px', width: '100%',
                  maxHeight: '70vh', overflow: 'auto',
                  animation: 'slideUp 0.3s ease-out'
                }}
                onClick={e => e.stopPropagation()}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: '600', margin: 0 }}>Contraction Alkalosis</h3>
                  <button onClick={() => setShowContraction(false)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: 'var(--text-secondary)' }}>√ó</button>
                </div>
                <div style={{ fontSize: '13px', lineHeight: '1.7', color: 'var(--text-secondary)' }}>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Initial mechanism</strong></p>
                  <p>When ECF volume contracts (vomiting, diuretics, dehydration), the existing HCO‚ÇÉ‚Åª pool becomes concentrated in a smaller volume, raising [HCO‚ÇÉ‚Åª]. Additionally, loss of Cl‚Åª-rich fluid (gastric or urine) directly increases [HCO‚ÇÉ‚Åª] to maintain electroneutrality.</p>
                  
                  <p style={{ marginTop: '12px' }}><strong style={{ color: 'var(--text-primary)' }}>Maintenance mechanisms</strong></p>
                  <p>The kidneys would normally excrete excess HCO‚ÇÉ‚Åª, but in volume depletion several factors prevent this:</p>
                  <ul style={{ paddingLeft: '20px', marginTop: '4px' }}>
                    <li>‚Üë Proximal tubule Na‚Å∫/HCO‚ÇÉ‚Åª co-reabsorption (avid Na‚Å∫ retention)</li>
                    <li>‚Üì GFR reduces the filtered HCO‚ÇÉ‚Åª load available for excretion</li>
                    <li>‚Üë Aldosterone ‚Üí ‚Üë distal H‚Å∫ secretion ‚Üí generates new HCO‚ÇÉ‚Åª</li>
                    <li>Hypokalaemia (common) shifts H‚Å∫ into cells and ‚Üë renal H‚Å∫ secretion</li>
                    <li>Cl‚Åª depletion limits ability to excrete HCO‚ÇÉ‚Åª (need Cl‚Åª for exchange)</li>
                  </ul>
                  
                  <p style={{ marginTop: '12px' }}><strong style={{ color: 'var(--text-primary)' }}>Clinical clue</strong></p>
                  <p>Urine Cl‚Åª &lt;20 mmol/L indicates a "chloride-responsive" alkalosis ‚Äî the kidneys are avidly retaining Cl‚Åª because of volume depletion.</p>
                </div>
              </div>
            </div>
          )}

          <button
            className="animate-in stagger-3"
            style={styles.button}
            onClick={onNext}
          >
            Continue ‚Üí
          </button>
        </div>
      );
    };

    // Process Screen: Respiratory Acidosis
    const RespAcidosisScreen = ({ data, setData, onNext, onBack, processNumber }) => {
      const causes = data.identifiedCauses?.respAcid || [];
      const toggleCause = (cause) => {
        const current = data.identifiedCauses?.respAcid || [];
        const updated = current.includes(cause) 
          ? current.filter(c => c !== cause)
          : [...current, cause];
        setData(prev => ({ ...prev, identifiedCauses: { ...prev.identifiedCauses, respAcid: updated }}));
      };
      
      // Selectable item style
      const itemStyle = (checked) => ({
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        padding: '8px 10px',
        marginBottom: '4px',
        background: checked ? 'var(--accent-light)' : 'var(--bg-tertiary)',
        border: checked ? '1px solid var(--accent)' : '1px solid transparent',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '12px',
      });
      
      const checkMark = (checked) => (
        <span style={{ 
          width: '14px', height: '14px', borderRadius: '3px',
          border: checked ? 'none' : '2px solid var(--border)',
          background: checked ? 'var(--accent)' : 'transparent',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          color: 'white', fontSize: '10px', flexShrink: 0
        }}>
          {checked && '‚úì'}
        </span>
      );
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process {processNumber}</div>
            <h1 style={styles.title}>Resp. Acidosis</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
              Hypoventilation ‚Äî select likely cause(s):
            </div>
            
            {/* Reduced central drive */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px' }}>Reduced central drive</div>
            <div style={itemStyle(causes.includes('opioids'))} onClick={() => toggleCause('opioids')}>
              {checkMark(causes.includes('opioids'))}
              <span>Opioids / sedatives / anaesthesia</span>
            </div>
            <div style={itemStyle(causes.includes('ohs'))} onClick={() => toggleCause('ohs')}>
              {checkMark(causes.includes('ohs'))}
              <span>OHS / brainstem pathology / severe hypothyroidism</span>
            </div>
            
            {/* Neuromuscular */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Neuromuscular weakness</div>
            <div style={itemStyle(causes.includes('neuro'))} onClick={() => toggleCause('neuro')}>
              {checkMark(causes.includes('neuro'))}
              <span>GBS, MG, MND, critical illness myopathy, spinal injury</span>
            </div>
            
            {/* Chest wall/pleural */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Chest wall / pleural</div>
            <div style={itemStyle(causes.includes('chest_wall'))} onClick={() => toggleCause('chest_wall')}>
              {checkMark(causes.includes('chest_wall'))}
              <span>Flail chest, kyphoscoliosis, effusion, pneumothorax</span>
            </div>
            
            {/* Airways/parenchyma */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Airways / parenchyma</div>
            <div style={itemStyle(causes.includes('copd'))} onClick={() => toggleCause('copd')}>
              {checkMark(causes.includes('copd'))}
              <span>COPD / severe asthma / severe pneumonia / ARDS (late)</span>
            </div>
            
            {/* Iatrogenic */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Iatrogenic</div>
            <div style={itemStyle(causes.includes('vent'))} onClick={() => toggleCause('vent')}>
              {checkMark(causes.includes('vent'))}
              <span>Mechanical ventilation (‚ÜìMV, permissive hypercapnia)</span>
            </div>
          </div>

          <button className="animate-in stagger-2" style={styles.button} onClick={onNext}>
            Continue ‚Üí
          </button>
        </div>
      );
    };

    // Process Screen: Respiratory Alkalosis
    const RespAlkalosisScreen = ({ data, setData, onNext, onBack, processNumber }) => {
      const causes = data.identifiedCauses?.respAlk || [];
      const toggleCause = (cause) => {
        const current = data.identifiedCauses?.respAlk || [];
        const updated = current.includes(cause) 
          ? current.filter(c => c !== cause)
          : [...current, cause];
        setData(prev => ({ ...prev, identifiedCauses: { ...prev.identifiedCauses, respAlk: updated }}));
      };
      
      // Selectable item style
      const itemStyle = (checked) => ({
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        padding: '8px 10px',
        marginBottom: '4px',
        background: checked ? 'var(--accent-light)' : 'var(--bg-tertiary)',
        border: checked ? '1px solid var(--accent)' : '1px solid transparent',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '12px',
      });
      
      const checkMark = (checked) => (
        <span style={{ 
          width: '14px', height: '14px', borderRadius: '3px',
          border: checked ? 'none' : '2px solid var(--border)',
          background: checked ? 'var(--accent)' : 'transparent',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          color: 'white', fontSize: '10px', flexShrink: 0
        }}>
          {checked && '‚úì'}
        </span>
      );
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process {processNumber}</div>
            <h1 style={styles.title}>Resp. Alkalosis</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
              Hyperventilation ‚Äî select likely cause(s):
            </div>
            
            {/* Hypoxaemia-driven */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px' }}>Hypoxaemia-driven</div>
            <div style={itemStyle(causes.includes('hypoxia'))} onClick={() => toggleCause('hypoxia')}>
              {checkMark(causes.includes('hypoxia'))}
              <span>Pneumonia, PE, pulmonary oedema, ILD, altitude, anaemia</span>
            </div>
            
            {/* Central stimulation */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Central stimulation</div>
            <div style={itemStyle(causes.includes('anxiety'))} onClick={() => toggleCause('anxiety')}>
              {checkMark(causes.includes('anxiety'))}
              <span>Pain / anxiety / panic</span>
            </div>
            <div style={itemStyle(causes.includes('sepsis'))} onClick={() => toggleCause('sepsis')}>
              {checkMark(causes.includes('sepsis'))}
              <span>Sepsis / fever</span>
            </div>
            <div style={itemStyle(causes.includes('cns'))} onClick={() => toggleCause('cns')}>
              {checkMark(causes.includes('cns'))}
              <span>CNS pathology (stroke, infection, tumour)</span>
            </div>
            
            {/* Hormonal/metabolic */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Hormonal / metabolic</div>
            <div style={itemStyle(causes.includes('liver'))} onClick={() => toggleCause('liver')}>
              {checkMark(causes.includes('liver'))}
              <span>Hepatic encephalopathy</span>
            </div>
            <div style={itemStyle(causes.includes('pregnancy'))} onClick={() => toggleCause('pregnancy')}>
              {checkMark(causes.includes('pregnancy'))}
              <span>Pregnancy</span>
            </div>
            
            {/* Iatrogenic */}
            <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '4px', marginTop: '12px' }}>Iatrogenic</div>
            <div style={itemStyle(causes.includes('ventilation'))} onClick={() => toggleCause('ventilation')}>
              {checkMark(causes.includes('ventilation'))}
              <span>Mechanical overventilation</span>
            </div>
          </div>
          
          <div style={styles.card} className="animate-in stagger-2">
            <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
              <strong style={{ color: 'var(--text-primary)' }}>Tip:</strong> If hypoxaemic, respiratory alkalosis may be appropriate compensation. If normoxic, look for central causes.
            </div>
          </div>

          <button className="animate-in stagger-3" style={styles.button} onClick={onNext}>
            Continue ‚Üí
          </button>
        </div>
      );
    };

    // Summary Screen
    const SummaryScreen = ({ data, processes, approach, onRestart, onSwitchToStewart, onBack }) => {
      const [copied, setCopied] = useState(false);
      
      // Cause label mappings
      const causeLabels = {
        // HAGMA causes (auto-derived from lactate/ketones)
        lactate: 'Lactataemia',
        ketones: 'Ketosis',
        toxic_alcohol: 'Toxic alcohol (‚ÜëOG)',
        unexplained: 'Unexplained anions‚Åª',
        // Unexplained anions causes
        renal: 'Renal failure',
        pyroglutamic: 'Pyroglutamic acidosis',
        salicylate: 'Salicylate',
        dlactate: 'D-lactate',
        // NAGMA causes
        diarrhoea: 'Diarrhoea / GI losses',
        rta: 'Renal tubular acidosis',
        saline: '0.9% saline / hyperchloraemia',
        ckd: 'Early renal failure',
        post_dka: 'Post-DKA recovery',
        acetazolamide: 'Acetazolamide',
        // Met Alk causes
        vomiting: 'Vomiting / NG suction',
        diuretics: 'Diuretics',
        mineralocorticoid: 'Mineralocorticoid excess',
        bicarb: 'NaHCO‚ÇÉ / citrate',
        hypokalaemia: 'Severe hypokalaemia',
        contraction: 'Contraction alkalosis',
        // Resp Acidosis causes
        opioids: 'Opioids / sedatives',
        neuro: 'Neuromuscular weakness',
        copd: 'COPD / severe asthma',
        ohs: 'OHS',
        chest_wall: 'Chest wall / pleural',
        cns: 'CNS / brainstem',
        vent: 'Mechanical ventilation',
        // Resp Alkalosis causes
        hypoxia: 'Hypoxaemia',
        anxiety: 'Pain / anxiety',
        sepsis: 'Sepsis / fever',
        liver: 'Hepatic encephalopathy',
        ventilation: 'Overventilation',
        pregnancy: 'Pregnancy',
      };
      
      // Build HAGMA causes from lactate/ketones
      const getHAGMACauses = () => {
        const causes = [];
        const lactateVal = data.lactate ? parseFloat(data.lactate) : null;
        const ketonesVal = data.ketones ? parseFloat(data.ketones) : null;
        if (lactateVal && lactateVal > 2) causes.push('lactate');
        if (ketonesVal && ketonesVal > 0.6) causes.push('ketones');
        if (data.osmGapElevated) causes.push('toxic_alcohol');
        return causes;
      };
      
      const generateRecordText = () => {
        const ag = parseFloat(data.correctedAG).toFixed(0);
        const processLabels = processes.map(p => p.label).join(', ');
        
        let interpretation = `Primary: ${data.primaryDisorder || processLabels}`;
        if (data.isHAGMA) interpretation += ` (AG ${ag})`;
        if (data.compensationResult) interpretation += `. ${data.compensationResult}`;
        if (data.deltaInterpretation && data.deltaInterpretation !== 'No additional disorder') {
          interpretation += `. Delta ratio: ${data.deltaInterpretation}`;
        }
        
        // Include identified causes in copy text
        const allCauses = [];
        if (data.isHAGMA) {
          const hagmaCauses = getHAGMACauses();
          if (hagmaCauses.length > 0) allCauses.push(...hagmaCauses.map(c => causeLabels[c]));
        }
        const ic = data.identifiedCauses || {};
        if (ic.nagma?.length > 0) allCauses.push(...ic.nagma.map(c => causeLabels[c]));
        if (ic.metAlk?.length > 0) allCauses.push(...ic.metAlk.map(c => causeLabels[c]));
        if (ic.respAcid?.length > 0) allCauses.push(...ic.respAcid.map(c => causeLabels[c]));
        if (ic.respAlk?.length > 0) allCauses.push(...ic.respAlk.map(c => causeLabels[c]));
        if (ic.unexplained?.length > 0) allCauses.push(...ic.unexplained.map(c => causeLabels[c]));
        
        let text = `ABG Analysis: pH ${data.pH} | pCO‚ÇÇ ${data.paCO2} | HCO‚ÇÉ ${data.hco3}. ${interpretation}`;
        if (allCauses.length > 0) text += `. Causes: ${allCauses.join(', ')}.`;
        
        return text;
      };
      
      const copyToClipboard = () => {
        navigator.clipboard.writeText(generateRecordText()).then(() => {
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        });
      };
      
      // Check if any causes have been identified
      const ic = data.identifiedCauses || {};
      const hagmaCauses = data.isHAGMA ? getHAGMACauses() : [];
      const hasAnyCauses = hagmaCauses.length > 0 || 
        (ic.nagma?.length > 0) || 
        (ic.metAlk?.length > 0) || 
        (ic.respAcid?.length > 0) || 
        (ic.respAlk?.length > 0) ||
        (ic.unexplained?.length > 0);
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Complete</div>
            <h1 style={styles.title}>Summary</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={styles.cardTitle}>Acid-Base Analysis</div>
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              {processes.map((p, i) => {
                // Get causes for this process type
                let processCauses = [];
                if (p.type === 'hagma') {
                  processCauses = hagmaCauses.map(c => causeLabels[c]);
                  // Add unexplained causes if any selected
                  if (ic.unexplained?.length > 0) {
                    processCauses.push(...ic.unexplained.map(c => causeLabels[c]));
                  }
                } else if (p.type === 'nagma' && ic.nagma?.length > 0) {
                  processCauses = ic.nagma.map(c => causeLabels[c]);
                } else if (p.type === 'metalkalosis' && ic.metAlk?.length > 0) {
                  processCauses = ic.metAlk.map(c => causeLabels[c]);
                } else if (p.type === 'respacidosis' && ic.respAcid?.length > 0) {
                  processCauses = ic.respAcid.map(c => causeLabels[c]);
                } else if (p.type === 'respalkalosis' && ic.respAlk?.length > 0) {
                  processCauses = ic.respAlk.map(c => causeLabels[c]);
                }
                
                return (
                  <div key={i} style={{ marginBottom: i < processes.length - 1 ? '12px' : 0 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <span style={{ color: 'var(--success)', fontSize: '16px' }}>‚úì</span>
                      <span style={{ fontWeight: '500' }}>{p.label}</span>
                    </div>
                    {processCauses.length > 0 && (
                      <div style={{ paddingLeft: '24px', marginTop: '4px' }}>
                        {processCauses.map((cause, j) => (
                          <div key={j} style={{ fontSize: '13px', color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <span style={{ color: 'var(--accent)', fontSize: '10px' }}>‚ñ∏</span>
                            <span>{cause}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            
            {/* HAGMA breakdown if applicable */}
            {data.isHAGMA && (
              <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                {approach === 'stewart' ? (
                  // Stewart approach: use SIG
                  <>
                    <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                      Strong ion gap breakdown (SIG {parseFloat(data.SIG || 0).toFixed(1)} mEq/L):
                    </div>
                    <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '8px' }}>
                      Note: Lactate is already accounted for in SIDa. SIG represents other unmeasured anions<sup>‚àí</sup>.
                    </div>
                    <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
                      {(() => {
                        const sig = parseFloat(data.SIG) || 0;
                        const ketonesVal = data.ketones ? parseFloat(data.ketones) : null;
                        // Ketones still contribute ~0.6 baseline
                        const ketoneContrib = ketonesVal && ketonesVal > 0.6 ? ketonesVal - 0.6 : 0;
                        const unexplained = Math.max(0, sig - ketoneContrib);
                        const ogElevated = data.osmGapElevated;
                        const ogValue = data.osmGapValue;
                        
                        const items = [];
                        if (ketoneContrib > 0) {
                          items.push(<div key="ketones" style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>Ketones ({ketonesVal} mmol/L)</span>
                            <span style={{ fontWeight: '500' }}>+{ketoneContrib.toFixed(1)}</span>
                          </div>);
                        }
                        if (unexplained >= 2 || ketoneContrib === 0) {
                          if (ogElevated) {
                            items.push(<div key="other" style={{ display: 'flex', justifyContent: 'space-between', color: 'var(--warning)' }}>
                              <span>Other (‚ÜëOG {ogValue?.toFixed(0)} ‚Äî toxic alcohol?)</span>
                              <span style={{ fontWeight: '500' }}>+{unexplained.toFixed(1)}</span>
                            </div>);
                          } else {
                            items.push(<div key="other" style={{ display: 'flex', justifyContent: 'space-between', color: unexplained >= 2 ? 'var(--text-primary)' : 'var(--text-secondary)' }}>
                              <span>Other unmeasured anions<sup>‚àí</sup></span>
                              <span style={{ fontWeight: '500' }}>+{unexplained.toFixed(1)}</span>
                            </div>);
                          }
                        }
                        if (items.length === 0) {
                          items.push(<div key="explained" style={{ color: 'var(--success)' }}>SIG adequately explained</div>);
                        }
                        return items;
                      })()}
                    </div>
                  </>
                ) : (
                  // Traditional approach: use AG
                  <>
                    <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                      Anion gap breakdown (AG {parseFloat(data.correctedAG).toFixed(0)}, excess +{(parseFloat(data.correctedAG) - 12).toFixed(1)}):
                    </div>
                    <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
                      {(() => {
                        const lactateVal = data.lactate ? parseFloat(data.lactate) : null;
                        const ketonesVal = data.ketones ? parseFloat(data.ketones) : null;
                        const lactateContrib = lactateVal && lactateVal > 1 ? lactateVal - 1 : 0;
                        const ketoneContrib = ketonesVal && ketonesVal > 0.6 ? ketonesVal - 0.6 : 0;
                        const excessAG = parseFloat(data.correctedAG) - 12;
                        const unexplained = Math.max(0, excessAG - lactateContrib - ketoneContrib);
                        const ogElevated = data.osmGapElevated;
                        const ogValue = data.osmGapValue;
                        
                        const items = [];
                        if (lactateContrib > 0) {
                          items.push(<div key="lactate" style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>Lactate ({lactateVal} mmol/L)</span>
                            <span style={{ fontWeight: '500' }}>+{lactateContrib.toFixed(1)}</span>
                          </div>);
                        }
                        if (ketoneContrib > 0) {
                          items.push(<div key="ketones" style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>Ketones ({ketonesVal} mmol/L)</span>
                            <span style={{ fontWeight: '500' }}>+{ketoneContrib.toFixed(1)}</span>
                          </div>);
                        }
                        if (unexplained >= 2 || (lactateContrib === 0 && ketoneContrib === 0)) {
                          if (ogElevated) {
                            items.push(<div key="other" style={{ display: 'flex', justifyContent: 'space-between', color: 'var(--warning)' }}>
                              <span>Other (‚ÜëOG {ogValue?.toFixed(0)} ‚Äî toxic alcohol?)</span>
                              <span style={{ fontWeight: '500' }}>+{unexplained.toFixed(1)}</span>
                            </div>);
                          } else {
                            items.push(<div key="other" style={{ display: 'flex', justifyContent: 'space-between', color: unexplained >= 2 ? 'var(--text-primary)' : 'var(--text-secondary)' }}>
                              <span>Other/unexplained</span>
                              <span style={{ fontWeight: '500' }}>+{unexplained.toFixed(1)}</span>
                            </div>);
                          }
                        }
                        return items;
                      })()}
                    </div>
                  </>
                )}
              </div>
            )}
          </div>

          <button
            className="animate-in stagger-2"
            style={{ ...styles.button, marginTop: '12px', background: 'var(--bg-tertiary)', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}
            onClick={copyToClipboard}
          >
            {copied ? '‚úì Copied to clipboard' : 'üìã Copy for medical record'}
          </button>

          {approach === 'traditional' && (
            <button
              className="animate-in stagger-2"
              style={{ ...styles.button, marginTop: '8px' }}
              onClick={onSwitchToStewart}
            >
              Analyse with physicochemical model ‚Üí
            </button>
          )}

          <button
            className="animate-in stagger-2"
            style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '8px' }}
            onClick={onRestart}
          >
            New Analysis
          </button>

          <div style={{ textAlign: 'center', padding: '12px 16px 8px', fontSize: '11px', color: 'var(--text-tertiary)' }}>
            For educational purposes only.<br/><span style={{ fontSize: '13px', fontWeight: '500' }}>¬© 2025 Scott Santinon</span>
          </div>
        </div>
      );
    };

    // ============================================
    // DKA/HHS MONITOR
    // ============================================
    
    // Helper: Corrected sodium (Australian standard - RCH Melbourne)
    const calcCorrectedNa = (na, glucose) => {
      if (!na || !glucose) return null;
      // Corrected Na = measured Na + 0.3 √ó (glucose - 5.5)
      return na + 0.3 * (glucose - 5.5);
    };
    
    // Helper: Effective osmolality
    const calcEffectiveOsm = (na, glucose) => {
      if (!na || !glucose) return null;
      // Effective Osm = 2 √ó Na + glucose (mmol/L)
      return 2 * na + glucose;
    };
    
    const DKAHHSMonitor = ({ onBack }) => {
      const [activeTab, setActiveTab] = useState('calculators');
      
      // Shared inputs for current values
      const [currentGlucose, setCurrentGlucose] = useState('');
      const [currentNa, setCurrentNa] = useState('');
      
      // Presentation values (for trends)
      const [presentationGlucose, setPresentationGlucose] = useState('');
      const [presentationNa, setPresentationNa] = useState('');
      
      // Time inputs
      const [presentationTime, setPresentationTime] = useState('');
      const [currentTime, setCurrentTime] = useState('');
      
      // Fluid deficit inputs
      const [weight, setWeight] = useState('');
      const [tbwFactor, setTbwFactor] = useState('0.6');
      const [targetNa, setTargetNa] = useState('145');
      
      // Parse inputs
      const glucNow = parseFloat(currentGlucose) || null;
      const naNow = parseFloat(currentNa) || null;
      const glucPresent = parseFloat(presentationGlucose) || null;
      const naPresent = parseFloat(presentationNa) || null;
      
      // Current calculator results
      const correctedNaNow = calcCorrectedNa(naNow, glucNow);
      const effectiveOsmNow = calcEffectiveOsm(naNow, glucNow);
      
      // Presentation calculator results
      const correctedNaPresent = calcCorrectedNa(naPresent, glucPresent);
      const effectiveOsmPresent = calcEffectiveOsm(naPresent, glucPresent);
      
      // Fluid deficit
      const weightVal = parseFloat(weight) || null;
      const tbwFactorVal = parseFloat(tbwFactor) || 0.6;
      const targetNaVal = parseFloat(targetNa) || 145;
      const tbw = weightVal ? weightVal * tbwFactorVal : null;
      // Free water deficit only makes sense if Na is elevated
      const canCalcFluidDeficit = tbw && correctedNaNow && correctedNaNow > targetNaVal;
      const freeWaterDeficit = canCalcFluidDeficit ? tbw * (correctedNaNow / targetNaVal - 1) : null;
      
      // Calculate hours between times
      const calcHoursBetween = () => {
        if (!presentationTime || !currentTime) return null;
        const start = new Date(presentationTime);
        const end = new Date(currentTime);
        const diffMs = end - start;
        if (diffMs <= 0) return null;
        return diffMs / (1000 * 60 * 60);
      };
      
      const dt = calcHoursBetween();
      
      // Set current time to now
      const setNow = () => {
        const now = new Date();
        const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        setCurrentTime(localISOTime);
      };
      
      // Trend calculations
      const canCalcGlucoseTrend = dt > 0 && glucPresent !== null && glucNow !== null;
      const canCalcOsmTrend = dt > 0 && effectiveOsmPresent !== null && effectiveOsmNow !== null;
      const canCalcNaTrend = dt > 0 && correctedNaPresent !== null && correctedNaNow !== null;
      
      const deltaGlucose = canCalcGlucoseTrend ? glucPresent - glucNow : null; // positive if falling
      const rateGlucose = canCalcGlucoseTrend ? deltaGlucose / dt : null;
      
      const deltaOsm = canCalcOsmTrend ? effectiveOsmPresent - effectiveOsmNow : null; // positive if falling
      const rateOsm = canCalcOsmTrend ? deltaOsm / dt : null;
      
      const deltaNaCorr = canCalcNaTrend ? correctedNaNow - correctedNaPresent : null; // positive if rising
      const equivChange24h = canCalcNaTrend ? deltaNaCorr * (24 / dt) : null;
      
      // Status functions
      const getGlucoseStatus = () => {
        if (!canCalcGlucoseTrend) return null;
        const rate = rateGlucose;
        if (rate < 0) return { status: 'Rising', color: 'var(--error)', level: 'error' };
        if (rate >= 2 && rate <= 4) return { status: 'On target (2‚Äì4 mmol/L/h)', color: 'var(--success)', level: 'success' };
        if ((rate >= 1 && rate < 2) || (rate > 4 && rate <= 5)) return { status: 'Monitor closely', color: 'var(--warning)', level: 'warning' };
        if (rate < 1) return { status: 'Too slow (<1 mmol/L/h)', color: 'var(--error)', level: 'error' };
        return { status: 'Too fast (>5 mmol/L/h)', color: 'var(--error)', level: 'error' };
      };
      
      const getOsmStatus = () => {
        if (!canCalcOsmTrend) return null;
        const rate = rateOsm;
        if (rate < 0) return { status: 'Rising', color: 'var(--warning)', level: 'warning' };
        if (rate <= 5) return { status: 'Safe (‚â§5 mOsm/kg/h)', color: 'var(--success)', level: 'success' };
        if (rate <= 8) return { status: 'Monitor closely', color: 'var(--warning)', level: 'warning' };
        return { status: 'Too fast (>8 mOsm/kg/h)', color: 'var(--error)', level: 'error' };
      };
      
      const getNaCorrStatus = () => {
        if (!canCalcNaTrend) return null;
        const absChange = Math.abs(equivChange24h);
        if (absChange <= 10) return { status: 'Safe (‚â§10 mmol/L/24h)', color: 'var(--success)', level: 'success' };
        if (absChange <= 12) return { status: 'Monitor closely', color: 'var(--warning)', level: 'warning' };
        return { status: 'Too fast (>12 mmol/L/24h)', color: 'var(--error)', level: 'error' };
      };
      
      const glucoseStatus = getGlucoseStatus();
      const osmStatus = getOsmStatus();
      const naCorrStatus = getNaCorrStatus();
      
      // Format hours nicely
      const formatDuration = (hours) => {
        if (!hours) return '';
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        if (m === 0) return `${h}h`;
        return `${h}h ${m}m`;
      };
      
      const inputStyle = {
        width: '100%',
        padding: '10px 12px',
        border: '1px solid var(--border-strong)',
        borderRadius: '8px',
        fontSize: '14px',
        fontFamily: 'var(--font)',
        color: 'var(--text-primary)',
        background: 'var(--bg-tertiary)',
        outline: 'none',
        boxSizing: 'border-box'
      };
      
      const tabBtnStyle = (active) => ({
        flex: 1,
        padding: '10px',
        background: active ? 'var(--accent)' : 'transparent',
        color: active ? 'white' : 'var(--text-secondary)',
        border: 'none',
        borderRadius: '8px',
        fontSize: '13px',
        fontWeight: '600',
        cursor: 'pointer',
        fontFamily: 'var(--font)'
      });
      
      const smallBtnStyle = (active) => ({
        flex: 1,
        padding: '6px 8px',
        background: active ? 'var(--accent-light)' : 'var(--bg-tertiary)',
        color: active ? 'var(--accent)' : 'var(--text-secondary)',
        border: '1px solid ' + (active ? 'var(--accent)' : 'var(--border)'),
        borderRadius: '6px',
        fontSize: '11px',
        fontWeight: '500',
        cursor: 'pointer',
        fontFamily: 'var(--font)'
      });
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}>
            <BackIcon /> Back
          </button>
          
          <div style={styles.header} className="animate-in">
            <h1 style={styles.title}>DKA/HHS Monitor</h1>
          </div>
          
          <div style={{ padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', marginBottom: '16px', fontSize: '11px', color: 'var(--text-secondary)' }} className="animate-in stagger-1">
            This tool supports interpretation only. Always follow your local DKA/HHS protocol and senior advice.
          </div>
          
          <div style={{ display: 'flex', gap: '4px', padding: '4px', background: 'var(--bg-tertiary)', borderRadius: '10px', marginBottom: '16px' }} className="animate-in stagger-1">
            <button style={tabBtnStyle(activeTab === 'calculators')} onClick={() => setActiveTab('calculators')}>
              Calculators
            </button>
            <button style={tabBtnStyle(activeTab === 'trends')} onClick={() => setActiveTab('trends')}>
              Trend Monitor
            </button>
          </div>
          
          {activeTab === 'calculators' && (
            <div>
              {/* Input card */}
              <div style={styles.card} className="animate-in stagger-2">
                <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px' }}>Current Values</div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                  <div>
                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Glucose (mmol/L)</div>
                    <input type="number" value={currentGlucose} onChange={(e) => setCurrentGlucose(e.target.value)} placeholder="20" style={inputStyle} />
                  </div>
                  <div>
                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Sodium (mmol/L)</div>
                    <input type="number" value={currentNa} onChange={(e) => setCurrentNa(e.target.value)} placeholder="140" style={inputStyle} />
                  </div>
                </div>
              </div>
              
              {/* Corrected sodium and Effective osmolality - side by side */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }} className="animate-in stagger-3">
                <div style={styles.card}>
                  <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '6px' }}>Corrected Na</div>
                  <div style={{ padding: '10px', background: correctedNaNow && correctedNaNow > 155 ? 'var(--error-light)' : 'var(--bg-tertiary)', borderRadius: '6px', textAlign: 'center' }}>
                    <div style={{ fontSize: '22px', fontWeight: '700' }}>{correctedNaNow ? correctedNaNow.toFixed(0) : '‚Äî'}</div>
                  </div>
                  {correctedNaNow && correctedNaNow > 155 && (
                    <div style={{ marginTop: '6px', fontSize: '10px', color: 'var(--error)' }}>
                      High ‚Äî free water deficit
                    </div>
                  )}
                </div>
                <div style={styles.card}>
                  <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '6px' }}>Effective Osm</div>
                  <div style={{ padding: '10px', background: effectiveOsmNow && effectiveOsmNow > 320 ? 'var(--warning-light)' : 'var(--bg-tertiary)', borderRadius: '6px', textAlign: 'center' }}>
                    <div style={{ fontSize: '22px', fontWeight: '700' }}>{effectiveOsmNow ? effectiveOsmNow.toFixed(0) : '‚Äî'}</div>
                  </div>
                  {effectiveOsmNow && effectiveOsmNow > 320 && (
                    <div style={{ marginTop: '6px', fontSize: '10px', color: 'var(--warning)' }}>
                      &gt;320 ‚Äî oedema risk
                    </div>
                  )}
                </div>
              </div>
              
              {/* Free water deficit */}
              <div style={styles.card} className="animate-in stagger-4">
                <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '10px' }}>Free Water Deficit</div>
                
                <div style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>Weight (kg)</div>
                    <input type="number" value={weight} onChange={(e) => setWeight(e.target.value)} placeholder="70" style={inputStyle} />
                  </div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>TBW factor</div>
                    <select 
                      value={tbwFactor} 
                      onChange={(e) => setTbwFactor(e.target.value)}
                      style={{ ...inputStyle, appearance: 'auto' }}
                    >
                      <option value="0.6">Male (0.6)</option>
                      <option value="0.5">Female (0.5)</option>
                      <option value="0.45">Elderly (0.45)</option>
                    </select>
                  </div>
                </div>
                
                {canCalcFluidDeficit ? (
                  <div style={{ padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Estimated deficit</span>
                    <span style={{ fontSize: '20px', fontWeight: '700', color: 'var(--warning)' }}>‚âà {freeWaterDeficit.toFixed(1)} L</span>
                  </div>
                ) : (
                  <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px', color: 'var(--text-tertiary)', textAlign: 'center' }}>
                    {!glucNow || !naNow ? 'Enter glucose and Na above' : correctedNaNow <= targetNaVal ? 'Na not elevated' : 'Enter weight'}
                  </div>
                )}
              </div>
            </div>
          )}
          
          {activeTab === 'trends' && (
            <div>
              {/* Time inputs - side by side */}
              <div style={styles.card} className="animate-in stagger-2">
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '4px' }}>
                  <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)' }}>Presentation</div>
                  <div style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)' }}>Now</div>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                  <input 
                    type="datetime-local" 
                    value={presentationTime} 
                    onChange={(e) => setPresentationTime(e.target.value)} 
                    style={{ ...inputStyle, fontSize: '12px', padding: '8px' }} 
                  />
                  <div style={{ display: 'flex', gap: '4px' }}>
                    <input 
                      type="datetime-local" 
                      value={currentTime} 
                      onChange={(e) => setCurrentTime(e.target.value)} 
                      style={{ ...inputStyle, flex: 1, fontSize: '12px', padding: '8px' }} 
                    />
                    <button 
                      onClick={setNow}
                      style={{
                        padding: '8px 10px',
                        background: 'var(--accent)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '11px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        fontFamily: 'var(--font)',
                      }}
                    >
                      Now
                    </button>
                  </div>
                </div>
                {dt !== null && (
                  <div style={{ marginTop: '8px', textAlign: 'center', fontSize: '13px' }}>
                    <span style={{ color: 'var(--text-secondary)' }}>Duration: </span>
                    <span style={{ fontWeight: '700', color: 'var(--accent)' }}>{formatDuration(dt)}</span>
                  </div>
                )}
              </div>
              
              {/* Values at presentation and current - compact */}
              <div style={styles.card} className="animate-in stagger-3">
                <div style={{ display: 'grid', gridTemplateColumns: '60px 1fr 1fr', gap: '8px', alignItems: 'center' }}>
                  <div></div>
                  <div style={{ fontSize: '10px', fontWeight: '600', color: 'var(--text-tertiary)', textAlign: 'center' }}>Presentation</div>
                  <div style={{ fontSize: '10px', fontWeight: '600', color: 'var(--text-tertiary)', textAlign: 'center' }}>Now</div>
                  
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Glucose</div>
                  <input type="number" value={presentationGlucose} onChange={(e) => setPresentationGlucose(e.target.value)} placeholder="30" style={{ ...inputStyle, padding: '8px', fontSize: '14px', textAlign: 'center' }} />
                  <input type="number" value={currentGlucose} onChange={(e) => setCurrentGlucose(e.target.value)} placeholder="18" style={{ ...inputStyle, padding: '8px', fontSize: '14px', textAlign: 'center' }} />
                  
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Na</div>
                  <input type="number" value={presentationNa} onChange={(e) => setPresentationNa(e.target.value)} placeholder="140" style={{ ...inputStyle, padding: '8px', fontSize: '14px', textAlign: 'center' }} />
                  <input type="number" value={currentNa} onChange={(e) => setCurrentNa(e.target.value)} placeholder="145" style={{ ...inputStyle, padding: '8px', fontSize: '14px', textAlign: 'center' }} />
                </div>
              </div>
              
              {/* Glucose trend */}
              {canCalcGlucoseTrend && (
                <div style={styles.card} className="animate-in stagger-4">
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                    <span style={{ fontSize: '13px', fontWeight: '600' }}>Glucose</span>
                    <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{glucPresent} ‚Üí {glucNow}</span>
                  </div>
                  <div style={{ padding: '8px 10px', background: glucoseStatus.level === 'success' ? 'var(--success-light)' : glucoseStatus.level === 'warning' ? 'var(--warning-light)' : 'var(--error-light)', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', fontWeight: '600', color: glucoseStatus.color }}>{glucoseStatus.status}</span>
                    <span style={{ fontSize: '14px', fontWeight: '700' }}>{rateGlucose >= 0 ? '‚àí' : '+'}{Math.abs(rateGlucose).toFixed(1)}/h</span>
                  </div>
                  {glucoseStatus.level === 'error' && rateGlucose < 0 && (
                    <div style={{ marginTop: '6px', fontSize: '11px', color: 'var(--text-secondary)', lineHeight: '1.4' }}>
                      Rising glucose ‚Äî check insulin delivery, consider stress/sepsis.
                    </div>
                  )}
                  {glucoseStatus.level === 'error' && rateGlucose > 5 && (
                    <div style={{ marginTop: '6px', fontSize: '11px', color: 'var(--text-secondary)', lineHeight: '1.4' }}>
                      Too fast ‚Äî consider reducing insulin to avoid cerebral oedema.
                    </div>
                  )}
                </div>
              )}
              
              {/* Osmolality trend - THE KEY PARAMETER */}
              {canCalcOsmTrend && (
                <div style={{ ...styles.card, border: '2px solid var(--accent)' }} className="animate-in stagger-4">
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                    <span style={{ fontSize: '13px', fontWeight: '600' }}>Effective Osmolality ‚≠ê</span>
                    <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{effectiveOsmPresent.toFixed(0)} ‚Üí {effectiveOsmNow.toFixed(0)}</span>
                  </div>
                  <div style={{ padding: '8px 10px', background: osmStatus.level === 'success' ? 'var(--success-light)' : osmStatus.level === 'warning' ? 'var(--warning-light)' : 'var(--error-light)', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', fontWeight: '600', color: osmStatus.color }}>{osmStatus.status}</span>
                    <span style={{ fontSize: '14px', fontWeight: '700' }}>{rateOsm >= 0 ? '‚àí' : '+'}{Math.abs(rateOsm).toFixed(1)}/h</span>
                  </div>
                  <div style={{ marginTop: '6px', fontSize: '11px', color: 'var(--text-secondary)', lineHeight: '1.4' }}>
                    {osmStatus.level === 'success' && 'Safe rate of correction.'}
                    {osmStatus.level === 'warning' && 'Approaching threshold ‚Äî monitor closely.'}
                    {osmStatus.level === 'error' && rateOsm > 5 && 'Too fast ‚Äî rapid osmolality fall creates gradient driving water into brain cells ‚Üí cerebral oedema. Slow fluids/insulin.'}
                    {osmStatus.level === 'error' && rateOsm < 0 && 'Rising osmolality ‚Äî patient becoming more dehydrated.'}
                  </div>
                </div>
              )}
              
              {!canCalcGlucoseTrend && !canCalcOsmTrend && (
                <div style={{ ...styles.card, textAlign: 'center' }} className="animate-in stagger-4">
                  <div style={{ fontSize: '13px', color: 'var(--text-tertiary)' }}>
                    Enter times and values above to see trends
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    // Pattern matching for syndromes
    const checkSyndromePatterns = (data) => {
      const syndromes = [];
      
      const na = parseFloat(data.na) || 140;
      const k = parseFloat(data.k) || 4;
      const ca = parseFloat(data.ca) || 1.15;
      const mg = parseFloat(data.mg) || 0.85;
      const phosphate = parseFloat(data.phosphate) || 1.1;
      const glucose = parseFloat(data.glucose);
      const lactate = parseFloat(data.lactate) || 1;
      // Include hidden HAGMA (elevated AG despite normal/alkalemic pH)
      const isHAGMA = data.isHAGMA;
      const isNAGMA = data.isMetabolic && data.isAcidosis && !data.isHAGMA;
      const isMetAlk = data.isMetabolic && data.isAlkalosis;
      
      // Adrenal insufficiency (Addison's): Hyponatraemia, Hyperkalaemia, NAGMA
      if (na < 135 && k > 5.0) {
        syndromes.push({
          name: "Adrenal Insufficiency",
          findings: ['Hyponatraemia', 'Hyperkalaemia', isNAGMA ? 'NAGMA' : null].filter(Boolean),
          note: 'Check random cortisol, ACTH stimulation test',
          urgency: 'high'
        });
      }
      
      // Hyperaldosteronism (Conn's): Hypokalaemia, possible hypernatraemia, Metabolic alkalosis
      if (k < 3.5 && isMetAlk) {
        syndromes.push({
          name: "Hyperaldosteronism / Cushing's",
          findings: ['Hypokalaemia', 'Metabolic alkalosis', na > 145 ? 'Hypernatraemia' : null].filter(Boolean),
          note: 'Check aldosterone:renin ratio, cortisol',
          urgency: 'medium'
        });
      }
      
      // Refeeding syndrome: Hypophosphataemia, Hypokalaemia, Hypomagnesaemia
      const lowPO4 = phosphate < 0.8;
      const lowK = k < 3.5;
      const lowMg = mg < 0.7;
      if ((lowPO4 && lowK) || (lowPO4 && lowMg) || (lowK && lowMg && lowPO4)) {
        syndromes.push({
          name: "Refeeding Syndrome",
          findings: [lowPO4 ? 'Hypophosphataemia' : null, lowK ? 'Hypokalaemia' : null, lowMg ? 'Hypomagnesaemia' : null].filter(Boolean),
          note: 'Consider recent nutritional rehabilitation or malnutrition',
          urgency: 'high'
        });
      }
      
      // Tumour lysis syndrome: Hyperkalaemia, Hypocalcaemia, Hyperphosphataemia, HAGMA
      if (k > 5.5 && ca < 1.0 && phosphate > 1.5) {
        syndromes.push({
          name: "Tumour Lysis Syndrome",
          findings: ['Hyperkalaemia', 'Hypocalcaemia', 'Hyperphosphataemia', isHAGMA ? 'HAGMA' : null].filter(Boolean),
          note: 'Check uric acid, LDH. Urgent oncology review',
          urgency: 'high'
        });
      }
      
      return syndromes;
    };

    // Syndrome Pattern Screen
    const SyndromeScreen = ({ data, syndromes, onContinue, onBack }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Pattern Match</div>
          <h1 style={styles.title}>Consider</h1>
        </div>

        <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '16px', textAlign: 'center' }} className="animate-in stagger-1">
          The electrolyte pattern may suggest:
        </div>

        {syndromes.map((syndrome, i) => (
          <div 
            key={i} 
            style={{
              ...styles.card,
              borderLeft: `3px solid ${syndrome.urgency === 'high' ? 'var(--error)' : 'var(--warning)'}`,
            }} 
            className={`animate-in stagger-${i + 2}`}
          >
            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '8px' }}>{syndrome.name}</div>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '10px' }}>
              {syndrome.findings.map((f, j) => (
                <span key={j} style={{
                  padding: '3px 8px',
                  background: 'var(--bg-tertiary)',
                  borderRadius: '4px',
                  fontSize: '12px',
                  color: 'var(--text-secondary)'
                }}>{f}</span>
              ))}
            </div>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
              {syndrome.note}
            </div>
          </div>
        ))}

        <button
          className="animate-in stagger-5"
          style={{ ...styles.button, marginTop: '16px' }}
          onClick={onContinue}
        >
          Continue to Differential ‚Üí
        </button>
      </div>
    );

    // Main Find Cause Controller
    const FindCauseScreen = ({ data, setData, approach, onBack, onRestart, onSwitchToStewart }) => {
      // For Stewart pathway, skip directly to summary - the analysis IS the endpoint
      const initialStep = approach === 'stewart' ? 'summary' : 'syndromes';
      const [currentStep, setCurrentStep] = useState(initialStep); // syndromes, overview, process-0, process-1, ..., summary
      
      // Check for syndromes
      const syndromes = checkSyndromePatterns(data);
      
      // Identify all processes
      const processes = [];
      const isMixedPrimary = data.isMetabolic && data.isRespiratory;
      
      // HAGMA - show workup for any elevated AG (including hidden HAGMA with normal/alkalemic pH)
      if (data.isHAGMA) {
        // Label reflects whether it's frank acidosis or hidden
        const hagmaLabel = data.isAcidosis 
          ? 'High anion gap metabolic acidosis'
          : 'Elevated anion gap (hidden HAGMA)';
        processes.push({ type: 'hagma', label: hagmaLabel });
        
        if (data.deltaInterpretation === 'Mixed HAGMA + NAGMA' || data.deltaInterpretation === 'Concurrent NAGMA') {
          processes.push({ type: 'nagma', label: 'Normal anion gap metabolic acidosis' });
        } else if (data.deltaInterpretation && data.deltaInterpretation.includes('metabolic alkalosis')) {
          processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
        }
      } else if (data.isMetabolic && data.isAcidosis) {
        processes.push({ type: 'nagma', label: 'Normal anion gap metabolic acidosis' });
      } else if (data.isMetabolic && data.isAlkalosis) {
        processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
      }
      
      if (data.isRespiratory) {
        if (data.isAcidosis || data.pHStatus === 'acidaemia' || (data.primaryDisorder && data.primaryDisorder.toLowerCase().includes('acidosis'))) {
          processes.push({ type: 'respacidosis', label: 'Respiratory acidosis' });
        }
        if (data.isAlkalosis || data.pHStatus === 'alkalaemia' || (data.primaryDisorder && data.primaryDisorder.toLowerCase().includes('alkalosis'))) {
          processes.push({ type: 'respalkalosis', label: 'Respiratory alkalosis' });
        }
      }
      
      if (!isMixedPrimary && data.compensationResult) {
        if (data.compensationResult.includes('Additional respiratory acidosis')) {
          processes.push({ type: 'respacidosis', label: 'Respiratory acidosis' });
        } else if (data.compensationResult.includes('Additional respiratory alkalosis')) {
          processes.push({ type: 'respalkalosis', label: 'Respiratory alkalosis' });
        } else if (data.compensationResult.includes('Additional metabolic acidosis')) {
          processes.push({ type: 'nagma', label: 'Metabolic acidosis' });
        } else if (data.compensationResult.includes('Additional metabolic alkalosis')) {
          processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
        }
      }
      
      const uniqueProcesses = processes.filter((d, i, arr) => arr.findIndex(x => x.type === d.type) === i);
      
      // Progress calculation: show smooth progress through differential phase
      // Overview = 40%, each process step = proportional, summary = 100%
      const numProcesses = Math.max(uniqueProcesses.length, 1);
      const getProgressPercent = () => {
        if (currentStep === 'syndromes') return 35;
        if (currentStep === 'overview') return 40;
        if (currentStep === 'summary') return 100;
        if (currentStep.startsWith('process-')) {
          const idx = parseInt(currentStep.split('-')[1]);
          // Progress from 45% to 95% across all processes
          const progressPerProcess = 50 / numProcesses;
          return 45 + (idx * progressPerProcess);
        }
        return 40;
      };
      
      // Navigation helpers
      const goToNextProcess = (currentIndex) => {
        if (currentIndex + 1 < uniqueProcesses.length) {
          setCurrentStep(`process-${currentIndex + 1}`);
        } else {
          setCurrentStep('summary');
        }
      };
      
      const goToPrevProcess = (currentIndex) => {
        if (currentIndex > 0) {
          setCurrentStep(`process-${currentIndex - 1}`);
        } else {
          setCurrentStep('overview');
        }
      };
      
      // Syndrome screen (shows first if syndromes detected)
      if (currentStep === 'syndromes') {
        if (syndromes.length === 0) {
          // Skip to overview if no syndromes
          setCurrentStep('overview');
          return null;
        }
        return (
          <>
            <ProgressBar percent={getProgressPercent()} />
            <SyndromeScreen 
              data={data}
              syndromes={syndromes}
              onContinue={() => setCurrentStep('overview')}
              onBack={onBack}
            />
          </>
        );
      }
      
      // Overview screen
      if (currentStep === 'overview') {
        const normalPH = data.pHStatus === 'normal';
        const hiddenHAGMA = normalPH && data.isHAGMA;
        
        return (
          <>
            <ProgressBar percent={getProgressPercent()} />
            <div style={styles.container}>
              <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
              
              <div style={styles.header} className="animate-in">
                <h1 style={styles.title}>Processes to Investigate</h1>
              </div>

              <div style={styles.card} className="animate-in stagger-1">
                <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                  {uniqueProcesses.map((d, i) => (
                    <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '6px 0' }}>
                      <span style={{ width: '24px', height: '24px', borderRadius: '50%', background: 'var(--accent)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '13px', fontWeight: '600' }}>{i + 1}</span>
                      <span>{d.label}</span>
                    </div>
                ))}
                {uniqueProcesses.length === 0 && (
                  <span style={{ color: 'var(--text-secondary)' }}>Normal acid-base status</span>
                )}
              </div>
            </div>

            {hiddenHAGMA && (
              <div style={{ ...styles.warningBox, margin: '0 0 16px 0' }} className="animate-in stagger-1">
                <strong>Hidden HAGMA detected</strong><br/>
                Normal pH with elevated anion gap ‚Äî suggests mixed disorder or early/compensated process
              </div>
            )}

            {uniqueProcesses.length > 0 ? (
              <button
                className="animate-in stagger-2"
                style={{ ...styles.button, marginTop: '20px' }}
                onClick={() => setCurrentStep('process-0')}
              >
                Begin Investigation ‚Üí
              </button>
            ) : (
              <>
                <div style={styles.card} className="animate-in stagger-2">
                  <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                    pH, HCO‚ÇÉ, PaCO‚ÇÇ, and anion gap are within normal limits.
                  </p>
                  <div style={styles.infoBox}>
                    If clinical suspicion remains, consider repeat testing or venous blood gas.
                  </div>
                </div>
                <button
                  className="animate-in stagger-3"
                  style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '20px' }}
                  onClick={onRestart}
                >
                  New Analysis
                </button>
              </>
            )}
          </div>
          </>
        );
      }
      
      // Summary screen
      if (currentStep === 'summary') {
        const lastProcessIndex = uniqueProcesses.length - 1;
        return (
          <>
            <ProgressBar percent={getProgressPercent()} />
            <SummaryScreen 
              data={data}
              processes={uniqueProcesses}
              approach={approach}
              onRestart={onRestart}
              onSwitchToStewart={onSwitchToStewart}
              onBack={() => lastProcessIndex >= 0 ? setCurrentStep(`process-${lastProcessIndex}`) : setCurrentStep('overview')}
            />
          </>
        );
      }
      
      // Process screens
      const processIndex = parseInt(currentStep.split('-')[1]);
      const currentProcess = uniqueProcesses[processIndex];
      const processNumber = processIndex + 1;
      
      if (!currentProcess) {
        setCurrentStep('summary');
        return null;
      }
      
      // Wrap process screens with progress bar
      const ProcessWrapper = ({ children }) => (
        <>
          <ProgressBar percent={getProgressPercent()} />
          {children}
        </>
      );
      
      switch (currentProcess.type) {
        case 'hagma':
          return (
            <ProcessWrapper>
              <HAGMAWorkupScreen 
                data={data}
                setData={setData}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'nagma':
          return (
            <ProcessWrapper>
              <NAGMAScreen 
                data={data}
                setData={setData}
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'metalkalosis':
          return (
            <ProcessWrapper>
              <MetAlkalosisScreen 
                data={data}
                setData={setData}
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'respacidosis':
          return (
            <ProcessWrapper>
              <RespAcidosisScreen 
                data={data}
                setData={setData}
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'respalkalosis':
          return (
            <ProcessWrapper>
              <RespAlkalosisScreen 
                data={data}
                setData={setData}
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        default:
          return null;
      }
    };

    // ============================================
    // OXYGENATION SCREEN
    // ============================================

    const OxygenationScreen = ({ onBack }) => {
      const [paO2, setPaO2] = useState('');
      const [fiO2, setFiO2] = useState('21');
      const [paCO2, setPaCO2] = useState('');
      const [age, setAge] = useState('');
      const [showSheet, setShowSheet] = useState(null); // 'pf' or 'aa'
      
      // P/F Ratio calculation
      const fiO2Decimal = fiO2 ? parseFloat(fiO2) / 100 : null;
      const paO2Val = paO2 ? parseFloat(paO2) : null;
      const pfRatio = (paO2Val && fiO2Decimal && fiO2Decimal > 0) ? paO2Val / fiO2Decimal : null;
      
      // P/F interpretation
      const getPfInterpretation = (pf) => {
        if (!pf) return null;
        if (pf >= 400) return { text: 'Normal', color: 'success', desc: 'Normal oxygenation' };
        if (pf >= 300) return { text: 'Mild', color: 'warning', desc: 'Mild hypoxaemia' };
        if (pf >= 200) return { text: 'Moderate', color: 'warning', desc: 'Moderate ARDS criteria' };
        if (pf >= 100) return { text: 'Severe', color: 'error', desc: 'Severe ARDS criteria' };
        return { text: 'Critical', color: 'error', desc: 'Life-threatening' };
      };
      
      // A-a gradient calculation (sea level)
      const paCO2Val = paCO2 ? parseFloat(paCO2) : null;
      const ageVal = age ? parseFloat(age) : null;
      const patm = 760; // sea level
      const ph2o = 47;
      const R = 0.8;
      
      const pAO2 = (fiO2Decimal && paCO2Val) ? (fiO2Decimal * (patm - ph2o)) - (paCO2Val / R) : null;
      const aaGradient = (pAO2 && paO2Val) ? pAO2 - paO2Val : null;
      const expectedAa = ageVal ? (ageVal / 4) + 4 : null;
      const isAaElevated = aaGradient && expectedAa && aaGradient > expectedAa;
      
      const getAaInterpretation = () => {
        if (!aaGradient) return null;
        if (!isAaElevated) return { text: 'Normal', color: 'success' };
        if (aaGradient < 20) return { text: 'Mild ‚Üë', color: 'warning' };
        if (aaGradient < 40) return { text: 'Moderate ‚Üë', color: 'warning' };
        return { text: 'Severe ‚Üë', color: 'error' };
      };
      
      const pfInterp = getPfInterpretation(pfRatio);
      const aaInterp = getAaInterpretation();

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <h1 style={styles.title}>Oxygenation</h1>
          </div>

          {/* Compact Input Row */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '8px' }}>
              <Input label="PaO‚ÇÇ" unit="mmHg" value={paO2} onChange={setPaO2} placeholder="80" autoFocus />
              <Input label="FiO‚ÇÇ" unit="%" value={fiO2} onChange={setFiO2} placeholder="21" />
              <Input label="PaCO‚ÇÇ" unit="mmHg" value={paCO2} onChange={setPaCO2} placeholder="40" />
              <Input label="Age" unit="yrs" value={age} onChange={setAge} placeholder="40" />
            </div>
          </div>

          {/* Results Row - P/F and A-a side by side */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }} className="animate-in stagger-2">
            {/* P/F Ratio Card */}
            <div 
              style={{ ...styles.card, cursor: pfRatio ? 'pointer' : 'default', margin: 0 }}
              onClick={() => pfRatio && setShowSheet('pf')}
            >
              <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>P/F Ratio</div>
              {pfRatio ? (
                <>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                    <span style={{ fontSize: '32px', fontWeight: '700' }}>{pfRatio.toFixed(0)}</span>
                    <span style={styles.statusBadge(pfInterp.color)}>{pfInterp.text}</span>
                  </div>
                  <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '4px' }}>Tap for details</div>
                </>
              ) : (
                <div style={{ fontSize: '14px', color: 'var(--text-tertiary)' }}>Enter PaO‚ÇÇ & FiO‚ÇÇ</div>
              )}
            </div>

            {/* A-a Gradient Card */}
            <div 
              style={{ ...styles.card, cursor: aaGradient ? 'pointer' : 'default', margin: 0 }}
              onClick={() => aaGradient && setShowSheet('aa')}
            >
              <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>A-a Gradient</div>
              {aaGradient ? (
                <>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                    <span style={{ fontSize: '32px', fontWeight: '700' }}>{aaGradient.toFixed(0)}</span>
                    <span style={styles.statusBadge(aaInterp.color)}>{aaInterp.text}</span>
                  </div>
                  {expectedAa && (
                    <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '4px' }}>
                      Expected &lt;{expectedAa.toFixed(0)} ¬∑ Tap for details
                    </div>
                  )}
                </>
              ) : (
                <div style={{ fontSize: '14px', color: 'var(--text-tertiary)' }}>Enter all values</div>
              )}
            </div>
          </div>

          {/* Quick Reference */}
          <div style={{ ...styles.card, background: 'var(--bg-tertiary)' }} className="animate-in stagger-3">
            <div style={{ fontSize: '11px', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
              <strong>P/F:</strong> ‚â•400 normal ¬∑ 300-399 mild ¬∑ 200-299 moderate ¬∑ &lt;200 severe<br/>
              <strong>A-a:</strong> Normal = (Age√∑4)+4 on room air
            </div>
          </div>

          {/* P/F Bottom Sheet */}
          <BottomSheet isOpen={showSheet === 'pf'} onClose={() => setShowSheet(null)} title="P/F Ratio">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ 
                padding: '12px', 
                background: pfInterp?.color === 'success' ? 'var(--success-light)' : pfInterp?.color === 'error' ? 'var(--error-light)' : 'var(--warning-light)', 
                borderRadius: '8px', 
                marginBottom: '12px' 
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>P/F Ratio</span>
                  <span style={{ fontSize: '24px', fontWeight: '700' }}>{pfRatio?.toFixed(0)}</span>
                </div>
                <div style={{ fontSize: '13px', marginTop: '4px' }}>{pfInterp?.desc}</div>
              </div>
              
              <p><strong>What is P/F ratio?</strong></p>
              <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                PaO‚ÇÇ divided by FiO‚ÇÇ (as decimal). Assesses oxygenation efficiency independent of supplemental oxygen.
              </p>
              
              <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '12px', fontSize: '13px' }}>
                <p><strong>Calculation:</strong> {paO2Val} √∑ {fiO2Decimal?.toFixed(2)} = {pfRatio?.toFixed(0)}</p>
              </div>
              
              <div style={{ marginTop: '12px', fontSize: '13px' }}>
                <p><strong>ARDS Berlin Criteria:</strong></p>
                <p style={{ marginTop: '4px' }}>‚Ä¢ ‚â•400: Normal</p>
                <p>‚Ä¢ 300-399: Mild impairment</p>
                <p>‚Ä¢ 200-299: Moderate ARDS (if bilateral infiltrates + PEEP ‚â•5)</p>
                <p>‚Ä¢ 100-199: Severe ARDS</p>
                <p>‚Ä¢ &lt;100: Critical hypoxaemia</p>
              </div>
            </div>
          </BottomSheet>

          {/* A-a Bottom Sheet */}
          <BottomSheet isOpen={showSheet === 'aa'} onClose={() => setShowSheet(null)} title="A-a Gradient">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ 
                padding: '12px', 
                background: aaInterp?.color === 'success' ? 'var(--success-light)' : aaInterp?.color === 'error' ? 'var(--error-light)' : 'var(--warning-light)', 
                borderRadius: '8px', 
                marginBottom: '12px' 
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>A-a Gradient</span>
                  <span style={{ fontSize: '24px', fontWeight: '700' }}>{aaGradient?.toFixed(1)}</span>
                </div>
                {expectedAa && (
                  <div style={{ fontSize: '13px', marginTop: '4px' }}>
                    Expected for age {ageVal}: &lt;{expectedAa.toFixed(0)} mmHg
                  </div>
                )}
              </div>
              
              <p><strong>What is A-a gradient?</strong></p>
              <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                Difference between alveolar (calculated) and arterial (measured) oxygen. Detects gas exchange problems.
              </p>
              
              <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '12px', fontSize: '12px' }}>
                <p><strong>Formula:</strong> PAO‚ÇÇ ‚àí PaO‚ÇÇ</p>
                <p style={{ marginTop: '4px' }}>PAO‚ÇÇ = FiO‚ÇÇ√ó(760‚àí47) ‚àí PaCO‚ÇÇ/0.8</p>
                <p style={{ marginTop: '4px' }}>= {fiO2Decimal?.toFixed(2)}√ó713 ‚àí {paCO2Val}/0.8 = {pAO2?.toFixed(1)}</p>
                <p style={{ marginTop: '4px' }}>A-a = {pAO2?.toFixed(1)} ‚àí {paO2Val} = {aaGradient?.toFixed(1)}</p>
              </div>
              
              {isAaElevated ? (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--error-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--error)' }}>Elevated A-a ‚Äî causes:</strong>
                  <p style={{ marginTop: '4px' }}>‚Ä¢ V/Q mismatch: PE, pneumonia, asthma</p>
                  <p>‚Ä¢ Shunt: ARDS, ASD/VSD, hepatopulmonary</p>
                  <p>‚Ä¢ Diffusion defect: ILD, pulmonary oedema</p>
                </div>
              ) : (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--success-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--success)' }}>Normal A-a gradient</strong>
                  <p style={{ marginTop: '4px' }}>If hypoxic with normal A-a, consider:</p>
                  <p>‚Ä¢ Hypoventilation (CNS, neuromuscular)</p>
                  <p>‚Ä¢ Low inspired O‚ÇÇ</p>
                </div>
              )}
            </div>
          </BottomSheet>
        </div>
      );
    };

    // MAIN APP
    // ============================================

    const App = () => {
      const [approach, setApproach] = useState(null);
      const [step, setStep] = useState(0);
      const [data, setData] = useState({});
      const [showFindCause, setShowFindCause] = useState(false);

      const handleRestart = () => {
        setApproach(null);
        setStep(0);
        setData({});
        setShowFindCause(false);
      };

      const handleSwitchToStewart = () => {
        // Keep input data, switch to Stewart
        // Go to step 1 to let them fill in K, Ca, Mg, lactate, phosphate if needed
        // Data is preserved so basic values won't need re-entry
        setApproach('stewart');
        setShowFindCause(false);
        setStep(1);
      };

      const handleBackFromFindCause = () => {
        setShowFindCause(false);
        setStep(2);
      };

      // Landing
      if (!approach) {
        return <LandingScreen onSelect={(a) => { setApproach(a); setStep(1); }} />;
      }

      // Beta screen
      if (approach === 'beta') {
        return <BetaScreen onSelect={(a) => setApproach(a)} onBack={handleRestart} />;
      }

      // Oxygenation screen
      if (approach === 'oxygenation') {
        return <OxygenationScreen onBack={handleRestart} />;
      }

      // DKA/HHS Monitor screen
      if (approach === 'dkahhs') {
        return <DKAHHSMonitor onBack={() => setApproach('beta')} />;
      }

      // Find Cause screen
      if (showFindCause) {
        return (
          <FindCauseScreen 
            data={data}
            setData={setData}
            approach={approach}
            onBack={handleBackFromFindCause} 
            onRestart={handleRestart}
            onSwitchToStewart={handleSwitchToStewart}
          />
        );
      }

      // Traditional pathway - condensed flow
      if (approach === 'traditional') {
        switch (step) {
          case 1:
            return (
              <>
                <ProgressBar percent={15} />
                <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />
              </>
            );
          case 2:
            return (
              <>
                <ProgressBar percent={30} />
                <Step2_FullAnalysis 
                  data={data} 
                  setData={setData} 
                  onNext={() => setShowFindCause(true)} 
                  onBack={() => setStep(1)} 
                />
              </>
            );
        }
      }

      // Stewart/Physicochemical pathway
      if (approach === 'stewart') {
        switch (step) {
          case 1:
            return (
              <>
                <ProgressBar percent={15} />
                <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />
              </>
            );
          case 2:
            return (
              <>
                <ProgressBar percent={100} />
                <Step2_StewartAnalysis 
                  data={data} 
                  setData={setData} 
                  onNext={() => {}} 
                  onBack={() => setStep(1)} 
                  onRestart={handleRestart}
                />
              </>
            );
        }
      }

      // Both - show traditional then can switch to Stewart
      if (approach === 'both') {
        switch (step) {
          case 1:
            return (
              <>
                <ProgressBar percent={15} />
                <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />
              </>
            );
          case 2:
            return (
              <>
                <ProgressBar percent={30} />
                <Step2_FullAnalysis 
                  data={data} 
                  setData={setData} 
                  onNext={() => setShowFindCause(true)} 
                  onBack={() => setStep(1)} 
                />
              </>
            );
        }
      }

      return null;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
