<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ABG Analyzer</title>
  <meta name="author" content="Scott Santinon">
  <meta name="description" content="Systematic arterial blood gas interpretation tool supporting Traditional (Henderson-Hasselbalch) and Physicochemical (Stewart) approaches">
  <meta name="copyright" content="© 2025 Scott Santinon">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F5F5F7">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: #F5F5F7;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #E8E8ED;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-tertiary: #AEAEB2;
      --accent: #007AFF;
      --success: #34C759;
      --warning: #FF9500;
      --error: #FF3B30;
      --border: rgba(0, 0, 0, 0.06);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
      --radius-sm: 10px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.47059;
      min-height: 100vh;
      min-height: 100dvh;
      letter-spacing: -0.022em;
    }

    #root {
      min-height: 100vh;
      min-height: 100dvh;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 3px; }

    input[type="number"] { -moz-appearance: textfield; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in { animation: fadeIn 0.35s ease-out forwards; }
    .stagger-1 { animation-delay: 0.05s; opacity: 0; }
    .stagger-2 { animation-delay: 0.1s; opacity: 0; }
    .stagger-3 { animation-delay: 0.15s; opacity: 0; }
    .stagger-4 { animation-delay: 0.2s; opacity: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-type="module">
    const { useState, useEffect } = React;

    // ============================================
    // CONSTANTS
    // ============================================

    const DEFAULTS = {
      albumin: 40,
      phosphate: 1.1,
      calcium: 1.15,
      magnesium: 0.85,
      lactate: 1.0,
      k: 4.0,
    };

    // ============================================
    // STYLES
    // ============================================

    const styles = {
      container: {
        minHeight: '100vh',
        padding: '16px',
        paddingBottom: '40px',
        maxWidth: '500px',
        margin: '0 auto',
      },
      header: {
        textAlign: 'center',
        marginBottom: '24px',
        paddingTop: '12px',
      },
      stepIndicator: {
        fontSize: '12px',
        fontWeight: '600',
        letterSpacing: '0.8px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '6px',
      },
      title: {
        fontSize: '28px',
        fontWeight: '700',
        letterSpacing: '-0.5px',
        color: 'var(--text-primary)',
        marginBottom: '6px',
      },
      subtitle: {
        fontSize: '15px',
        color: 'var(--text-secondary)',
        fontWeight: '400',
        lineHeight: '1.4',
      },
      card: {
        background: 'var(--bg-secondary)',
        borderRadius: 'var(--radius-lg)',
        padding: '20px',
        marginBottom: '12px',
        boxShadow: 'var(--shadow-sm)',
        border: '1px solid var(--border)',
      },
      cardTitle: {
        fontSize: '12px',
        fontWeight: '600',
        letterSpacing: '0.6px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '14px',
      },
      inputGroup: {
        marginBottom: '16px',
      },
      inputLabel: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '6px',
      },
      labelText: {
        fontSize: '14px',
        fontWeight: '500',
        color: 'var(--text-primary)',
      },
      labelUnit: {
        fontSize: '12px',
        color: 'var(--text-secondary)',
      },
      input: {
        width: '100%',
        padding: '12px 14px',
        border: '1px solid var(--border)',
        borderRadius: 'var(--radius-sm)',
        fontSize: '17px',
        fontFamily: 'var(--font)',
        color: 'var(--text-primary)',
        background: 'var(--bg-primary)',
        transition: 'all var(--transition)',
        outline: 'none',
      },
      defaultBadge: {
        display: 'inline-flex',
        alignItems: 'center',
        padding: '2px 6px',
        background: 'rgba(255, 149, 0, 0.1)',
        color: '#C77700',
        borderRadius: '4px',
        fontSize: '10px',
        fontWeight: '600',
        marginLeft: '8px',
      },
      button: {
        width: '100%',
        padding: '14px 20px',
        border: 'none',
        borderRadius: 'var(--radius-md)',
        background: 'var(--accent)',
        color: 'white',
        fontSize: '17px',
        fontWeight: '600',
        fontFamily: 'var(--font)',
        cursor: 'pointer',
        transition: 'all var(--transition)',
      },
      buttonSecondary: {
        background: 'var(--bg-tertiary)',
        color: 'var(--text-primary)',
      },
      buttonDisabled: {
        opacity: 0.4,
        cursor: 'not-allowed',
      },
      buttonSmall: {
        padding: '10px 16px',
        fontSize: '15px',
      },
      resultBox: {
        padding: '16px',
        background: 'var(--bg-primary)',
        borderRadius: 'var(--radius-sm)',
        marginBottom: '12px',
      },
      resultLabel: {
        fontSize: '12px',
        fontWeight: '600',
        letterSpacing: '0.5px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '4px',
      },
      resultValue: {
        fontSize: '20px',
        fontWeight: '600',
        color: 'var(--text-primary)',
      },
      statusBadge: (type) => ({
        display: 'inline-flex',
        alignItems: 'center',
        padding: '6px 12px',
        borderRadius: '8px',
        fontSize: '15px',
        fontWeight: '600',
        background: type === 'error' ? 'rgba(255, 59, 48, 0.1)' :
                   type === 'warning' ? 'rgba(255, 149, 0, 0.1)' :
                   type === 'success' ? 'rgba(52, 199, 89, 0.1)' :
                   'rgba(0, 122, 255, 0.1)',
        color: type === 'error' ? '#D70015' :
               type === 'warning' ? '#C77700' :
               type === 'success' ? '#248A3D' :
               '#0055D4',
      }),
      divider: {
        height: '1px',
        background: 'var(--border)',
        margin: '16px 0',
      },
      grid: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '10px',
      },
      backButton: {
        display: 'inline-flex',
        alignItems: 'center',
        gap: '4px',
        background: 'none',
        border: 'none',
        color: 'var(--accent)',
        fontSize: '17px',
        fontWeight: '400',
        cursor: 'pointer',
        padding: '0',
        marginBottom: '16px',
        fontFamily: 'var(--font)',
      },
      expandHeader: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        cursor: 'pointer',
        padding: '12px 0',
      },
      chevron: (expanded) => ({
        width: '20px',
        height: '20px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--text-tertiary)',
        transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)',
        transition: 'transform var(--transition)',
      }),
      workingContent: {
        fontSize: '13px',
        color: 'var(--text-secondary)',
        lineHeight: '1.6',
        paddingTop: '12px',
        borderTop: '1px solid var(--border)',
      },
      formula: {
        fontFamily: 'ui-monospace, SF Mono, Monaco, monospace',
        fontSize: '12px',
        background: 'rgba(0, 122, 255, 0.08)',
        padding: '2px 6px',
        borderRadius: '4px',
        color: 'var(--accent)',
      },
      valueRow: {
        display: 'flex',
        justifyContent: 'space-between',
        padding: '6px 0',
        borderBottom: '1px solid var(--border)',
        fontSize: '13px',
      },
      optionCard: {
        padding: '16px',
        background: 'var(--bg-secondary)',
        borderRadius: 'var(--radius-md)',
        border: '2px solid var(--border)',
        cursor: 'pointer',
        transition: 'all var(--transition)',
        marginBottom: '10px',
      },
      optionCardSelected: {
        borderColor: 'var(--accent)',
        background: 'rgba(0, 122, 255, 0.04)',
      },
      optionTitle: {
        fontSize: '16px',
        fontWeight: '600',
        marginBottom: '4px',
      },
      optionDesc: {
        fontSize: '13px',
        color: 'var(--text-secondary)',
        lineHeight: '1.4',
      },
      infoBox: {
        padding: '12px',
        background: 'rgba(0, 122, 255, 0.06)',
        borderRadius: 'var(--radius-sm)',
        fontSize: '13px',
        color: 'var(--text-secondary)',
        lineHeight: '1.5',
        marginTop: '12px',
      },
      warningBox: {
        padding: '12px',
        background: 'rgba(255, 149, 0, 0.08)',
        borderRadius: 'var(--radius-sm)',
        fontSize: '13px',
        color: '#8B5A00',
        lineHeight: '1.5',
        marginTop: '12px',
      },
      summaryRow: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '10px 0',
        borderBottom: '1px solid var(--border)',
      },
    };

    // ============================================
    // COMPONENTS
    // ============================================

    const ChevronIcon = () => (
      <svg width="10" height="6" viewBox="0 0 10 6" fill="none">
        <path d="M1 1L5 5L9 1" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );

    const BackIcon = () => (
      <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
        <path d="M7 1L1 7L7 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );

    const Input = ({ label, unit, value, onChange, placeholder, isDefault, defaultValue, autoFocus, warning }) => {
      const [focused, setFocused] = useState(false);
      const hasWarning = warning && value;
      
      return (
        <div style={styles.inputGroup}>
          <div style={styles.inputLabel}>
            <span style={styles.labelText}>
              {label}
              {isDefault && value === '' && <span style={styles.defaultBadge}>Default: {defaultValue}</span>}
            </span>
            {unit && <span style={styles.labelUnit}>{unit}</span>}
          </div>
          <input
            type="number"
            step="any"
            inputMode="decimal"
            autoFocus={autoFocus}
            style={{
              ...styles.input,
              borderColor: hasWarning ? 'var(--warning)' : focused ? 'var(--accent)' : 'var(--border)',
              boxShadow: hasWarning ? '0 0 0 3px rgba(255, 149, 0, 0.15)' : focused ? '0 0 0 3px rgba(0, 122, 255, 0.12)' : 'none',
            }}
            value={value}
            onChange={(e) => onChange(e.target.value)}
            onFocus={() => setFocused(true)}
            onBlur={() => setFocused(false)}
            placeholder={placeholder || (isDefault ? `${defaultValue}` : '')}
          />
          {hasWarning && (
            <div style={{ fontSize: '12px', color: 'var(--warning)', marginTop: '4px' }}>
              ⚠️ {warning}
            </div>
          )}
        </div>
      );
    };

    const ExpandableWorking = ({ children, label = "Show working" }) => {
      const [expanded, setExpanded] = useState(false);
      
      return (
        <div>
          <div style={styles.expandHeader} onClick={() => setExpanded(!expanded)}>
            <span style={{ fontSize: '14px', color: 'var(--accent)', fontWeight: '500' }}>
              {expanded ? 'Hide' : label}
            </span>
            <div style={styles.chevron(expanded)}><ChevronIcon /></div>
          </div>
          {expanded && <div style={styles.workingContent}>{children}</div>}
        </div>
      );
    };

    const Formula = ({ children }) => <code style={styles.formula}>{children}</code>;
    const Divider = () => <div style={styles.divider} />;

    const ValueRow = ({ label, value, isDefault, highlight }) => (
      <div style={{
        ...styles.valueRow,
        background: highlight ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
        margin: highlight ? '0 -8px' : '0',
        padding: highlight ? '6px 8px' : '6px 0',
        borderRadius: highlight ? '4px' : '0',
      }}>
        <span>{label}</span>
        <span style={{ fontWeight: '500', color: 'var(--text-primary)' }}>
          {value}
          {isDefault && <span style={{ ...styles.defaultBadge, marginLeft: '6px' }}>default</span>}
        </span>
      </div>
    );

    // ============================================
    // SCREENS
    // ============================================

    // Landing Screen
    const LandingScreen = ({ onSelect }) => (
      <div style={styles.container}>
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Blood Gas</div>
          <h1 style={styles.title}>ABG Analyzer</h1>
          <p style={styles.subtitle}>Systematic acid-base interpretation</p>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Choose Approach</div>
          
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('traditional')}
          >
            <div style={styles.optionTitle}>Traditional</div>
            <div style={styles.optionDesc}>Henderson-Hasselbalch. Anion gap, delta ratio.</div>
          </div>

          <div 
            style={styles.optionCard}
            onClick={() => onSelect('stewart')}
          >
            <div style={styles.optionTitle}>Physicochemical</div>
            <div style={styles.optionDesc}>Stewart approach. SID, ATOT, strong ion gap.</div>
          </div>

          <div 
            style={styles.optionCard}
            onClick={() => onSelect('both')}
          >
            <div style={styles.optionTitle}>Compare Both</div>
            <div style={styles.optionDesc}>Side by side analysis.</div>
          </div>
        </div>

        <div style={{ ...styles.card, background: 'var(--surface)', marginTop: '8px' }} className="animate-in stagger-2">
          <div style={{ fontSize: '12px', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
            <p style={{ marginBottom: '8px' }}>
              <strong>Clinical Disclaimer</strong>
            </p>
            <p style={{ marginBottom: '8px' }}>
              This tool is intended as an educational aid and decision support resource only. It does not constitute medical advice and should not replace clinical judgement. All results must be interpreted in the context of the individual patient's clinical presentation, history, and other investigations.
            </p>
            <p>
              The authors accept no responsibility for clinical decisions made using this tool. Always verify calculations independently and consult appropriate references when managing patients.
            </p>
          </div>
        </div>

        <div style={{ textAlign: 'center', padding: '16px', fontSize: '12px', color: 'var(--text-secondary)' }} className="animate-in stagger-3">
          © 2025 Scott Santinon. All rights reserved.
        </div>
      </div>
    );

    // Step 1: All Values (Traditional)
    const Step1_AllValues = ({ data, setData, onNext, onBack, approach }) => {
      const needsStewart = approach === 'stewart' || approach === 'both';
      const canProceed = data.pH && data.paCO2 && data.hco3 && data.na && data.cl;
      
      // Input validation - returns warning message or null
      const checkRange = (value, min, max, unit) => {
        if (!value) return null;
        const v = parseFloat(value);
        if (v < min || v > max) return `Outside typical range (${min}–${max} ${unit})`;
        return null;
      };
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 1</div>
            <h1 style={styles.title}>Enter Values</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={styles.cardTitle}>Blood Gas</div>
            <Input 
              label="pH" 
              value={data.pH || ''} 
              onChange={v => setData({...data, pH: v})} 
              placeholder="7.40"
              autoFocus
              warning={checkRange(data.pH, 6.8, 7.8, '')}
            />
            <div style={styles.grid}>
              <Input 
                label="PaCO₂" 
                unit="mmHg" 
                value={data.paCO2 || ''} 
                onChange={v => setData({...data, paCO2: v})} 
                placeholder="40"
                warning={checkRange(data.paCO2, 10, 120, 'mmHg')}
              />
              <Input 
                label="HCO₃⁻" 
                unit="mmol/L" 
                value={data.hco3 || ''} 
                onChange={v => setData({...data, hco3: v})} 
                placeholder="24"
                warning={checkRange(data.hco3, 5, 50, 'mmol/L')}
              />
            </div>
          </div>

          <div style={styles.card} className="animate-in stagger-2">
            <div style={styles.cardTitle}>Electrolytes</div>
            <div style={styles.grid}>
              <Input 
                label="Na⁺" 
                unit="mmol/L" 
                value={data.na || ''} 
                onChange={v => setData({...data, na: v})} 
                placeholder="140"
                warning={checkRange(data.na, 110, 170, 'mmol/L')}
              />
              <Input 
                label="Cl⁻" 
                unit="mmol/L" 
                value={data.cl || ''} 
                onChange={v => setData({...data, cl: v})} 
                placeholder="102"
                warning={checkRange(data.cl, 70, 130, 'mmol/L')}
              />
            </div>
            
            {needsStewart && (
              <>
                <div style={styles.grid}>
                  <Input 
                    label="K⁺" 
                    unit="mmol/L" 
                    value={data.k || ''} 
                    onChange={v => setData({...data, k: v})} 
                    placeholder="4.0"
                    isDefault
                    defaultValue="4.0"
                    warning={checkRange(data.k, 2.0, 8.0, 'mmol/L')}
                  />
                  <Input 
                    label="Lactate" 
                    unit="mmol/L" 
                    value={data.lactate || ''} 
                    onChange={v => setData({...data, lactate: v})} 
                    placeholder="1.0"
                    isDefault
                    defaultValue="1.0"
                    warning={checkRange(data.lactate, 0, 25, 'mmol/L')}
                  />
                </div>
                <div style={styles.grid}>
                  <Input 
                    label="Ca²⁺ (ionised)" 
                    unit="mmol/L" 
                    value={data.ca || ''} 
                    onChange={v => setData({...data, ca: v})} 
                    placeholder="1.15"
                    isDefault
                    defaultValue="1.15"
                    warning={checkRange(data.ca, 0.8, 1.5, 'mmol/L')}
                  />
                  <Input 
                    label="Mg²⁺" 
                    unit="mmol/L" 
                    value={data.mg || ''} 
                    onChange={v => setData({...data, mg: v})} 
                    placeholder="0.85"
                    isDefault
                    defaultValue="0.85"
                    warning={checkRange(data.mg, 0.4, 1.2, 'mmol/L')}
                  />
                </div>
              </>
            )}
            
            <Divider />
            
            <Input 
              label="Albumin" 
              unit="g/L" 
              value={data.albumin || ''} 
              onChange={v => setData({...data, albumin: v})} 
              placeholder="40"
              isDefault
              defaultValue="40"
              warning={checkRange(data.albumin, 10, 55, 'g/L')}
            />
            
            {needsStewart && (
              <Input 
                label="Phosphate" 
                unit="mmol/L" 
                value={data.phosphate || ''} 
                onChange={v => setData({...data, phosphate: v})} 
                placeholder="1.1"
                isDefault
                defaultValue="1.1"
                warning={checkRange(data.phosphate, 0.5, 3.0, 'mmol/L')}
              />
            )}
          </div>

          {!canProceed && (
            <div style={{ padding: '12px 16px', background: 'rgba(0, 122, 255, 0.06)', borderRadius: '10px', marginBottom: '12px' }} className="animate-in stagger-3">
              <div style={{ fontSize: '13px', color: 'var(--accent)', fontWeight: '500' }}>
                Required fields missing:
              </div>
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                {[
                  !data.pH && 'pH',
                  !data.paCO2 && 'PaCO2',
                  !data.hco3 && 'HCO3',
                  !data.na && 'Na',
                  !data.cl && 'Cl',
                ].filter(Boolean).join(', ')}
              </div>
            </div>
          )}

          <button
            className="animate-in stagger-3"
            style={{
              ...styles.button,
              ...(canProceed ? {} : styles.buttonDisabled),
            }}
            onClick={onNext}
            disabled={!canProceed}
          >
            Analyse
          </button>
        </div>
      );
    };

    // Step 2: Full Analysis Results (Traditional)
    const Step2_FullAnalysis = ({ data, setData, onNext, onBack }) => {
      const [timing, setTiming] = useState(data.timing || 'acute');
      
      const pH = parseFloat(data.pH);
      const paCO2 = parseFloat(data.paCO2);
      const hco3 = parseFloat(data.hco3);
      const na = parseFloat(data.na);
      const cl = parseFloat(data.cl);
      const albumin = data.albumin ? parseFloat(data.albumin) : DEFAULTS.albumin;
      
      // pH Status
      const pHStatus = pH < 7.35 ? 'acidaemia' : pH > 7.45 ? 'alkalaemia' : 'normal';
      const statusType = pHStatus === 'acidaemia' ? 'error' : pHStatus === 'alkalaemia' ? 'warning' : 'success';
      
      // Primary disorder
      let primaryDisorder = '';
      let isMetabolic = false;
      let isRespiratory = false;
      
      // Check for abnormal values
      const lowHCO3 = hco3 < 22;
      const highHCO3 = hco3 > 26;
      const lowPaCO2 = paCO2 < 35;
      const highPaCO2 = paCO2 > 45;
      
      if (pHStatus === 'acidaemia') {
        if (highPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory acidosis';
          isRespiratory = true;
        } else if (lowHCO3 && !highPaCO2) {
          primaryDisorder = 'Metabolic acidosis';
          isMetabolic = true;
        } else if (lowHCO3 && highPaCO2) {
          primaryDisorder = 'Metabolic + respiratory acidosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Acidaemia (indeterminate)';
          isMetabolic = true;
        }
      } else if (pHStatus === 'alkalaemia') {
        if (lowPaCO2 && !highHCO3) {
          primaryDisorder = 'Respiratory alkalosis';
          isRespiratory = true;
        } else if (highHCO3 && !lowPaCO2) {
          primaryDisorder = 'Metabolic alkalosis';
          isMetabolic = true;
        } else if (highHCO3 && lowPaCO2) {
          primaryDisorder = 'Metabolic + respiratory alkalosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Alkalaemia (indeterminate)';
          isMetabolic = true;
        }
      } else {
        // Normal pH - check for compensated disorders or mixed
        if (lowHCO3 && lowPaCO2) {
          primaryDisorder = 'Compensated metabolic acidosis';
          isMetabolic = true;
        } else if (highHCO3 && highPaCO2) {
          // Could be compensated met alk OR compensated resp acidosis
          primaryDisorder = 'Compensated disorder';
          isMetabolic = true;
          isRespiratory = true;
        } else if (highPaCO2 && !highHCO3) {
          // High CO2 with normal-ish HCO3 and normal pH is unusual
          primaryDisorder = 'Respiratory acidosis (compensated)';
          isRespiratory = true;
        } else if (lowPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory alkalosis (compensated)';
          isRespiratory = true;
        } else if (lowHCO3 || highHCO3 || lowPaCO2 || highPaCO2) {
          // Some abnormality exists
          primaryDisorder = 'Mixed disorder (normal pH)';
          isMetabolic = true;
        } else {
          // All values normal - still calculate AG
          primaryDisorder = 'Check anion gap';
          isMetabolic = true;
        }
      }

      const isAcidosis = pHStatus === 'acidaemia' || primaryDisorder.toLowerCase().includes('acidosis');
      const isAlkalosis = pHStatus === 'alkalaemia' || primaryDisorder.toLowerCase().includes('alkalosis');

      // Compensation (only for pure disorders, not mixed)
      let expectedPaCO2 = null;
      let expectedHCO3 = null;
      let compensationResult = '';
      let compensationNote = '';

      const isMixed = isMetabolic && isRespiratory;

      if (isMixed) {
        compensationResult = 'Mixed disorder — classic single-disorder compensation rules do not apply';
      } else if (isMetabolic && isAcidosis) {
        expectedPaCO2 = (1.5 * hco3) + 8;
        // Physiological floor: PaCO2 cannot go below ~10 mmHg
        if (expectedPaCO2 < 10) {
          compensationNote = 'Maximal respiratory compensation reached (PaCO₂ floor ~10 mmHg)';
          expectedPaCO2 = 10;
        }
      } else if (isMetabolic && isAlkalosis) {
        expectedPaCO2 = (0.7 * hco3) + 20;
        // Physiological ceiling: PaCO2 rarely exceeds ~55-60 for compensation
        if (expectedPaCO2 > 55) {
          compensationNote = 'Expected PaCO₂ exceeds usual compensatory limit (~55 mmHg)';
        }
      } else if (isRespiratory) {
        const deltaCO2 = Math.abs(paCO2 - 40) / 10;
        if (isAcidosis) {
          const change = timing === 'acute' ? 1 : 4;
          expectedHCO3 = 24 + (deltaCO2 * change);
          // Physiological ceiling: HCO3 rarely exceeds 45 mmol/L
          if (expectedHCO3 > 45) {
            compensationNote = 'Beyond usual physiological compensation (HCO₃ ceiling ~45 mmol/L)';
            expectedHCO3 = 45;
          }
        } else {
          const change = timing === 'acute' ? 2 : 5;
          expectedHCO3 = 24 - (deltaCO2 * change);
          // Physiological floor: HCO3 rarely goes below 12-15 for compensation
          if (expectedHCO3 < 12) {
            compensationNote = 'Beyond usual physiological compensation (HCO₃ floor ~12 mmol/L)';
            expectedHCO3 = 12;
          }
        }
      }

      if (!isMixed) {
        if (expectedPaCO2 !== null) {
          const diff = paCO2 - expectedPaCO2;
          if (Math.abs(diff) <= 3) compensationResult = 'Appropriate compensation';
          else if (diff > 3) compensationResult = 'Additional respiratory acidosis';
          else compensationResult = 'Additional respiratory alkalosis';
        } else if (expectedHCO3 !== null) {
          const diff = hco3 - expectedHCO3;
          if (Math.abs(diff) <= 3) compensationResult = 'Appropriate compensation';
          else if (diff > 3) compensationResult = 'Additional metabolic alkalosis';
          else compensationResult = 'Additional metabolic acidosis';
        }
      }

      const compensationType = compensationResult.includes('Appropriate') ? 'success' : 
                               compensationResult.includes('Mixed') ? 'neutral' : 'warning';

      // Anion Gap (only for metabolic acidosis)
      const rawAG = na - hco3 - cl;
      const correction = 0.25 * (40 - albumin);
      const correctedAG = rawAG + correction;
      const isHAGMA = correctedAG >= 12;

      // Delta Ratio (only for HAGMA)
      let deltaAG = null;
      let deltaHCO3 = null;
      let deltaRatio = null;
      let deltaInterpretation = '';
      
      if (isMetabolic && isAcidosis && isHAGMA) {
        deltaAG = correctedAG - 12;
        deltaHCO3 = 24 - hco3;
        deltaRatio = deltaHCO3 > 0 ? deltaAG / deltaHCO3 : null;
        
        if (deltaRatio !== null) {
          if (deltaRatio < 0.4) deltaInterpretation = 'NAGMA (not HAGMA)';
          else if (deltaRatio < 0.8) deltaInterpretation = 'Mixed HAGMA + NAGMA';
          else if (deltaRatio <= 2) deltaInterpretation = 'No additional process';
          else deltaInterpretation = 'HAGMA + metabolic alkalosis';
        }
      }

      const handleNext = () => {
        const updatedData = {
          ...data,
          pHStatus,
          primaryDisorder,
          isMetabolic,
          isRespiratory,
          isAcidosis,
          isAlkalosis,
          timing,
          expectedPaCO2,
          expectedHCO3,
          compensationResult,
          rawAG,
          correctedAG,
          isHAGMA,
          usedAlbumin: albumin,
          deltaAG,
          deltaHCO3,
          deltaRatio,
          deltaInterpretation,
        };
        setData(updatedData);
        onNext();
      };

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 2</div>
            <h1 style={styles.title}>Analysis</h1>
          </div>

          {/* Primary Disorder */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
              <div>
                <div style={styles.resultLabel}>Primary Disorder</div>
                <div style={{ fontSize: '18px', fontWeight: '600' }}>{primaryDisorder}</div>
              </div>
              <span style={styles.statusBadge(statusType)}>
                pH {pH.toFixed(2)}
              </span>
            </div>

            {/* Timing toggle for respiratory - only show for pure respiratory disorders */}
            {isRespiratory && !isMixed && (
              <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                  Duration (affects expected compensation):
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    style={{
                      flex: 1,
                      padding: '8px 12px',
                      border: '2px solid',
                      borderColor: timing === 'acute' ? 'var(--accent)' : 'var(--border)',
                      borderRadius: '8px',
                      background: timing === 'acute' ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      fontFamily: 'var(--font)',
                    }}
                    onClick={() => setTiming('acute')}
                  >
                    Acute
                  </button>
                  <button
                    style={{
                      flex: 1,
                      padding: '8px 12px',
                      border: '2px solid',
                      borderColor: timing === 'chronic' ? 'var(--accent)' : 'var(--border)',
                      borderRadius: '8px',
                      background: timing === 'chronic' ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      fontFamily: 'var(--font)',
                    }}
                    onClick={() => setTiming('chronic')}
                  >
                    Chronic
                  </button>
                </div>
                <ExpandableWorking label="How to decide">
                  <p><strong>Acute (hours)</strong></p>
                  <p>• Sudden onset with acute precipitant</p>
                  <p>• Overdose, PE, asthma, pneumonia, panic</p>
                  <p>• HCO₃ still near 24 despite abnormal CO₂</p>
                  <Divider />
                  <p><strong>Chronic (3-5+ days)</strong></p>
                  <p>• Known chronic lung disease (COPD, ILD, OHS)</p>
                  <p>• Gradual onset or at patient's baseline</p>
                  <p>• HCO₃ already significantly shifted</p>
                  <Divider />
                  <p style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                    If unsure, compare actual HCO₃ ({hco3}) to expected values below
                  </p>
                </ExpandableWorking>
                
                {/* Show expected values for both */}
                <div style={{ marginTop: '10px', fontSize: '13px', color: 'var(--text-secondary)', background: 'var(--surface)', padding: '10px', borderRadius: '8px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                    <span>If acute → expected HCO₃:</span>
                    <span style={{ fontWeight: '500' }}>
                      {isAcidosis 
                        ? (24 + (Math.abs(paCO2 - 40) / 10) * 1).toFixed(0)
                        : (24 - (Math.abs(paCO2 - 40) / 10) * 2).toFixed(0)
                      } mmol/L
                    </span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span>If chronic → expected HCO₃:</span>
                    <span style={{ fontWeight: '500' }}>
                      {isAcidosis 
                        ? (24 + (Math.abs(paCO2 - 40) / 10) * 4).toFixed(0)
                        : (24 - (Math.abs(paCO2 - 40) / 10) * 5).toFixed(0)
                      } mmol/L
                    </span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '6px', paddingTop: '6px', borderTop: '1px solid var(--border)' }}>
                    <span>Actual HCO₃:</span>
                    <span style={{ fontWeight: '600', color: 'var(--text-primary)' }}>{hco3} mmol/L</span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Compensation */}
          {compensationResult && (
            <div style={styles.card} className="animate-in stagger-2">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={styles.resultLabel}>Compensation</div>
                <span style={styles.statusBadge(compensationType)}>{compensationResult}</span>
              </div>
              {compensationNote && (
                <div style={{ fontSize: '13px', color: 'var(--warning)', marginTop: '8px', fontStyle: 'italic' }}>
                  ⚠️ {compensationNote}
                </div>
              )}
              <ExpandableWorking>
                {expectedPaCO2 !== null && (
                  <>
                    <p>Expected PaCO₂ = {expectedPaCO2.toFixed(0)} mmHg</p>
                    <p>Actual PaCO₂ = {paCO2} mmHg</p>
                    <p>Difference = {Math.abs(paCO2 - expectedPaCO2).toFixed(0)} mmHg {Math.abs(paCO2 - expectedPaCO2) <= 2 ? '(within ±2)' : ''}</p>
                  </>
                )}
                {expectedHCO3 !== null && (
                  <>
                    <p>Expected HCO₃ = {expectedHCO3.toFixed(0)} mmol/L ({timing})</p>
                    <p>Actual HCO₃ = {hco3} mmol/L</p>
                  </>
                )}
              </ExpandableWorking>
            </div>
          )}

          {/* Anion Gap (for metabolic acidosis OR when checking for hidden gap) */}
          {((isMetabolic && isAcidosis) || primaryDisorder === 'Check anion gap') && (
            <div style={styles.card} className="animate-in stagger-3">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <div style={styles.resultLabel}>Anion Gap</div>
                  <div style={{ fontSize: '16px', fontWeight: '600' }}>{correctedAG.toFixed(1)} mEq/L</div>
                </div>
                <span style={styles.statusBadge(isHAGMA ? 'error' : 'success')}>
                  {isHAGMA ? 'Elevated (HAGMA)' : 'Normal'}
                </span>
              </div>
              <ExpandableWorking>
                <p>Raw AG = {na} - {hco3} - {cl} = {rawAG.toFixed(1)}</p>
                <p>Albumin correction = +{correction.toFixed(1)}</p>
                <p>Corrected AG = {correctedAG.toFixed(1)} {!data.albumin && '(using default albumin 40)'}</p>
              </ExpandableWorking>
            </div>
          )}

          {/* Delta Ratio (for HAGMA) */}
          {isHAGMA && deltaRatio !== null && (
            <div style={styles.card} className="animate-in stagger-4">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <div style={styles.resultLabel}>Delta Ratio</div>
                  <div style={{ fontSize: '16px', fontWeight: '600' }}>{deltaRatio.toFixed(2)}</div>
                </div>
                <span style={styles.statusBadge(deltaInterpretation === 'No additional process' ? 'success' : 'warning')}>
                  {deltaInterpretation}
                </span>
              </div>
              <ExpandableWorking>
                <p>ΔAG = {correctedAG.toFixed(1)} - 12 = {deltaAG.toFixed(1)}</p>
                <p>ΔHCO₃ = 24 - {hco3} = {deltaHCO3.toFixed(1)}</p>
                <p>Ratio = {deltaRatio.toFixed(2)}</p>
                <Divider />
                <p style={{ fontSize: '12px' }}>{"<"}0.4 NAGMA | 0.4-0.8 mixed | 0.8-2 HAGMA | {">"}2 +met alk</p>
              </ExpandableWorking>
            </div>
          )}

          {/* Synthesis Summary */}
          <div style={styles.card} className="animate-in stagger-5">
            <div style={styles.cardTitle}>Summary</div>
            <div style={{ fontSize: '15px', lineHeight: '1.7', color: 'var(--text-primary)' }}>
              {(() => {
                const parts = [];
                
                // Handle mixed disorders (both metabolic and respiratory primary)
                if (isMixed) {
                  // Metabolic component
                  if (isAcidosis || (isHAGMA && pHStatus !== 'alkalaemia')) {
                    if (isHAGMA) {
                      if (deltaInterpretation === 'Mixed HAGMA + NAGMA' || deltaInterpretation === 'Concurrent NAGMA') {
                        parts.push('Mixed HAGMA + NAGMA');
                      } else if (deltaInterpretation === 'HAGMA + metabolic alkalosis') {
                        parts.push('HAGMA with concurrent metabolic alkalosis');
                      } else {
                        parts.push('High anion gap metabolic acidosis');
                      }
                    } else {
                      parts.push('Normal anion gap metabolic acidosis');
                    }
                  } else if (isAlkalosis) {
                    parts.push('Metabolic alkalosis');
                  }
                  
                  // Respiratory component
                  if (pHStatus === 'acidaemia' || primaryDisorder.toLowerCase().includes('acidosis')) {
                    parts.push('respiratory acidosis');
                  } else {
                    parts.push('respiratory alkalosis');
                  }
                } else {
                  // Single primary disorder
                  if (isMetabolic && isAcidosis) {
                    if (isHAGMA) {
                      if (deltaInterpretation === 'Mixed HAGMA + NAGMA' || deltaInterpretation === 'Concurrent NAGMA') {
                        parts.push('Mixed high and normal anion gap metabolic acidosis');
                      } else if (deltaInterpretation === 'HAGMA + metabolic alkalosis') {
                        parts.push('High anion gap metabolic acidosis with concurrent metabolic alkalosis');
                      } else {
                        parts.push('High anion gap metabolic acidosis');
                      }
                    } else {
                      parts.push('Normal anion gap metabolic acidosis');
                    }
                  } else if (isMetabolic && isAlkalosis) {
                    parts.push('Metabolic alkalosis');
                  } else if (isRespiratory && isAcidosis) {
                    parts.push(timing === 'acute' ? 'Acute respiratory acidosis' : 'Chronic respiratory acidosis');
                  } else if (isRespiratory && isAlkalosis) {
                    parts.push(timing === 'acute' ? 'Acute respiratory alkalosis' : 'Chronic respiratory alkalosis');
                  } else if (pHStatus === 'normal') {
                    if (isHAGMA) {
                      parts.push('Normal pH with hidden HAGMA (likely mixed disorder)');
                    } else {
                      parts.push('Normal acid-base status');
                    }
                  }
                  
                  // Secondary disorder from compensation analysis
                  if (compensationResult && compensationResult !== 'Appropriate compensation') {
                    if (compensationResult.includes('respiratory acidosis')) {
                      parts.push('additional respiratory acidosis');
                    } else if (compensationResult.includes('respiratory alkalosis')) {
                      parts.push('additional respiratory alkalosis');
                    } else if (compensationResult.includes('metabolic acidosis')) {
                      parts.push('additional metabolic acidosis');
                    } else if (compensationResult.includes('metabolic alkalosis')) {
                      parts.push('additional metabolic alkalosis');
                    }
                  }
                }
                
                if (parts.length === 0) return 'Unable to determine';
                if (parts.length === 1) return parts[0];
                return parts[0] + ' + ' + parts.slice(1).join(' + ');
              })()}
            </div>
          </div>

          <button className="animate-in stagger-6" style={styles.button} onClick={handleNext}>
            Find Cause →
          </button>
        </div>
      );
    };

    // Step 2: Stewart/Physicochemical Analysis
    const Step2_StewartAnalysis = ({ data, setData, onNext, onBack }) => {
      const [timing, setTiming] = useState(data.timing || 'acute');
      
      const pH = parseFloat(data.pH);
      const paCO2 = parseFloat(data.paCO2);
      const hco3 = parseFloat(data.hco3);
      const na = parseFloat(data.na);
      const cl = parseFloat(data.cl);
      const k = data.k ? parseFloat(data.k) : DEFAULTS.k;
      const ca = data.ca ? parseFloat(data.ca) : 1.15;
      const mg = data.mg ? parseFloat(data.mg) : 0.85;
      const lactate = data.lactate ? parseFloat(data.lactate) : 1.0;
      const albumin = data.albumin ? parseFloat(data.albumin) : DEFAULTS.albumin;
      const phosphate = data.phosphate ? parseFloat(data.phosphate) : 1.1;
      
      // pH Status (same as traditional)
      const pHStatus = pH < 7.35 ? 'acidaemia' : pH > 7.45 ? 'alkalaemia' : 'normal';
      const statusType = pHStatus === 'acidaemia' ? 'error' : pHStatus === 'alkalaemia' ? 'warning' : 'success';
      
      // Primary disorder
      let primaryDisorder = '';
      let isMetabolic = false;
      let isRespiratory = false;
      
      // Check for abnormal values
      const lowHCO3 = hco3 < 22;
      const highHCO3 = hco3 > 26;
      const lowPaCO2 = paCO2 < 35;
      const highPaCO2 = paCO2 > 45;
      
      if (pHStatus === 'acidaemia') {
        if (highPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory acidosis';
          isRespiratory = true;
        } else if (lowHCO3 && !highPaCO2) {
          primaryDisorder = 'Metabolic acidosis';
          isMetabolic = true;
        } else if (lowHCO3 && highPaCO2) {
          primaryDisorder = 'Metabolic + respiratory acidosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Acidaemia (indeterminate)';
          isMetabolic = true;
        }
      } else if (pHStatus === 'alkalaemia') {
        if (lowPaCO2 && !highHCO3) {
          primaryDisorder = 'Respiratory alkalosis';
          isRespiratory = true;
        } else if (highHCO3 && !lowPaCO2) {
          primaryDisorder = 'Metabolic alkalosis';
          isMetabolic = true;
        } else if (highHCO3 && lowPaCO2) {
          primaryDisorder = 'Metabolic + respiratory alkalosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Alkalaemia (indeterminate)';
          isMetabolic = true;
        }
      } else {
        // Normal pH - check for compensated disorders or mixed
        if (lowHCO3 && lowPaCO2) {
          primaryDisorder = 'Compensated metabolic acidosis';
          isMetabolic = true;
        } else if (highHCO3 && highPaCO2) {
          primaryDisorder = 'Compensated disorder';
          isMetabolic = true;
          isRespiratory = true;
        } else if (highPaCO2 && !highHCO3) {
          primaryDisorder = 'Respiratory acidosis (compensated)';
          isRespiratory = true;
        } else if (lowPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory alkalosis (compensated)';
          isRespiratory = true;
        } else if (lowHCO3 || highHCO3 || lowPaCO2 || highPaCO2) {
          primaryDisorder = 'Mixed disorder (normal pH)';
          isMetabolic = true;
        } else {
          primaryDisorder = 'Check SIG';
          isMetabolic = true;
        }
      }

      const isAcidosis = pHStatus === 'acidaemia' || primaryDisorder.toLowerCase().includes('acidosis');
      const isAlkalosis = pHStatus === 'alkalaemia' || primaryDisorder.toLowerCase().includes('alkalosis');

      // ========== STEWART CALCULATIONS ==========
      
      // SIDa (apparent Strong Ion Difference)
      // Ca and Mg are divalent, so ×2 for charge contribution
      const SIDa = na + k + (2 * ca) + (2 * mg) - cl - lactate;
      const normalSIDa = 40; // Normal ~38-42 mEq/L
      
      // ATOT (weak acid charges)
      // Albumin charge formula (Figge-Fencl)
      const albuminCharge = (albumin / 10) * (0.123 * pH - 0.631);
      // Phosphate charge
      const phosphateCharge = phosphate * (0.309 * pH - 0.469);
      const ATOT = albuminCharge + phosphateCharge;
      
      // SIDe (effective) = HCO3 + ATOT
      const SIDe = hco3 + ATOT;
      
      // SIG (Strong Ion Gap) = SIDa - SIDe
      const SIG = SIDa - SIDe;
      const normalSIG = 2; // Normal < 2
      
      // Component effects (deviation from normal)
      const naEffect = na - 140; // Positive = alkalosis from hypernatraemia/free water deficit
      const clEffect = 102 - cl; // Positive = alkalosis from hypochloraemia
      const lactateEffect = -(lactate - 1.0); // Elevated lactate = acidosis
      const albuminEffect = (40 - albumin) * 0.25; // Low albumin = alkalosis
      
      // Interpretation
      let sidInterpretation = '';
      if (SIDa < 38) {
        sidInterpretation = 'Low SID → metabolic acidosis';
      } else if (SIDa > 42) {
        sidInterpretation = 'High SID → metabolic alkalosis';
      } else {
        sidInterpretation = 'Normal SID';
      }
      
      let sigInterpretation = '';
      if (SIG > 2) {
        sigInterpretation = 'Elevated SIG → unmeasured anions present';
      } else {
        sigInterpretation = 'Normal SIG';
      }

      const handleNext = () => {
        setData(prev => ({
          ...prev,
          pHStatus,
          primaryDisorder,
          isMetabolic,
          isRespiratory,
          isAcidosis,
          isAlkalosis,
          timing,
          // Stewart data
          SIDa,
          SIDe,
          SIG,
          ATOT,
          albuminCharge,
          phosphateCharge,
          naEffect,
          clEffect,
          lactateEffect,
          albuminEffect,
          isHAGMA: SIG > 2, // SIG > 2 is analogous to HAGMA
          usedAlbumin: albumin,
        }));
        onNext();
      };

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 2 — Stewart</div>
            <h1 style={styles.title}>Analysis</h1>
          </div>

          {/* Primary Disorder */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
              <div>
                <div style={styles.resultLabel}>Primary Disorder</div>
                <div style={{ fontSize: '18px', fontWeight: '600' }}>{primaryDisorder}</div>
              </div>
              <span style={styles.statusBadge(statusType)}>
                pH {pH.toFixed(2)}
              </span>
            </div>

            {isRespiratory && (
              <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                  Duration (affects expected compensation):
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    style={{
                      flex: 1, padding: '8px 12px', border: '2px solid',
                      borderColor: timing === 'acute' ? 'var(--accent)' : 'var(--border)',
                      borderRadius: '8px',
                      background: timing === 'acute' ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
                      fontSize: '14px', fontWeight: '500', cursor: 'pointer', fontFamily: 'var(--font)',
                    }}
                    onClick={() => setTiming('acute')}
                  >Acute</button>
                  <button
                    style={{
                      flex: 1, padding: '8px 12px', border: '2px solid',
                      borderColor: timing === 'chronic' ? 'var(--accent)' : 'var(--border)',
                      borderRadius: '8px',
                      background: timing === 'chronic' ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
                      fontSize: '14px', fontWeight: '500', cursor: 'pointer', fontFamily: 'var(--font)',
                    }}
                    onClick={() => setTiming('chronic')}
                  >Chronic</button>
                </div>
                <ExpandableWorking label="How to decide">
                  <p><strong>Acute (hours)</strong></p>
                  <p>• Sudden onset with acute precipitant</p>
                  <p>• Overdose, PE, asthma, pneumonia, panic</p>
                  <p>• HCO₃ still near 24 despite abnormal CO₂</p>
                  <Divider />
                  <p><strong>Chronic (3-5+ days)</strong></p>
                  <p>• Known chronic lung disease (COPD, ILD, OHS)</p>
                  <p>• Gradual onset or at patient's baseline</p>
                  <p>• HCO₃ already significantly shifted</p>
                  <Divider />
                  <p style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                    If unsure, compare actual HCO₃ ({hco3}) to expected values below
                  </p>
                </ExpandableWorking>
                
                {/* Show expected values for both */}
                <div style={{ marginTop: '10px', fontSize: '13px', color: 'var(--text-secondary)', background: 'var(--surface)', padding: '10px', borderRadius: '8px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                    <span>If acute → expected HCO₃:</span>
                    <span style={{ fontWeight: '500' }}>
                      {isAcidosis 
                        ? (24 + (Math.abs(paCO2 - 40) / 10) * 1).toFixed(0)
                        : (24 - (Math.abs(paCO2 - 40) / 10) * 2).toFixed(0)
                      } mmol/L
                    </span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span>If chronic → expected HCO₃:</span>
                    <span style={{ fontWeight: '500' }}>
                      {isAcidosis 
                        ? (24 + (Math.abs(paCO2 - 40) / 10) * 4).toFixed(0)
                        : (24 - (Math.abs(paCO2 - 40) / 10) * 5).toFixed(0)
                      } mmol/L
                    </span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '6px', paddingTop: '6px', borderTop: '1px solid var(--border)' }}>
                    <span>Actual HCO₃:</span>
                    <span style={{ fontWeight: '600', color: 'var(--text-primary)' }}>{hco3} mmol/L</span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* SID */}
          <div style={styles.card} className="animate-in stagger-2">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <div style={styles.resultLabel}>Apparent Strong Ion Difference (SIDa)</div>
                <div style={{ fontSize: '18px', fontWeight: '600' }}>{SIDa.toFixed(1)} mEq/L</div>
              </div>
              <span style={styles.statusBadge(SIDa < 38 ? 'error' : SIDa > 42 ? 'warning' : 'success')}>
                {sidInterpretation.split('→')[0].trim()}
              </span>
            </div>
            <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>
              Normal 38-42 mEq/L
            </div>
            <ExpandableWorking>
              <p><Formula>SIDa = Na + K + 2Ca + 2Mg − Cl − Lactate</Formula></p>
              <p>= {na} + {k} + {(2*ca).toFixed(1)} + {(2*mg).toFixed(1)} − {cl} − {lactate}</p>
              <p>= {SIDa.toFixed(1)} mEq/L</p>
              <Divider />
              <p style={{ fontSize: '12px' }}>
                ↓SID → acidosis (excess strong anions or deficit strong cations)<br/>
                ↑SID → alkalosis (deficit strong anions or excess strong cations)
              </p>
            </ExpandableWorking>
          </div>

          {/* Component Effects */}
          <div style={styles.card} className="animate-in stagger-3">
            <div style={styles.cardTitle}>Component Effects</div>
            <div style={{ fontSize: '14px', lineHeight: '1.8' }}>
              <div style={{ padding: '6px 0', borderBottom: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span>Free water</span>
                  <span style={{ fontWeight: '500', color: naEffect > 2 ? 'var(--warning)' : naEffect < -2 ? 'var(--error)' : 'var(--text-primary)' }}>
                    {naEffect > 2 ? 'Deficit → alkalosis' : naEffect < -2 ? 'Excess → acidosis' : 'Normal'}
                  </span>
                </div>
                <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                  Na⁺ {na} mmol/L {naEffect !== 0 ? `(${naEffect > 0 ? '+' : ''}${naEffect.toFixed(0)} from 140)` : ''}
                </div>
              </div>
              <div style={{ padding: '6px 0', borderBottom: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span>Chloride</span>
                  <span style={{ fontWeight: '500', color: clEffect > 2 ? 'var(--warning)' : clEffect < -2 ? 'var(--error)' : 'var(--text-primary)' }}>
                    {clEffect > 2 ? 'Low → alkalosis' : clEffect < -2 ? 'High → acidosis' : 'Normal'}
                  </span>
                </div>
                <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                  Cl⁻ {cl} mmol/L {clEffect !== 0 ? `(${-clEffect > 0 ? '+' : ''}${(-clEffect).toFixed(0)} from 102)` : ''}
                </div>
              </div>
              <div style={{ padding: '6px 0', borderBottom: '1px solid var(--border)' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span>Lactate</span>
                  <span style={{ fontWeight: '500', color: lactate > 2 ? 'var(--error)' : 'var(--text-primary)' }}>
                    {lactate > 2 ? 'Elevated → acidosis' : 'Normal'}
                  </span>
                </div>
                <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                  {lactate.toFixed(1)} mmol/L
                </div>
              </div>
              <div style={{ padding: '6px 0' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span>Albumin</span>
                  <span style={{ fontWeight: '500', color: albumin < 30 ? 'var(--warning)' : 'var(--text-primary)' }}>
                    {albumin < 30 ? 'Low → alkalosis' : 'Normal'}
                  </span>
                </div>
                <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '2px' }}>
                  {albumin} g/L {albumin !== 40 ? `(${albumin > 40 ? '+' : ''}${(albumin - 40).toFixed(0)} from 40)` : ''}
                </div>
              </div>
            </div>
            <ExpandableWorking>
              <p><strong>Free water</strong> — Na⁺ is tightly regulated, so ↑Na⁺ indicates water deficit (concentration alkalosis) and ↓Na⁺ indicates water excess (dilutional acidosis)</p>
              <p><strong>Chloride</strong> — Major SID anion. ↑Cl⁻ directly lowers SID → acidosis. ↓Cl⁻ raises SID → alkalosis</p>
              <p><strong>Lactate</strong> — Strong anion that lowers SID when elevated</p>
              <p><strong>Albumin</strong> — Weak acid buffer. ↓Albumin reduces buffering capacity → apparent alkalosis</p>
            </ExpandableWorking>
          </div>

          {/* SIG */}
          <div style={styles.card} className="animate-in stagger-4">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <div style={styles.resultLabel}>Strong Ion Gap (SIG)</div>
                <div style={{ fontSize: '18px', fontWeight: '600' }}>{SIG.toFixed(1)} mEq/L</div>
              </div>
              <span style={styles.statusBadge(SIG > 2 ? 'error' : 'success')}>
                {SIG > 2 ? 'Elevated' : 'Normal'}
              </span>
            </div>
            <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>
              {SIG > 2 ? 'Unmeasured strong anions present (analogous to HAGMA)' : 'No unmeasured anions'}
            </div>
            <ExpandableWorking>
              <p><Formula>SIG = SIDa − SIDe</Formula></p>
              <p>SIDe = HCO₃ + ATOT = {hco3} + {ATOT.toFixed(1)} = {SIDe.toFixed(1)}</p>
              <p>SIG = {SIDa.toFixed(1)} − {SIDe.toFixed(1)} = {SIG.toFixed(1)}</p>
              <Divider />
              <p style={{ fontSize: '12px' }}>
                ATOT = albumin charge ({albuminCharge.toFixed(1)}) + phosphate charge ({phosphateCharge.toFixed(1)})
              </p>
              <p style={{ fontSize: '12px' }}>Normal SIG {"<"} 2 mEq/L</p>
            </ExpandableWorking>
          </div>

          {/* Contribution Chart */}
          <div style={styles.card} className="animate-in stagger-5">
            <div style={styles.cardTitle}>Contribution Chart</div>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
              Acidosis ← → Alkalosis
            </div>
            
            {(() => {
              const contributions = [
                { label: 'Free water', value: naEffect, threshold: 2 },
                { label: 'Chloride', value: clEffect, threshold: 2 },
                { label: 'Lactate', value: lactateEffect, threshold: 0.5 },
                { label: 'Albumin', value: albuminEffect, threshold: 1 },
                { label: 'Unmeasured anions', value: -(SIG > 2 ? SIG : 0), threshold: 0 },
              ].filter(c => Math.abs(c.value) > c.threshold);
              
              const maxVal = Math.max(10, ...contributions.map(c => Math.abs(c.value)));
              
              return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {contributions.length === 0 ? (
                    <div style={{ fontSize: '14px', color: 'var(--text-secondary)', textAlign: 'center', padding: '12px' }}>
                      No significant metabolic contributions identified
                    </div>
                  ) : (
                    contributions.map((c, i) => (
                      <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div style={{ width: '100px', fontSize: '13px', textAlign: 'right', flexShrink: 0 }}>
                          {c.label}
                        </div>
                        <div style={{ flex: 1, display: 'flex', alignItems: 'center', height: '24px' }}>
                          <div style={{ flex: 1, display: 'flex', justifyContent: 'flex-end' }}>
                            {c.value < 0 && (
                              <div style={{
                                width: `${Math.abs(c.value) / maxVal * 100}%`,
                                height: '20px',
                                background: 'rgba(255, 59, 48, 0.7)',
                                borderRadius: '4px 0 0 4px',
                              }} />
                            )}
                          </div>
                          <div style={{ width: '2px', height: '24px', background: 'var(--border)' }} />
                          <div style={{ flex: 1 }}>
                            {c.value > 0 && (
                              <div style={{
                                width: `${Math.abs(c.value) / maxVal * 100}%`,
                                height: '20px',
                                background: 'rgba(255, 149, 0, 0.7)',
                                borderRadius: '0 4px 4px 0',
                              }} />
                            )}
                          </div>
                        </div>
                        <div style={{ width: '45px', fontSize: '12px', color: 'var(--text-secondary)', flexShrink: 0 }}>
                          {c.value > 0 ? '+' : ''}{c.value.toFixed(1)}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              );
            })()}
          </div>

          {/* Clinical Summary */}
          <div style={styles.card} className="animate-in stagger-6">
            <div style={styles.cardTitle}>Clinical Summary</div>
            <div style={{ fontSize: '15px', lineHeight: '1.7' }}>
              {(() => {
                const findings = [];
                const acidosisDrivers = [];
                const alkalosisDrivers = [];
                
                // Identify drivers
                if (naEffect < -2) acidosisDrivers.push('free water excess (dilutional)');
                if (naEffect > 2) alkalosisDrivers.push('free water deficit (concentration)');
                if (clEffect < -2) acidosisDrivers.push('hyperchloraemia');
                if (clEffect > 2) alkalosisDrivers.push('hypochloraemia');
                if (lactate > 2) acidosisDrivers.push(`elevated lactate (${lactate.toFixed(1)} mmol/L)`);
                if (albumin < 30) alkalosisDrivers.push(`hypoalbuminaemia (${albumin} g/L)`);
                if (SIG > 2) acidosisDrivers.push(`unmeasured anions (SIG ${SIG.toFixed(1)})`);
                
                // Primary disorder statement
                if (pHStatus === 'acidaemia') {
                  findings.push(<span key="primary"><strong>Acidaemia (pH {pH.toFixed(2)})</strong></span>);
                } else if (pHStatus === 'alkalaemia') {
                  findings.push(<span key="primary"><strong>Alkalaemia (pH {pH.toFixed(2)})</strong></span>);
                } else {
                  findings.push(<span key="primary"><strong>Normal pH ({pH.toFixed(2)})</strong></span>);
                }
                
                // Drivers
                if (acidosisDrivers.length > 0) {
                  findings.push(
                    <span key="acidosis"> with acidosis driven by {acidosisDrivers.join(', ')}</span>
                  );
                }
                
                if (alkalosisDrivers.length > 0) {
                  if (acidosisDrivers.length > 0) {
                    findings.push(
                      <span key="alkalosis">, partially offset by {alkalosisDrivers.join(', ')}</span>
                    );
                  } else {
                    findings.push(
                      <span key="alkalosis"> with alkalosis driven by {alkalosisDrivers.join(', ')}</span>
                    );
                  }
                }
                
                if (acidosisDrivers.length === 0 && alkalosisDrivers.length === 0) {
                  findings.push(<span key="none"> — no significant metabolic derangement identified via Stewart analysis</span>);
                }
                
                findings.push(<span key="period">.</span>);
                
                // Respiratory component
                if (isRespiratory) {
                  const respType = isAcidosis ? 'acidosis' : 'alkalosis';
                  findings.push(
                    <span key="resp"><br/><br/>{timing === 'chronic' ? 'Chronic' : 'Acute'} respiratory {respType} (PaCO₂ {paCO2} mmHg) is also present.</span>
                  );
                }
                
                return findings;
              })()}
            </div>
          </div>

          {/* Osmolar Gap (inline for elevated SIG) */}
          {SIG > 2 && (
            <div style={styles.card} className="animate-in stagger-7">
              <div style={styles.cardTitle}>Consider Osmolar Gap</div>
              <div style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
                Elevated osmolar gap suggests foreign solute (toxic alcohols, mannitol, ethanol)
              </div>
              
              <div style={styles.grid}>
                <Input 
                  label="Measured Osm" 
                  unit="mOsm/kg" 
                  value={data.measuredOsm || ''} 
                  onChange={v => setData(prev => ({...prev, measuredOsm: v}))} 
                  placeholder="285"
                />
                <Input 
                  label="Glucose" 
                  unit="mmol/L" 
                  value={data.glucose || ''} 
                  onChange={v => setData(prev => ({...prev, glucose: v}))} 
                  placeholder="5.5"
                />
              </div>
              <Input 
                label="Urea" 
                unit="mmol/L" 
                value={data.urea || ''} 
                onChange={v => setData(prev => ({...prev, urea: v}))} 
                placeholder="5.0"
              />
              
              {data.measuredOsm && data.glucose && data.urea && (() => {
                const measOsm = parseFloat(data.measuredOsm);
                const glucose = parseFloat(data.glucose);
                const urea = parseFloat(data.urea);
                const calcOsm = (2 * na) + glucose + urea;
                const osmGap = measOsm - calcOsm;
                const isElevated = osmGap > 10;
                
                // Save to data for FindCause
                if (data.osmGap !== osmGap) {
                  setTimeout(() => setData(prev => ({...prev, osmGap, ogCalculated: true})), 0);
                }
                
                return (
                  <div style={{ marginTop: '12px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: 'var(--surface)', borderRadius: '8px' }}>
                      <div>
                        <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Osmolar Gap</div>
                        <div style={{ fontSize: '18px', fontWeight: '600' }}>{osmGap.toFixed(0)} mOsm/kg</div>
                      </div>
                      <span style={styles.statusBadge(isElevated ? 'error' : 'success')}>
                        {isElevated ? 'Elevated' : 'Normal'}
                      </span>
                    </div>
                    
                    {isElevated && (
                      <div style={styles.warningBox}>
                        ↑OG + ↑SIG → foreign solute present. Consider toxic alcohols (methanol, ethylene glycol), or check ethanol level.
                      </div>
                    )}
                    
                    {!isElevated && (
                      <div style={styles.infoBox}>
                        Normal OG with ↑SIG → no foreign osmoles. Likely ketoacidosis, lactic acidosis, uraemia, or late-stage toxic alcohol (fully metabolised).
                      </div>
                    )}
                    
                    <ExpandableWorking>
                      <p>Calculated Osm = 2×Na + glucose + urea</p>
                      <p>= 2×{na} + {glucose} + {urea} = {calcOsm.toFixed(0)}</p>
                      <p>OG = {measOsm} − {calcOsm.toFixed(0)} = {osmGap.toFixed(0)}</p>
                      <Divider />
                      <p style={{ fontSize: '12px' }}>Normal OG {"<"} 10 mOsm/kg</p>
                    </ExpandableWorking>
                  </div>
                );
              })()}
              
              {!(data.measuredOsm && data.glucose && data.urea) && (
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontStyle: 'italic', marginTop: '8px' }}>
                  Enter values above to calculate, or skip if not indicated
                </div>
              )}
            </div>
          )}

          <button className="animate-in stagger-4" style={styles.button} onClick={handleNext}>
            Find Cause →
          </button>
        </div>
      );
    };

    // Step 3: Osmolar Gap (optional, for HAGMA)
    const Step3_OsmolarGap = ({ data, setData, onNext, onBack }) => {
      const [wantOG, setWantOG] = useState(null);
      
      const na = parseFloat(data.na);
      const glucose = data.glucose ? parseFloat(data.glucose) : null;
      const urea = data.urea ? parseFloat(data.urea) : null;
      const measuredOsm = data.measuredOsm ? parseFloat(data.measuredOsm) : null;
      
      let osmGap = null;
      let canCalculate = glucose !== null && urea !== null && measuredOsm !== null;
      
      if (canCalculate) {
        const calculatedOsm = (2 * na) + glucose + urea;
        osmGap = measuredOsm - calculatedOsm;
      }

      const highOG = osmGap > 10;
      const highAG = data.isHAGMA;

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 3</div>
            <h1 style={styles.title}>Osmolar Gap</h1>
          </div>

          {wantOG === null && (
            <div style={styles.card} className="animate-in stagger-1">
              <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '14px', lineHeight: '1.5' }}>
                Detects abnormal solutes in plasma. Interpreted alongside the anion gap.
              </p>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                <button
                  style={{ ...styles.button, ...styles.buttonSmall }}
                  onClick={() => setWantOG(true)}
                >
                  Calculate
                </button>
                <button
                  style={{ ...styles.button, ...styles.buttonSmall, ...styles.buttonSecondary }}
                  onClick={() => { setWantOG(false); onNext(); }}
                >
                  Skip
                </button>
              </div>
            </div>
          )}

          {wantOG === true && (
            <>
              <div style={styles.card} className="animate-in stagger-1">
                <div style={styles.grid}>
                  <Input 
                    label="Glucose" 
                    unit="mmol/L" 
                    value={data.glucose || ''} 
                    onChange={v => setData(prev => ({...prev, glucose: v}))} 
                    placeholder="5.5"
                    autoFocus
                  />
                  <Input 
                    label="Urea" 
                    unit="mmol/L" 
                    value={data.urea || ''} 
                    onChange={v => setData(prev => ({...prev, urea: v}))} 
                    placeholder="5.0"
                  />
                </div>
                <Input 
                  label="Measured Osm" 
                  unit="mOsm/kg" 
                  value={data.measuredOsm || ''} 
                  onChange={v => setData(prev => ({...prev, measuredOsm: v}))} 
                  placeholder="285"
                />
              </div>

              {canCalculate && (
                <>
                  <div style={styles.card} className="animate-in">
                    <div style={styles.resultBox}>
                      <div style={styles.resultLabel}>Osmolar Gap</div>
                      <span style={styles.statusBadge(highOG ? 'error' : 'success')}>
                        {osmGap.toFixed(0)} mOsm/kg {highOG ? '(Elevated)' : '(Normal)'}
                      </span>
                    </div>
                    
                    <ExpandableWorking>
                      <p><Formula>OG = Measured − Calculated</Formula></p>
                      <p>Calculated = (2 × Na) + Glucose + Urea</p>
                      <p>= (2 × {na}) + {glucose} + {urea} = {((2 * na) + glucose + urea).toFixed(0)}</p>
                      <p>OG = {measuredOsm} − {((2 * na) + glucose + urea).toFixed(0)} = {osmGap.toFixed(0)}</p>
                      <Divider />
                      <p style={{ fontSize: '12px' }}>Normal {"<"} 10 mOsm/kg</p>
                    </ExpandableWorking>
                  </div>

                  {/* Interpretation based on OG + AG combination */}
                  <div style={styles.card} className="animate-in stagger-2">
                    <div style={styles.cardTitle}>
                      {highOG && highAG && 'High OG + High AG'}
                      {highOG && !highAG && 'High OG + Normal AG'}
                      {!highOG && highAG && 'Normal OG + High AG'}
                      {!highOG && !highAG && 'Normal OG + Normal AG'}
                    </div>
                    
                    {highOG && highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          Foreign solute that has dissociated
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>• Toxic alcohol (mid-stage)</p>
                          <p>• Salicylate intoxication</p>
                          <p>• Lactic acidosis</p>
                          <p>• Ketoacidosis</p>
                          <p>• AKI</p>
                        </div>
                      </>
                    )}
                    
                    {highOG && !highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          Foreign solute that has not dissociated
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>• Mannitol</p>
                          <p>• Ethanol</p>
                          <p>• Toxic alcohol (early)</p>
                          <p>• Glycine (TURP syndrome)</p>
                        </div>
                      </>
                    )}
                    
                    {!highOG && highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          No foreign osmoles — consider other HAGMA causes
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>• Toxic alcohol (late — fully metabolised)</p>
                          <p>• Ketoacidosis</p>
                          <p>• Lactic acidosis</p>
                          <p>• Uraemia</p>
                        </div>
                      </>
                    )}
                    
                    {!highOG && !highAG && (
                      <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                        No evidence of abnormal solute.
                      </p>
                    )}
                  </div>

                  {/* Toxic alcohol timeline */}
                  {highOG && (
                    <div style={styles.card} className="animate-in stagger-3">
                      <div style={styles.cardTitle}>Toxic Alcohol Timeline</div>
                      <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Early</strong> — non-polar, not yet metabolised → ↑OG only</p>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Middle</strong> — partially metabolised to organic acids → ↑OG and ↑AG</p>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Late</strong> — fully metabolised → ↑AG, normal OG</p>
                      </div>
                    </div>
                  )}
                </>
              )}

              <button
                className="animate-in stagger-4"
                style={styles.button}
                onClick={() => {
                  setData(prev => ({ ...prev, osmGap, highOG, ogCalculated: true }));
                  onNext();
                }}
              >
                Find Cause →
              </button>
            </>
          )}
        </div>
      );
    };

    // Find Cause Screen (Step Two)
    // Lactate Causes Screen (sub-screen)
    // ============================================
    // FIND CAUSE - STEPWISE WORKFLOW
    // ============================================

    // Sub-screen: Lactate Causes
    const LactateCausesScreen = ({ onBack }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>HAGMA Workup</div>
          <h1 style={styles.title}>Lactic Acidosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Causes of Elevated Lactate</div>
          <div style={{ fontSize: '14px', lineHeight: '1.9', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Tissue hypoxia (Type A)</strong></p>
            <p style={{ marginLeft: '12px' }}>Hypoxaemia, low cardiac output, severe anaemia, ischaemia, CO poisoning, methaemoglobinaemia</p>
            
            <Divider />
            
            <p><strong style={{ color: 'var(--text-primary)' }}>Non-hypoxic (Type B)</strong></p>
            <p style={{ marginLeft: '12px' }}><strong>B1 Disease:</strong> Liver failure, malignancy, sepsis, thiamine deficiency, ketoacidosis</p>
            <p style={{ marginLeft: '12px' }}><strong>B2 Drugs:</strong> Metformin, propofol infusion, salicylates, paracetamol, linezolid, NRTIs, cyanide</p>
            <p style={{ marginLeft: '12px' }}><strong>B3 Inborn errors:</strong> Mitochondrial myopathies, pyruvate metabolism disorders</p>
            
            <Divider />
            
            <p><strong style={{ color: 'var(--text-primary)' }}>Other</strong></p>
            <p style={{ marginLeft: '12px' }}>Beta-2 agonism (salbutamol), seizures, extreme exercise, excess glucose/sugar</p>
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>Lactate Gap</div>
          <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
            If the cause remains unclear, compare point-of-care and laboratory lactate.
          </p>
          <div style={{ ...styles.resultBox, marginBottom: '12px' }}>
            <strong>POC lactate - Lab lactate &gt; 5 mmol/L</strong>
            <br/>Suggests ethylene glycol poisoning
          </div>
          <ExpandableWorking label="Why this works">
            <p>POC analysers cannot distinguish between lactate and glycolate</p>
            <p>The high lactate reading on the blood gas may actually be glycolate (metabolite of ethylene glycol)</p>
            <Divider />
            <p>Ethylene glycol and methanol are metabolised by alcohol dehydrogenase to toxic metabolites</p>
          </ExpandableWorking>
        </div>

        <button 
          className="animate-in stagger-3"
          style={{ ...styles.button, ...styles.buttonSecondary }}
          onClick={onBack}
        >
          Back to HAGMA Workup
        </button>
      </div>
    );

    // Sub-screen: Osmolar Gap Calculator
    const OsmolarGapScreen = ({ data, setData, onBack }) => {
      const na = parseFloat(data.na) || 140;
      const measOsm = data.measuredOsm ? parseFloat(data.measuredOsm) : null;
      const glucose = data.glucose ? parseFloat(data.glucose) : null;
      const urea = data.urea ? parseFloat(data.urea) : null;
      
      const canCalculate = measOsm !== null && glucose !== null && urea !== null;
      const calcOsm = canCalculate ? (2 * na) + glucose + urea : null;
      const osmGap = canCalculate ? measOsm - calcOsm : null;
      const isElevated = osmGap !== null && osmGap > 10;
      const correctedAG = parseFloat(data.correctedAG) || 12;
      const highAG = correctedAG > 14;
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Toxin Workup</div>
            <h1 style={styles.title}>Osmolar Gap</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
              An elevated osmolar gap indicates unmeasured osmoles — consider toxic alcohols.
            </p>
            
            <div style={styles.grid}>
              <Input 
                label="Measured Osm" 
                unit="mOsm/kg" 
                value={data.measuredOsm || ''} 
                onChange={v => setData(prev => ({...prev, measuredOsm: v}))} 
                placeholder="285"
              />
              <Input 
                label="Glucose" 
                unit="mmol/L" 
                value={data.glucose || ''} 
                onChange={v => setData(prev => ({...prev, glucose: v}))} 
                placeholder="5.5"
              />
            </div>
            <Input 
              label="Urea" 
              unit="mmol/L" 
              value={data.urea || ''} 
              onChange={v => setData(prev => ({...prev, urea: v}))} 
              placeholder="5.0"
            />
            
            {canCalculate && (
              <div style={{ marginTop: '16px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: 'var(--surface)', borderRadius: '8px' }}>
                  <div>
                    <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Osmolar Gap</div>
                    <div style={{ fontSize: '22px', fontWeight: '600' }}>{osmGap.toFixed(0)} mOsm/kg</div>
                  </div>
                  <span style={styles.statusBadge(isElevated ? 'error' : 'success')}>
                    {isElevated ? 'Elevated' : 'Normal'}
                  </span>
                </div>
                
                <ExpandableWorking>
                  <p><Formula>Calculated Osm = 2×Na + Glucose + Urea</Formula></p>
                  <p>= 2×{na} + {glucose} + {urea} = {calcOsm.toFixed(0)}</p>
                  <p>OG = {measOsm} − {calcOsm.toFixed(0)} = {osmGap.toFixed(0)}</p>
                </ExpandableWorking>
              </div>
            )}
          </div>

          {canCalculate && (
            <div style={styles.card} className="animate-in stagger-2">
              <div style={styles.cardTitle}>Interpretation</div>
              
              {isElevated && highAG && (
                <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                  <p style={{ fontStyle: 'italic', marginBottom: '12px' }}>
                    Foreign solute that has dissociated into organic acids
                  </p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Toxic alcohol (mid-stage)</strong> — methanol, ethylene glycol partially metabolised</p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Other</strong> — salicylates, lactic acidosis, ketoacidosis, AKI</p>
                </div>
              )}
              
              {isElevated && !highAG && (
                <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                  <p style={{ fontStyle: 'italic', marginBottom: '12px' }}>
                    Foreign solute that has not yet dissociated
                  </p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Toxic alcohol (early)</strong> — methanol, ethylene glycol not yet metabolised</p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Ethanol</strong> — recent ingestion</p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Mannitol</strong> — therapeutic use</p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Glycine</strong> — TURP syndrome</p>
                </div>
              )}
              
              {!isElevated && highAG && (
                <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                  <p style={{ fontStyle: 'italic', marginBottom: '12px' }}>
                    No foreign osmoles — consider other HAGMA causes
                  </p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Toxic alcohol (late)</strong> — fully metabolised, parent compound gone</p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Ketoacidosis, lactic acidosis, uraemia</strong></p>
                </div>
              )}
              
              {!isElevated && !highAG && (
                <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                  No evidence of abnormal solute load.
                </p>
              )}
            </div>
          )}

          {isElevated && (
            <div style={styles.card} className="animate-in stagger-3">
              <div style={styles.cardTitle}>Toxic Alcohol Timeline</div>
              <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                <p><strong style={{ color: 'var(--text-primary)' }}>Early</strong> — non-polar, not yet metabolised → ↑OG only</p>
                <p><strong style={{ color: 'var(--text-primary)' }}>Middle</strong> — partially metabolised to organic acids → ↑OG and ↑AG</p>
                <p><strong style={{ color: 'var(--text-primary)' }}>Late</strong> — fully metabolised → ↑AG only (OG may normalise)</p>
              </div>
            </div>
          )}

          <button 
            className="animate-in stagger-3"
            style={{ ...styles.button, ...styles.buttonSecondary }}
            onClick={onBack}
          >
            Back to HAGMA Workup
          </button>
        </div>
      );
    };

    // Process Screen: HAGMA Workup
    const HAGMAWorkupScreen = ({ data, setData, onNext, onBack }) => {
      const [subScreen, setSubScreen] = useState(null);
      
      const correctedAG = parseFloat(data.correctedAG) || 12;
      const excessAG = Math.max(0, correctedAG - 12);
      const lactateVal = data.lactate && !isNaN(parseFloat(data.lactate)) ? parseFloat(data.lactate) : null;
      const lactateContribution = lactateVal !== null && lactateVal > 1 ? lactateVal - 1 : 0;
      const ketonesVal = data.ketones && !isNaN(parseFloat(data.ketones)) ? parseFloat(data.ketones) : null;
      const ketoneContribution = ketonesVal !== null && ketonesVal > 0.6 ? ketonesVal - 0.6 : 0;
      const explainedAG = lactateContribution + ketoneContribution;
      const unexplainedAG = Math.max(0, excessAG - explainedAG);
      const hasUnexplainedGap = unexplainedAG > 1;
      const hasAnyInput = lactateVal !== null || ketonesVal !== null;
      
      if (subScreen === 'lactate') {
        return <LactateCausesScreen onBack={() => setSubScreen(null)} />;
      }
      if (subScreen === 'osmolar') {
        return <OsmolarGapScreen data={data} setData={setData} onBack={() => setSubScreen(null)} />;
      }
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process 1</div>
            <h1 style={styles.title}>HAGMA Workup</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ background: 'var(--surface)', borderRadius: '8px', padding: '12px', marginBottom: '16px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ fontSize: '14px' }}>Excess anion gap</span>
                <span style={{ fontSize: '20px', fontWeight: '600', color: 'var(--error)' }}>+{excessAG.toFixed(1)} mEq/L</span>
              </div>
            </div>
            
            <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
              Quantify how much of the excess AG is explained by lactate and ketones.
            </p>
            
            <div style={{ marginBottom: '12px' }}>
              <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end' }}>
                <div style={{ flex: 1 }}>
                  <Input 
                    label="Lactate" 
                    unit="mmol/L" 
                    value={data.lactate || ''} 
                    onChange={v => setData(prev => ({...prev, lactate: v}))} 
                    placeholder="Enter value"
                  />
                </div>
                {lactateVal !== null && lactateVal >= 0 && (
                  <div style={{ padding: '8px 12px', background: 'var(--surface)', borderRadius: '8px', whiteSpace: 'nowrap', marginBottom: '8px' }}>
                    <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Accounts for </span>
                    <span style={{ fontSize: '15px', fontWeight: '600' }}>+{lactateContribution.toFixed(1)}</span>
                  </div>
                )}
              </div>
              {lactateVal !== null && lactateVal > 2 && (
                <button 
                  style={{ ...styles.buttonSmall, marginTop: '8px', background: 'var(--surface)', color: 'var(--accent)', border: '1px solid var(--border)' }}
                  onClick={() => setSubScreen('lactate')}
                >
                  Explore lactate causes →
                </button>
              )}
            </div>
            
            <div style={{ marginBottom: '16px' }}>
              <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end' }}>
                <div style={{ flex: 1 }}>
                  <Input 
                    label="Beta-hydroxybutyrate" 
                    unit="mmol/L" 
                    value={data.ketones || ''} 
                    onChange={v => setData(prev => ({...prev, ketones: v}))} 
                    placeholder="Enter value"
                  />
                </div>
                {ketonesVal !== null && ketonesVal >= 0 && (
                  <div style={{ padding: '8px 12px', background: 'var(--surface)', borderRadius: '8px', whiteSpace: 'nowrap', marginBottom: '8px' }}>
                    <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Accounts for </span>
                    <span style={{ fontSize: '15px', fontWeight: '600' }}>+{ketoneContribution.toFixed(1)}</span>
                  </div>
                )}
              </div>
              {ketonesVal !== null && ketonesVal > 1 && (
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '6px' }}>
                  Consider: DKA, alcoholic ketoacidosis, starvation ketosis
                </div>
              )}
            </div>
            
            {hasAnyInput && !hasUnexplainedGap && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: 'rgba(52, 199, 89, 0.1)', borderRadius: '8px' }}>
                <div>
                  <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Unexplained AG</div>
                  <div style={{ fontSize: '18px', fontWeight: '600', color: 'var(--success)' }}>
                    {unexplainedAG.toFixed(1)} mEq/L
                  </div>
                </div>
                <span style={styles.statusBadge('success')}>Accounted for</span>
              </div>
            )}
            
            {hasAnyInput && hasUnexplainedGap && (
              <div style={{ padding: '12px', background: 'rgba(255, 149, 0, 0.1)', borderRadius: '8px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>Unexplained AG</div>
                    <div style={{ fontSize: '18px', fontWeight: '600', color: 'var(--warning)' }}>
                      {unexplainedAG.toFixed(1)} mEq/L
                    </div>
                  </div>
                </div>
                <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '8px', marginBottom: '0' }}>
                  Lactate and ketones do not fully explain the elevated AG. Consider other causes below.
                </p>
              </div>
            )}
            
            {!hasAnyInput && (
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                Enter lactate and ketones to quantify their contribution
              </div>
            )}
          </div>

          {hasAnyInput && hasUnexplainedGap && (
            <div style={styles.card} className="animate-in stagger-2">
              <div style={styles.cardTitle}>Other Causes of Elevated AG</div>
              <div style={{ fontSize: '14px', lineHeight: '2', color: 'var(--text-secondary)' }}>
                <p><strong style={{ color: 'var(--text-primary)' }}>Renal failure</strong> — accumulation of sulphates, phosphates, organic anions</p>
                <p><strong style={{ color: 'var(--text-primary)' }}>D-lactic acidosis</strong> — short gut syndrome, jejunoileal bypass (not detected by standard lactate assay)</p>
                <p><strong style={{ color: 'var(--text-primary)' }}>Pyroglutamic acid</strong> — chronic paracetamol + malnourished/septic</p>
                <p><strong style={{ color: 'var(--text-primary)' }}>Toxins</strong> — salicylates, toxic alcohols</p>
              </div>
              
              <button 
                style={{ ...styles.button, marginTop: '16px', background: 'var(--surface)', color: 'var(--text-primary)', border: '1px solid var(--border)' }}
                onClick={() => setSubScreen('osmolar')}
              >
                Check Osmolar Gap →
              </button>
            </div>
          )}

          <button
            className="animate-in stagger-3"
            style={{ ...styles.button, marginTop: '20px' }}
            onClick={onNext}
          >
            Continue →
          </button>
        </div>
      );
    };

    // Process Screen: NAGMA
    const NAGMAScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>NAGMA</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Differential Diagnosis</div>
          <div style={{ fontSize: '14px', lineHeight: '2', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>GI loss of HCO₃⁻</strong> — diarrhoea, fistula, ileostomy, ureteric diversion</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Renal loss of HCO₃⁻</strong> — renal tubular acidosis (types 1, 2, 4)</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Chloride excess</strong> — NaCl infusion, TPN</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Early renal failure</strong> — before anion accumulation</p>
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>RTA Differentiation</div>
          <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
            Calculate urine osmolar gap to assess renal NH₄⁺ excretion:
          </p>
          <div style={{ ...styles.resultBox, marginBottom: '12px' }}>
            <Formula>UOG = Measured urine osm − (2×[Na+K] + urea + glucose)</Formula>
          </div>
          <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
            <p><strong>UOG &lt; 150:</strong> impaired NH₄⁺ excretion → Type 1 or 4 RTA</p>
            <p><strong>UOG &gt; 150:</strong> Type 2 RTA or non-RTA cause</p>
          </div>
          <Divider />
          <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Type 1 (distal)</strong> — hypokalaemia, urine pH &gt;5.3</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Type 2 (proximal)</strong> — hypokalaemia, urine pH variable</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Type 4 (hypoaldo)</strong> — hyperkalaemia, urine pH &lt;5.5</p>
          </div>
        </div>

        <button
          className="animate-in stagger-3"
          style={{ ...styles.button, marginTop: '20px' }}
          onClick={onNext}
        >
          Continue →
        </button>
      </div>
    );

    // Process Screen: Metabolic Alkalosis
    const MetAlkalosisScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>Metabolic Alkalosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Classification by Urine Chloride</div>
          <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
            Check spot urine chloride to guide management.
          </p>
          
          <div style={{ marginBottom: '16px' }}>
            <div style={{ fontWeight: '600', color: 'var(--text-primary)', marginBottom: '8px' }}>Chloride responsive (urine Cl &lt; 20 mmol/L)</div>
            <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)', marginLeft: '12px' }}>
              <p>• Vomiting, NG suction</p>
              <p>• Diuretics (post-use)</p>
              <p>• Post-hypercapnia</p>
              <p style={{ marginTop: '8px', fontStyle: 'italic' }}>Treatment: Volume repletion with NaCl</p>
            </div>
          </div>
          
          <Divider />
          
          <div style={{ marginTop: '16px' }}>
            <div style={{ fontWeight: '600', color: 'var(--text-primary)', marginBottom: '8px' }}>Chloride resistant (urine Cl &gt; 20 mmol/L)</div>
            <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)', marginLeft: '12px' }}>
              <p>• Primary hyperaldosteronism</p>
              <p>• Cushing syndrome</p>
              <p>• Bartter / Gitelman syndrome</p>
              <p>• Severe hypokalaemia</p>
              <p style={{ marginTop: '8px', fontStyle: 'italic' }}>Treatment: Address underlying cause</p>
            </div>
          </div>
        </div>

        <button
          className="animate-in stagger-2"
          style={{ ...styles.button, marginTop: '20px' }}
          onClick={onNext}
        >
          Continue →
        </button>
      </div>
    );

    // Process Screen: Respiratory Acidosis
    const RespAcidosisScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>Respiratory Acidosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Differential Diagnosis</div>
          <div style={{ fontSize: '14px', lineHeight: '2', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Airway</strong> — obstruction, severe asthma, COPD exacerbation</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Parenchymal</strong> — pneumonia, pulmonary oedema, ARDS, pulmonary fibrosis</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Neuromuscular</strong> — Guillain-Barré, MND, myasthenia gravis, spinal cord injury</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>CNS depression</strong> — opioids, sedatives, stroke, raised ICP, encephalitis</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Chest wall</strong> — flail chest, kyphoscoliosis, obesity hypoventilation</p>
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>Acute vs Chronic</div>
          <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
            <p><strong>Acute:</strong> Expected HCO₃ rise of 1 mmol/L per 10 mmHg ↑PaCO₂</p>
            <p><strong>Chronic:</strong> Expected HCO₃ rise of 3.5 mmol/L per 10 mmHg ↑PaCO₂</p>
            <p style={{ marginTop: '8px', fontStyle: 'italic' }}>If HCO₃ higher than expected → concurrent metabolic alkalosis</p>
            <p style={{ fontStyle: 'italic' }}>If HCO₃ lower than expected → concurrent metabolic acidosis</p>
          </div>
        </div>

        <button
          className="animate-in stagger-3"
          style={{ ...styles.button, marginTop: '20px' }}
          onClick={onNext}
        >
          Continue →
        </button>
      </div>
    );

    // Process Screen: Respiratory Alkalosis
    const RespAlkalosisScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>Respiratory Alkalosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Differential Diagnosis</div>
          <div style={{ fontSize: '14px', lineHeight: '2', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Hypoxia-driven</strong> — PE, pneumonia, altitude, severe anaemia, R-L shunt</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>CNS stimulation</strong> — anxiety, pain, fever, sepsis (early), CVA, meningitis</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Metabolic</strong> — liver failure (↓urea cycle), pregnancy (progesterone), salicylates (early)</p>
            <p><strong style={{ color: 'var(--text-primary)' }}>Iatrogenic</strong> — mechanical overventilation</p>
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>Acute vs Chronic</div>
          <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
            <p><strong>Acute:</strong> Expected HCO₃ fall of 2 mmol/L per 10 mmHg ↓PaCO₂</p>
            <p><strong>Chronic:</strong> Expected HCO₃ fall of 5 mmol/L per 10 mmHg ↓PaCO₂</p>
            <p style={{ marginTop: '8px', fontStyle: 'italic' }}>If HCO₃ higher than expected → concurrent metabolic alkalosis</p>
            <p style={{ fontStyle: 'italic' }}>If HCO₃ lower than expected → concurrent metabolic acidosis</p>
          </div>
        </div>

        <button
          className="animate-in stagger-3"
          style={{ ...styles.button, marginTop: '20px' }}
          onClick={onNext}
        >
          Continue →
        </button>
      </div>
    );

    // Summary Screen
    const SummaryScreen = ({ data, processes, approach, onRestart, onSwitchToStewart }) => (
      <div style={styles.container}>
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Complete</div>
          <h1 style={styles.title}>Summary</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Identified Processes</div>
          <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
            {processes.map((p, i) => (
              <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '6px 0' }}>
                <span style={{ color: 'var(--success)', fontSize: '16px' }}>✓</span>
                <span>{p.label}</span>
              </div>
            ))}
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>Key Values</div>
          <div style={{ fontSize: '14px', lineHeight: '1.8' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
              <span style={{ color: 'var(--text-secondary)' }}>pH</span>
              <span style={{ fontWeight: '500' }}>{data.pH}</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
              <span style={{ color: 'var(--text-secondary)' }}>PaCO₂</span>
              <span style={{ fontWeight: '500' }}>{data.paCO2} mmHg</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
              <span style={{ color: 'var(--text-secondary)' }}>HCO₃</span>
              <span style={{ fontWeight: '500' }}>{data.hco3} mmol/L</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
              <span style={{ color: 'var(--text-secondary)' }}>Corrected AG</span>
              <span style={{ fontWeight: '500' }}>{parseFloat(data.correctedAG).toFixed(1)} mEq/L</span>
            </div>
            {data.lactate && (
              <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
                <span style={{ color: 'var(--text-secondary)' }}>Lactate</span>
                <span style={{ fontWeight: '500' }}>{data.lactate} mmol/L</span>
              </div>
            )}
          </div>
        </div>

        {data.compensationResult && (
          <div style={styles.card} className="animate-in stagger-3">
            <div style={styles.cardTitle}>Compensation</div>
            <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>{data.compensationResult}</p>
          </div>
        )}

        {approach === 'traditional' && (
          <button
            className="animate-in stagger-4"
            style={{ ...styles.button, marginTop: '20px' }}
            onClick={onSwitchToStewart}
          >
            Analyse with Physicochemical →
          </button>
        )}

        <button
          className="animate-in stagger-4"
          style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '10px' }}
          onClick={onRestart}
        >
          New Analysis
        </button>

        <div style={{ textAlign: 'center', padding: '20px 16px 8px', fontSize: '11px', color: 'var(--text-tertiary)' }}>
          For educational purposes only. Not a substitute for clinical judgement.<br/>
          © 2025 Scott Santinon
        </div>
      </div>
    );

    // Main Find Cause Controller
    const FindCauseScreen = ({ data, setData, approach, onBack, onRestart, onSwitchToStewart }) => {
      const [currentStep, setCurrentStep] = useState('overview'); // overview, process-0, process-1, ..., summary
      
      // Identify all processes
      const processes = [];
      const isMixedPrimary = data.isMetabolic && data.isRespiratory;
      
      if (data.isHAGMA) {
        processes.push({ type: 'hagma', label: 'High anion gap metabolic acidosis' });
        if (data.deltaInterpretation === 'Mixed HAGMA + NAGMA' || data.deltaInterpretation === 'Concurrent NAGMA') {
          processes.push({ type: 'nagma', label: 'Normal anion gap metabolic acidosis' });
        } else if (data.deltaInterpretation === 'HAGMA + metabolic alkalosis') {
          processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
        }
      } else if (data.isMetabolic && data.isAcidosis) {
        processes.push({ type: 'nagma', label: 'Normal anion gap metabolic acidosis' });
      } else if (data.isMetabolic && data.isAlkalosis) {
        processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
      }
      
      if (data.isRespiratory) {
        if (data.isAcidosis || data.pHStatus === 'acidaemia' || (data.primaryDisorder && data.primaryDisorder.toLowerCase().includes('acidosis'))) {
          processes.push({ type: 'respacidosis', label: 'Respiratory acidosis' });
        }
        if (data.isAlkalosis || data.pHStatus === 'alkalaemia' || (data.primaryDisorder && data.primaryDisorder.toLowerCase().includes('alkalosis'))) {
          processes.push({ type: 'respalkalosis', label: 'Respiratory alkalosis' });
        }
      }
      
      if (!isMixedPrimary && data.compensationResult) {
        if (data.compensationResult.includes('Additional respiratory acidosis')) {
          processes.push({ type: 'respacidosis', label: 'Respiratory acidosis' });
        } else if (data.compensationResult.includes('Additional respiratory alkalosis')) {
          processes.push({ type: 'respalkalosis', label: 'Respiratory alkalosis' });
        } else if (data.compensationResult.includes('Additional metabolic acidosis')) {
          processes.push({ type: 'nagma', label: 'Metabolic acidosis' });
        } else if (data.compensationResult.includes('Additional metabolic alkalosis')) {
          processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
        }
      }
      
      const uniqueProcesses = processes.filter((d, i, arr) => arr.findIndex(x => x.type === d.type) === i);
      
      // Navigation helpers
      const goToNextProcess = (currentIndex) => {
        if (currentIndex + 1 < uniqueProcesses.length) {
          setCurrentStep(`process-${currentIndex + 1}`);
        } else {
          setCurrentStep('summary');
        }
      };
      
      const goToPrevProcess = (currentIndex) => {
        if (currentIndex > 0) {
          setCurrentStep(`process-${currentIndex - 1}`);
        } else {
          setCurrentStep('overview');
        }
      };
      
      // Overview screen
      if (currentStep === 'overview') {
        const normalPH = data.pHStatus === 'normal';
        const hiddenHAGMA = normalPH && data.isHAGMA;
        
        return (
          <div style={styles.container}>
            <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
            
            <div style={styles.header} className="animate-in">
              <div style={styles.stepIndicator}>Differential</div>
              <h1 style={styles.title}>Find Cause</h1>
            </div>

            <div style={styles.card} className="animate-in stagger-1">
              <div style={styles.cardTitle}>Processes to Investigate</div>
              <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                {uniqueProcesses.map((d, i) => (
                  <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '6px 0' }}>
                    <span style={{ width: '24px', height: '24px', borderRadius: '50%', background: 'var(--accent)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '13px', fontWeight: '600' }}>{i + 1}</span>
                    <span>{d.label}</span>
                  </div>
                ))}
                {uniqueProcesses.length === 0 && (
                  <span style={{ color: 'var(--text-secondary)' }}>Normal acid-base status</span>
                )}
              </div>
            </div>

            {hiddenHAGMA && (
              <div style={{ ...styles.warningBox, margin: '0 0 16px 0' }} className="animate-in stagger-1">
                <strong>Hidden HAGMA detected</strong><br/>
                Normal pH with elevated anion gap — suggests mixed disorder or early/compensated process
              </div>
            )}

            {uniqueProcesses.length > 0 ? (
              <button
                className="animate-in stagger-2"
                style={{ ...styles.button, marginTop: '20px' }}
                onClick={() => setCurrentStep('process-0')}
              >
                Begin Investigation →
              </button>
            ) : (
              <>
                <div style={styles.card} className="animate-in stagger-2">
                  <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                    pH, HCO₃, PaCO₂, and anion gap are within normal limits.
                  </p>
                  <div style={styles.infoBox}>
                    If clinical suspicion remains, consider repeat testing or venous blood gas.
                  </div>
                </div>
                <button
                  className="animate-in stagger-3"
                  style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '20px' }}
                  onClick={onRestart}
                >
                  New Analysis
                </button>
              </>
            )}
          </div>
        );
      }
      
      // Summary screen
      if (currentStep === 'summary') {
        return (
          <SummaryScreen 
            data={data}
            processes={uniqueProcesses}
            approach={approach}
            onRestart={onRestart}
            onSwitchToStewart={onSwitchToStewart}
          />
        );
      }
      
      // Process screens
      const processIndex = parseInt(currentStep.split('-')[1]);
      const currentProcess = uniqueProcesses[processIndex];
      const processNumber = processIndex + 1;
      
      if (!currentProcess) {
        setCurrentStep('summary');
        return null;
      }
      
      switch (currentProcess.type) {
        case 'hagma':
          return (
            <HAGMAWorkupScreen 
              data={data}
              setData={setData}
              onNext={() => goToNextProcess(processIndex)}
              onBack={() => goToPrevProcess(processIndex)}
            />
          );
        case 'nagma':
          return (
            <NAGMAScreen 
              processNumber={processNumber}
              onNext={() => goToNextProcess(processIndex)}
              onBack={() => goToPrevProcess(processIndex)}
            />
          );
        case 'metalkalosis':
          return (
            <MetAlkalosisScreen 
              processNumber={processNumber}
              onNext={() => goToNextProcess(processIndex)}
              onBack={() => goToPrevProcess(processIndex)}
            />
          );
        case 'respacidosis':
          return (
            <RespAcidosisScreen 
              processNumber={processNumber}
              onNext={() => goToNextProcess(processIndex)}
              onBack={() => goToPrevProcess(processIndex)}
            />
          );
        case 'respalkalosis':
          return (
            <RespAlkalosisScreen 
              processNumber={processNumber}
              onNext={() => goToNextProcess(processIndex)}
              onBack={() => goToPrevProcess(processIndex)}
            />
          );
        default:
          return null;
      }
    };

    // MAIN APP
    // ============================================

    const App = () => {
      const [approach, setApproach] = useState(null);
      const [step, setStep] = useState(0);
      const [data, setData] = useState({});
      const [showFindCause, setShowFindCause] = useState(false);

      const handleRestart = () => {
        setApproach(null);
        setStep(0);
        setData({});
        setShowFindCause(false);
      };

      const handleSwitchToStewart = () => {
        // Keep input data, switch to Stewart
        // Go to step 1 to let them fill in K, Ca, Mg, lactate, phosphate if needed
        // Data is preserved so basic values won't need re-entry
        setApproach('stewart');
        setShowFindCause(false);
        setStep(1);
      };

      const handleBackFromFindCause = () => {
        setShowFindCause(false);
        setStep(2);
      };

      // Landing
      if (!approach) {
        return <LandingScreen onSelect={(a) => { setApproach(a); setStep(1); }} />;
      }

      // Find Cause screen
      if (showFindCause) {
        return (
          <FindCauseScreen 
            data={data}
            setData={setData}
            approach={approach}
            onBack={handleBackFromFindCause} 
            onRestart={handleRestart}
            onSwitchToStewart={handleSwitchToStewart}
          />
        );
      }

      // Traditional pathway - condensed flow
      if (approach === 'traditional') {
        switch (step) {
          case 1:
            return <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />;
          case 2:
            return <Step2_FullAnalysis 
              data={data} 
              setData={setData} 
              onNext={() => setShowFindCause(true)} 
              onBack={() => setStep(1)} 
            />;
        }
      }

      // Stewart/Physicochemical pathway
      if (approach === 'stewart') {
        switch (step) {
          case 1:
            return <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />;
          case 2:
            return <Step2_StewartAnalysis 
              data={data} 
              setData={setData} 
              onNext={() => setShowFindCause(true)} 
              onBack={() => setStep(1)} 
            />;
        }
      }

      // Both - show traditional then can switch to Stewart
      if (approach === 'both') {
        switch (step) {
          case 1:
            return <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />;
          case 2:
            return <Step2_FullAnalysis 
              data={data} 
              setData={setData} 
              onNext={() => setShowFindCause(true)} 
              onBack={() => setStep(1)} 
            />;
        }
      }

      return null;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
