<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Acid Base Pro</title>
  <meta name="author" content="Scott Santinon">
  <meta name="description" content="Systematic arterial blood gas interpretation tool supporting Traditional (Henderson-Hasselbalch) and Physicochemical (Stewart) approaches">
  <meta name="copyright" content="© 2025 Scott Santinon">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#FAFAFA">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: #FAFAFA;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F0F0F5;
      --text-primary: #000000;
      --text-secondary: #6E6E73;
      --text-tertiary: #AEAEB2;
      --accent: #0066CC;
      --accent-light: rgba(0, 102, 204, 0.08);
      --success: #30D158;
      --success-light: rgba(48, 209, 88, 0.12);
      --warning: #FF9F0A;
      --warning-light: rgba(255, 159, 10, 0.12);
      --error: #FF453A;
      --error-light: rgba(255, 69, 58, 0.12);
      --border: rgba(0, 0, 0, 0.04);
      --border-strong: rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 0 0 1px rgba(0,0,0,0.03), 0 2px 4px rgba(0,0,0,0.02);
      --shadow-md: 0 0 0 1px rgba(0,0,0,0.03), 0 4px 12px rgba(0,0,0,0.05);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --transition: 0.2s ease;
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.47059;
      min-height: 100vh;
      min-height: 100dvh;
      letter-spacing: -0.022em;
    }

    #root {
      min-height: 100vh;
      min-height: 100dvh;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 3px; }

    input[type="number"] { -moz-appearance: textfield; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in { animation: fadeIn 0.35s ease-out forwards; }
    .stagger-1 { animation-delay: 0.05s; opacity: 0; }
    .stagger-2 { animation-delay: 0.1s; opacity: 0; }
    .stagger-3 { animation-delay: 0.15s; opacity: 0; }
    .stagger-4 { animation-delay: 0.2s; opacity: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useRef } = React;

    // ============================================
    // CONSTANTS
    // ============================================

    const DEFAULTS = {
      albumin: 40,
      phosphate: 1.1,
      calcium: 1.15,
      magnesium: 0.85,
      lactate: 1.0,
      k: 4.0,
    };

    // ============================================
    // STYLES
    // ============================================

    const styles = {
      container: {
        minHeight: '100vh',
        minHeight: '100dvh',
        padding: '12px',
        paddingBottom: '32px',
        maxWidth: '440px',
        margin: '0 auto',
      },
      header: {
        textAlign: 'center',
        marginBottom: '20px',
        paddingTop: '8px',
      },
      stepIndicator: {
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '1px',
        color: 'var(--accent)',
        textTransform: 'uppercase',
        marginBottom: '4px',
      },
      title: {
        fontSize: '26px',
        fontWeight: '700',
        letterSpacing: '-0.5px',
        color: 'var(--text-primary)',
        marginBottom: '4px',
      },
      subtitle: {
        fontSize: '14px',
        color: 'var(--text-secondary)',
        fontWeight: '400',
      },
      card: {
        background: 'var(--bg-secondary)',
        borderRadius: 'var(--radius-md)',
        padding: '16px',
        marginBottom: '10px',
        boxShadow: 'var(--shadow-sm)',
      },
      cardTitle: {
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '0.8px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '12px',
      },
      inputGroup: {
        marginBottom: '12px',
      },
      inputLabel: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '5px',
      },
      labelText: {
        fontSize: '13px',
        fontWeight: '500',
        color: 'var(--text-primary)',
      },
      labelUnit: {
        fontSize: '11px',
        color: 'var(--text-secondary)',
      },
      input: {
        width: '100%',
        padding: '10px 12px',
        border: '1px solid var(--border-strong)',
        borderRadius: 'var(--radius-sm)',
        fontSize: '16px',
        fontFamily: 'var(--font)',
        color: 'var(--text-primary)',
        background: 'var(--bg-tertiary)',
        transition: 'all var(--transition)',
        outline: 'none',
      },
      defaultBadge: {
        display: 'inline-flex',
        alignItems: 'center',
        padding: '2px 6px',
        background: 'var(--warning-light)',
        color: 'var(--warning)',
        borderRadius: '4px',
        fontSize: '10px',
        fontWeight: '600',
        marginLeft: '8px',
      },
      button: {
        width: '100%',
        padding: '12px 18px',
        border: 'none',
        borderRadius: 'var(--radius-sm)',
        background: 'var(--accent)',
        color: 'white',
        fontSize: '15px',
        fontWeight: '600',
        fontFamily: 'var(--font)',
        cursor: 'pointer',
        transition: 'all var(--transition)',
      },
      buttonSecondary: {
        background: 'var(--bg-tertiary)',
        color: 'var(--text-primary)',
      },
      buttonDisabled: {
        opacity: 0.4,
        cursor: 'not-allowed',
      },
      buttonSmall: {
        padding: '8px 14px',
        fontSize: '14px',
        width: 'auto',
        display: 'inline-flex',
        borderRadius: '8px',
      },
      resultBox: {
        padding: '12px',
        background: 'var(--bg-tertiary)',
        borderRadius: 'var(--radius-sm)',
        marginBottom: '10px',
      },
      resultLabel: {
        fontSize: '11px',
        fontWeight: '600',
        letterSpacing: '0.5px',
        color: 'var(--text-secondary)',
        textTransform: 'uppercase',
        marginBottom: '2px',
      },
      resultValue: {
        fontSize: '18px',
        fontWeight: '600',
        color: 'var(--text-primary)',
      },
      statusBadge: (type) => ({
        display: 'inline-flex',
        alignItems: 'center',
        padding: '5px 10px',
        borderRadius: '6px',
        fontSize: '13px',
        fontWeight: '600',
        background: type === 'error' ? 'var(--error-light)' :
                   type === 'warning' ? 'var(--warning-light)' :
                   type === 'success' ? 'var(--success-light)' :
                   'var(--accent-light)',
        color: type === 'error' ? 'var(--error)' :
               type === 'warning' ? 'var(--warning)' :
               type === 'success' ? 'var(--success)' :
               'var(--accent)',
      }),
      divider: {
        height: '1px',
        background: 'var(--border-strong)',
        margin: '12px 0',
      },
      grid: {
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '8px',
      },
      backButton: {
        display: 'inline-flex',
        alignItems: 'center',
        gap: '2px',
        background: 'none',
        border: 'none',
        color: 'var(--accent)',
        fontSize: '15px',
        fontWeight: '400',
        cursor: 'pointer',
        padding: '0',
        marginBottom: '12px',
        fontFamily: 'var(--font)',
      },
      expandHeader: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        cursor: 'pointer',
        padding: '10px 0',
      },
      chevron: (expanded) => ({
        width: '18px',
        height: '18px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'var(--text-tertiary)',
        transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)',
        transition: 'transform var(--transition)',
      }),
      workingContent: {
        fontSize: '12px',
        color: 'var(--text-secondary)',
        lineHeight: '1.5',
        paddingTop: '10px',
        borderTop: '1px solid var(--border)',
      },
      formula: {
        fontFamily: 'ui-monospace, SF Mono, Monaco, monospace',
        fontSize: '11px',
        background: 'var(--accent-light)',
        padding: '2px 6px',
        borderRadius: '4px',
        color: 'var(--accent)',
      },
      valueRow: {
        display: 'flex',
        justifyContent: 'space-between',
        padding: '5px 0',
        borderBottom: '1px solid var(--border)',
        fontSize: '13px',
      },
      optionCard: {
        padding: '14px',
        background: 'var(--bg-tertiary)',
        borderRadius: 'var(--radius-sm)',
        cursor: 'pointer',
        transition: 'all var(--transition)',
        marginBottom: '8px',
      },
      optionCardSelected: {
        background: 'var(--accent-light)',
        boxShadow: 'inset 0 0 0 2px var(--accent)',
      },
      optionTitle: {
        fontSize: '15px',
        fontWeight: '600',
        marginBottom: '2px',
      },
      optionDesc: {
        fontSize: '12px',
        color: 'var(--text-secondary)',
        lineHeight: '1.3',
      },
      infoBox: {
        padding: '10px 12px',
        background: 'var(--accent-light)',
        borderRadius: '8px',
        fontSize: '12px',
        color: 'var(--text-secondary)',
        lineHeight: '1.4',
        marginTop: '10px',
      },
      warningBox: {
        padding: '10px 12px',
        background: 'var(--warning-light)',
        borderRadius: '8px',
        fontSize: '12px',
        color: 'var(--text-primary)',
        lineHeight: '1.4',
        marginTop: '10px',
      },
      summaryRow: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '8px 0',
        borderBottom: '1px solid var(--border)',
      },
    };

    // ============================================
    // COMPONENTS
    // ============================================

    const ChevronIcon = () => (
      <svg width="10" height="6" viewBox="0 0 10 6" fill="none">
        <path d="M1 1L5 5L9 1" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );

    const BackIcon = () => (
      <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
        <path d="M7 1L1 7L7 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );

    // Progress bar component - accepts either percent or current/total
    const ProgressBar = ({ percent, current, total }) => {
      const width = percent !== undefined ? percent : (current / total) * 100;
      return (
        <div style={{ 
          position: 'fixed', 
          top: 0, 
          left: 0, 
          right: 0, 
          height: '4px', 
          background: 'var(--bg-tertiary)', 
          zIndex: 100,
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        }}>
          <div style={{ 
            height: '100%', 
            width: `${width}%`, 
            background: 'linear-gradient(90deg, var(--accent), #34C759)', 
            transition: 'width 0.3s ease',
            borderRadius: '0 2px 2px 0',
            boxShadow: '0 0 8px rgba(0, 122, 255, 0.4)'
          }} />
        </div>
      );
    };

    const Input = ({ label, unit, value, onChange, placeholder, isDefault, defaultValue, autoFocus, warning, expectedLength, onComplete, inputRef }) => {
      const [focused, setFocused] = useState(false);
      const [touched, setTouched] = useState(false);
      // Only show warning after blur AND value exists AND value looks complete (not mid-typing)
      const strValue = value ? String(value) : '';
      const looksComplete = strValue && (strValue.length >= 2 || parseFloat(strValue) >= 10);
      const hasWarning = warning && touched && looksComplete;
      const ref = useRef(null);
      
      // Auto-advance when expected digits reached
      const handleChange = (e) => {
        const newValue = e.target.value;
        onChange(newValue);
        
        // Check if we should auto-advance (when value looks complete)
        if (expectedLength && onComplete && newValue.length >= expectedLength) {
          // Small delay to let the value update visually
          setTimeout(() => onComplete(), 50);
        }
      };
      
      const handleBlur = () => {
        setFocused(false);
        setTouched(true);
      };
      
      // Expose ref for focus management
      React.useImperativeHandle(inputRef, () => ({
        focus: () => ref.current?.focus()
      }));
      
      return (
        <div style={{ marginBottom: '10px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
            <span style={{ fontSize: '13px', fontWeight: '500', color: 'var(--text-primary)' }}>
              {label}
              {isDefault && strValue === '' && <span style={styles.defaultBadge}>Default: {defaultValue}</span>}
            </span>
            {unit && <span style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>{unit}</span>}
          </div>
          <input
            ref={ref}
            type="number"
            step="any"
            inputMode="decimal"
            autoFocus={autoFocus}
            style={{
              width: '100%',
              padding: '10px 12px',
              border: '1.5px solid var(--border-strong)',
              borderRadius: '10px',
              fontSize: '17px',
              fontWeight: '500',
              fontFamily: 'var(--font)',
              color: 'var(--text-primary)',
              background: 'var(--bg-secondary)',
              outline: 'none',
              borderColor: hasWarning ? 'var(--warning)' : focused ? 'var(--accent)' : 'var(--border-strong)',
              boxShadow: focused ? '0 0 0 3px var(--accent-light)' : 'none',
              transition: 'all 0.15s ease',
            }}
            value={strValue}
            onChange={handleChange}
            onFocus={() => setFocused(true)}
            onBlur={handleBlur}
            placeholder={placeholder || (isDefault ? `${defaultValue}` : '')}
          />
          {hasWarning && (
            <div style={{ fontSize: '11px', color: 'var(--warning)', marginTop: '3px' }}>⚠️ {warning}</div>
          )}
        </div>
      );
    };

    const ExpandableWorking = ({ children, label = "Show working" }) => {
      const [expanded, setExpanded] = useState(false);
      
      return (
        <div>
          <div style={styles.expandHeader} onClick={() => setExpanded(!expanded)}>
            <span style={{ fontSize: '12px', color: 'var(--text-tertiary)', fontWeight: '500' }}>
              {expanded ? 'Hide' : label}
            </span>
            <span style={{ fontSize: '10px', color: 'var(--text-tertiary)', transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s', display: 'inline-block' }}>▼</span>
          </div>
          {expanded && <div style={styles.workingContent}>{children}</div>}
        </div>
      );
    };

    // Bottom Sheet Component - slides up from bottom
    const BottomSheet = ({ isOpen, onClose, title, children }) => {
      const [dragY, setDragY] = useState(0);
      const [isDragging, setIsDragging] = useState(false);
      const startY = useRef(0);
      
      const handleTouchStart = (e) => {
        startY.current = e.touches[0].clientY;
        setIsDragging(true);
      };
      
      const handleTouchMove = (e) => {
        if (!isDragging) return;
        const deltaY = e.touches[0].clientY - startY.current;
        if (deltaY > 0) setDragY(deltaY);
      };
      
      const handleTouchEnd = () => {
        setIsDragging(false);
        if (dragY > 100) {
          onClose();
        }
        setDragY(0);
      };
      
      if (!isOpen) return null;
      
      return (
        <div style={{
          position: 'fixed',
          top: 0, left: 0, right: 0, bottom: 0,
          zIndex: 1000,
        }}>
          {/* Backdrop */}
          <div 
            style={{
              position: 'absolute',
              top: 0, left: 0, right: 0, bottom: 0,
              background: 'rgba(0,0,0,0.4)',
              transition: 'opacity 0.3s ease',
            }}
            onClick={onClose}
          />
          
          {/* Sheet */}
          <div 
            style={{
              position: 'absolute',
              bottom: 0, left: 0, right: 0,
              background: 'var(--bg-primary)',
              borderRadius: '20px 20px 0 0',
              maxHeight: '85vh',
              transform: `translateY(${dragY}px)`,
              transition: isDragging ? 'none' : 'transform 0.3s ease',
              boxShadow: '0 -4px 20px rgba(0,0,0,0.15)',
            }}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
          >
            {/* Handle */}
            <div style={{ 
              display: 'flex', 
              justifyContent: 'center', 
              padding: '12px',
              cursor: 'grab',
            }}>
              <div style={{
                width: '36px',
                height: '4px',
                background: 'var(--border)',
                borderRadius: '2px',
              }} />
            </div>
            
            {/* Header */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '0 20px 16px',
              borderBottom: '1px solid var(--border)',
            }}>
              <h2 style={{ 
                fontSize: '18px', 
                fontWeight: '600',
                margin: 0,
              }}>{title}</h2>
              <button 
                onClick={onClose}
                style={{
                  background: 'var(--bg-tertiary)',
                  border: 'none',
                  borderRadius: '50%',
                  width: '28px',
                  height: '28px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  cursor: 'pointer',
                  fontSize: '16px',
                  color: 'var(--text-secondary)',
                }}
              >×</button>
            </div>
            
            {/* Content */}
            <div style={{
              padding: '16px 20px 32px',
              overflowY: 'auto',
              maxHeight: 'calc(85vh - 100px)',
              WebkitOverflowScrolling: 'touch',
            }}>
              {children}
            </div>
          </div>
        </div>
      );
    };

    // Info button that opens a bottom sheet
    const InfoButton = ({ onClick, label }) => (
      <button
        onClick={onClick}
        style={{
          display: 'inline-flex',
          alignItems: 'center',
          gap: '4px',
          padding: '4px 10px',
          background: 'var(--bg-tertiary)',
          border: 'none',
          borderRadius: '12px',
          fontSize: '12px',
          color: 'var(--accent)',
          cursor: 'pointer',
          fontFamily: 'var(--font)',
          fontWeight: '500',
        }}
      >
        {label || 'ⓘ Details'}
      </button>
    );

    const Formula = ({ children }) => <code style={styles.formula}>{children}</code>;
    const Divider = () => <div style={styles.divider} />;

    const ValueRow = ({ label, value, isDefault, highlight }) => (
      <div style={{
        ...styles.valueRow,
        background: highlight ? 'rgba(0, 122, 255, 0.04)' : 'transparent',
        margin: highlight ? '0 -8px' : '0',
        padding: highlight ? '6px 8px' : '6px 0',
        borderRadius: highlight ? '4px' : '0',
      }}>
        <span>{label}</span>
        <span style={{ fontWeight: '500', color: 'var(--text-primary)' }}>
          {value}
          {isDefault && <span style={{ ...styles.defaultBadge, marginLeft: '6px' }}>default</span>}
        </span>
      </div>
    );

    // ============================================
    // SCREENS
    // ============================================

    // Landing Screen
    const LandingScreen = ({ onSelect }) => (
      <div style={styles.container}>
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Blood Gas</div>
          <h1 style={styles.title}>Acid Base Pro</h1>
          <p style={styles.subtitle}>Systematic interpretation</p>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Acid-Base Analysis</div>
          
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('traditional')}
          >
            <div style={styles.optionTitle}>Traditional</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>Henderson-Hasselbalch</div>
          </div>

          <div 
            style={styles.optionCard}
            onClick={() => onSelect('stewart')}
          >
            <div style={styles.optionTitle}>Physicochemical</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>Stewart approach</div>
          </div>
        </div>

        <div style={styles.card} className="animate-in stagger-2">
          <div style={styles.cardTitle}>Oxygenation</div>
          <div 
            style={styles.optionCard}
            onClick={() => onSelect('oxygenation')}
          >
            <div style={styles.optionTitle}>Assess Oxygenation</div>
            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>P/F ratio, A-a gradient</div>
          </div>
        </div>

        <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', lineHeight: '1.5', textAlign: 'center', padding: '16px 8px' }} className="animate-in stagger-2">
          <p style={{ marginBottom: '8px' }}>
            Educational aid only. Not medical advice. Results must be interpreted in clinical context. Authors accept no responsibility for clinical decisions.
          </p>
          <p>© 2025 Scott Santinon</p>
        </div>
      </div>
    );

    // Step 1: All Values (Traditional)
    const Step1_AllValues = ({ data, setData, onNext, onBack, approach }) => {
      const needsStewart = approach === 'stewart';
      const canProceed = data.pH && data.paCO2 && data.hco3 && data.na && data.cl;
      
      // Input validation - returns warning message or null
      const checkRange = (value, min, max, unit) => {
        if (!value) return null;
        const v = parseFloat(value);
        if (v < min || v > max) return `Outside typical range (${min}–${max} ${unit})`;
        return null;
      };
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 1</div>
            <h1 style={styles.title}>Enter Values</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={styles.cardTitle}>Blood Gas</div>
            <Input 
              label="pH" 
              value={data.pH || ''} 
              onChange={v => setData({...data, pH: v})} 
              placeholder="7.40"
              autoFocus
              warning={checkRange(data.pH, 6.8, 7.8, '')}
            />
            <div style={styles.grid}>
              <Input 
                label="PaCO₂" 
                unit="mmHg" 
                value={data.paCO2 || ''} 
                onChange={v => setData({...data, paCO2: v})} 
                placeholder="40"
                warning={checkRange(data.paCO2, 10, 120, 'mmHg')}
              />
              <Input 
                label="HCO₃⁻" 
                unit="mmol/L" 
                value={data.hco3 || ''} 
                onChange={v => setData({...data, hco3: v})} 
                placeholder="24"
                warning={checkRange(data.hco3, 5, 50, 'mmol/L')}
              />
            </div>
          </div>

          <div style={styles.card} className="animate-in stagger-2">
            <div style={styles.cardTitle}>Electrolytes</div>
            <div style={styles.grid}>
              <Input 
                label="Na⁺" 
                unit="mmol/L" 
                value={data.na || ''} 
                onChange={v => setData({...data, na: v})} 
                placeholder="—"
                warning={checkRange(data.na, 110, 170, 'mmol/L')}
              />
              <Input 
                label="Cl⁻" 
                unit="mmol/L" 
                value={data.cl || ''} 
                onChange={v => setData({...data, cl: v})} 
                placeholder="—"
                warning={checkRange(data.cl, 70, 130, 'mmol/L')}
              />
            </div>
            
            {needsStewart && (
              <>
                <div style={styles.grid}>
                  <Input 
                    label="K⁺" 
                    unit="mmol/L" 
                    value={data.k || ''} 
                    onChange={v => setData({...data, k: v})} 
                    placeholder="4.0"
                    isDefault
                    defaultValue="4.0"
                    warning={checkRange(data.k, 2.0, 8.0, 'mmol/L')}
                  />
                  <Input 
                    label="Lactate" 
                    unit="mmol/L" 
                    value={data.lactate || ''} 
                    onChange={v => setData({...data, lactate: v})} 
                    placeholder="1.0"
                    isDefault
                    defaultValue="1.0"
                    warning={checkRange(data.lactate, 0, 25, 'mmol/L')}
                  />
                </div>
                <div style={styles.grid}>
                  <Input 
                    label="Ca²⁺ (ionised)" 
                    unit="mmol/L" 
                    value={data.ca || ''} 
                    onChange={v => setData({...data, ca: v})} 
                    placeholder="1.15"
                    isDefault
                    defaultValue="1.15"
                    warning={checkRange(data.ca, 0.8, 1.5, 'mmol/L')}
                  />
                  <Input 
                    label="Mg²⁺" 
                    unit="mmol/L" 
                    value={data.mg || ''} 
                    onChange={v => setData({...data, mg: v})} 
                    placeholder="0.85"
                    isDefault
                    defaultValue="0.85"
                    warning={checkRange(data.mg, 0.4, 1.2, 'mmol/L')}
                  />
                </div>
              </>
            )}
            
            <Divider />
            
            <Input 
              label="Albumin" 
              unit="g/L" 
              value={data.albumin || ''} 
              onChange={v => setData({...data, albumin: v})} 
              placeholder="40"
              isDefault
              defaultValue="40"
              warning={checkRange(data.albumin, 10, 55, 'g/L')}
            />
            
            {needsStewart && (
              <Input 
                label="Phosphate" 
                unit="mmol/L" 
                value={data.phosphate || ''} 
                onChange={v => setData({...data, phosphate: v})} 
                placeholder="1.1"
                isDefault
                defaultValue="1.1"
                warning={checkRange(data.phosphate, 0.5, 3.0, 'mmol/L')}
              />
            )}
          </div>

          {!canProceed && (
            <div style={{ padding: '12px 16px', background: 'rgba(0, 122, 255, 0.06)', borderRadius: '10px', marginBottom: '12px' }} className="animate-in stagger-3">
              <div style={{ fontSize: '13px', color: 'var(--accent)', fontWeight: '500' }}>
                Required fields missing:
              </div>
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                {[
                  !data.pH && 'pH',
                  !data.paCO2 && 'PaCO2',
                  !data.hco3 && 'HCO3',
                  !data.na && 'Na',
                  !data.cl && 'Cl',
                ].filter(Boolean).join(', ')}
              </div>
            </div>
          )}

          <button
            className="animate-in stagger-3"
            style={{
              ...styles.button,
              ...(canProceed ? {} : styles.buttonDisabled),
            }}
            onClick={onNext}
            disabled={!canProceed}
          >
            Analyse
          </button>
        </div>
      );
    };

    // Step 2: Full Analysis Results (Traditional)
    const Step2_FullAnalysis = ({ data, setData, onNext, onBack }) => {
      const pH = parseFloat(data.pH);
      const paCO2 = parseFloat(data.paCO2);
      const hco3 = parseFloat(data.hco3);
      const na = parseFloat(data.na);
      const cl = parseFloat(data.cl);
      const albumin = data.albumin ? parseFloat(data.albumin) : DEFAULTS.albumin;
      
      const [timing, setTiming] = useState(data.timing || null); // null = not yet selected
      
      // pH Status
      const pHStatus = pH < 7.35 ? 'acidaemia' : pH > 7.45 ? 'alkalaemia' : 'normal';
      const statusType = pHStatus === 'acidaemia' ? 'error' : pHStatus === 'alkalaemia' ? 'warning' : 'success';
      
      // Primary disorder
      let primaryDisorder = '';
      let isMetabolic = false;
      let isRespiratory = false;
      
      // Check for abnormal values
      const lowHCO3 = hco3 < 22;
      const highHCO3 = hco3 > 26;
      const lowPaCO2 = paCO2 < 35;
      const highPaCO2 = paCO2 > 45;
      
      if (pHStatus === 'acidaemia') {
        if (highPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory acidosis';
          isRespiratory = true;
        } else if (lowHCO3 && !highPaCO2) {
          primaryDisorder = 'Metabolic acidosis';
          isMetabolic = true;
        } else if (lowHCO3 && highPaCO2) {
          primaryDisorder = 'Metabolic + respiratory acidosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Acidaemia (indeterminate)';
          isMetabolic = true;
        }
      } else if (pHStatus === 'alkalaemia') {
        if (lowPaCO2 && !highHCO3) {
          primaryDisorder = 'Respiratory alkalosis';
          isRespiratory = true;
        } else if (highHCO3 && !lowPaCO2) {
          primaryDisorder = 'Metabolic alkalosis';
          isMetabolic = true;
        } else if (highHCO3 && lowPaCO2) {
          primaryDisorder = 'Metabolic + respiratory alkalosis';
          isMetabolic = true;
          isRespiratory = true;
        } else {
          primaryDisorder = 'Alkalaemia (indeterminate)';
          isMetabolic = true;
        }
      } else {
        // Normal pH - check for compensated disorders or mixed
        if (lowHCO3 && lowPaCO2) {
          primaryDisorder = 'Compensated metabolic acidosis';
          isMetabolic = true;
        } else if (highHCO3 && highPaCO2) {
          // Could be compensated met alk OR compensated resp acidosis
          primaryDisorder = 'Compensated disorder';
          isMetabolic = true;
          isRespiratory = true;
        } else if (highPaCO2 && !highHCO3) {
          // High CO2 with normal-ish HCO3 and normal pH is unusual
          primaryDisorder = 'Respiratory acidosis (compensated)';
          isRespiratory = true;
        } else if (lowPaCO2 && !lowHCO3) {
          primaryDisorder = 'Respiratory alkalosis (compensated)';
          isRespiratory = true;
        } else if (lowHCO3 || highHCO3 || lowPaCO2 || highPaCO2) {
          // Some abnormality exists
          primaryDisorder = 'Mixed disorder (normal pH)';
          isMetabolic = true;
        } else {
          // All values normal - still calculate AG
          primaryDisorder = 'Check anion gap';
          isMetabolic = true;
        }
      }

      const isAcidosis = pHStatus === 'acidaemia' || primaryDisorder.toLowerCase().includes('acidosis');
      const isAlkalosis = pHStatus === 'alkalaemia' || primaryDisorder.toLowerCase().includes('alkalosis');

      // Compensation (only for pure disorders, not mixed)
      let expectedPaCO2 = null;
      let expectedHCO3 = null;
      let compensationResult = '';
      let compensationNote = '';

      const isMixed = isMetabolic && isRespiratory;

      if (isMixed) {
        compensationResult = 'Mixed disorder — classic single-disorder compensation rules do not apply';
      } else if (isMetabolic && isAcidosis) {
        expectedPaCO2 = (1.5 * hco3) + 8;
        // Physiological floor: PaCO2 cannot go below ~10 mmHg
        if (expectedPaCO2 < 10) {
          compensationNote = 'Maximal respiratory compensation reached (PaCO₃ floor ~10 mmHg)';
          expectedPaCO2 = 10;
        }
      } else if (isMetabolic && isAlkalosis) {
        expectedPaCO2 = (0.7 * hco3) + 20;
        // Physiological ceiling: PaCO2 rarely exceeds ~55-60 for compensation
        if (expectedPaCO2 > 55) {
          compensationNote = 'Expected PaCO₂ exceeds usual compensatory limit (~55 mmHg)';
        }
      } else if (isRespiratory && timing) {
        // Only calculate if timing has been selected
        const deltaCO2 = Math.abs(paCO2 - 40) / 10;
        if (isAcidosis) {
          const change = timing === 'acute' ? 1 : 4;
          expectedHCO3 = 24 + (deltaCO2 * change);
          // Physiological ceiling: HCO3 rarely exceeds 45 mmol/L
          if (expectedHCO3 > 45) {
            compensationNote = 'Beyond usual physiological compensation (HCO₃ ceiling ~45 mmol/L)';
            expectedHCO3 = 45;
          }
        } else {
          const change = timing === 'acute' ? 2 : 5;
          expectedHCO3 = 24 - (deltaCO2 * change);
          // Physiological floor: HCO3 rarely goes below 12-15 for compensation
          if (expectedHCO3 < 12) {
            compensationNote = 'Beyond usual physiological compensation (HCO₃ floor ~12 mmol/L)';
            expectedHCO3 = 12;
          }
        }
      }

      if (!isMixed) {
        if (expectedPaCO2 !== null) {
          const diff = paCO2 - expectedPaCO2;
          if (Math.abs(diff) <= 3) compensationResult = 'Appropriate compensation';
          else if (diff > 3) compensationResult = 'Additional respiratory acidosis';
          else compensationResult = 'Additional respiratory alkalosis';
        } else if (expectedHCO3 !== null) {
          const diff = hco3 - expectedHCO3;
          if (Math.abs(diff) <= 3) compensationResult = 'Appropriate compensation';
          else if (diff > 3) compensationResult = 'Additional metabolic alkalosis';
          else compensationResult = 'Additional metabolic acidosis';
        }
      }

      const compensationType = compensationResult.includes('Appropriate') ? 'success' : 
                               compensationResult.includes('Mixed') ? 'neutral' : 'warning';

      // Anion Gap (only for metabolic acidosis)
      const rawAG = na - hco3 - cl;
      const correction = 0.25 * (40 - albumin);
      const correctedAG = rawAG + correction;
      const isHAGMA = correctedAG > 12;

      // Delta Ratio (for any HAGMA - helps identify mixed disorders)
      let deltaAG = null;
      let deltaHCO3 = null;
      let deltaRatio = null;
      let deltaInterpretation = '';
      
      if (isHAGMA) {
        deltaAG = correctedAG - 12;
        deltaHCO3 = 24 - hco3;
        
        // Only calculate ratio if HCO3 is actually low (meaningful denominator)
        if (deltaHCO3 > 1) {
          deltaRatio = deltaAG / deltaHCO3;
          
          if (deltaRatio < 0.4) deltaInterpretation = 'Concurrent NAGMA';
          else if (deltaRatio < 0.8) deltaInterpretation = 'Mixed HAGMA + NAGMA';
          else if (deltaRatio <= 2) deltaInterpretation = 'No additional disorder';
          else deltaInterpretation = 'Concurrent metabolic alkalosis';
        } else if (deltaHCO3 <= 1 && deltaHCO3 >= -2) {
          // HCO3 is near normal despite HAGMA
          deltaInterpretation = 'Concurrent metabolic alkalosis (HCO₃ maintained)';
        } else {
          // HCO3 is elevated (frank metabolic alkalosis)
          deltaInterpretation = 'Concurrent metabolic alkalosis';
        }
      }

      const handleNext = () => {
        const updatedData = {
          ...data,
          pHStatus,
          primaryDisorder,
          isMetabolic,
          isRespiratory,
          isAcidosis,
          isAlkalosis,
          timing,
          expectedPaCO2,
          expectedHCO3,
          compensationResult,
          rawAG,
          correctedAG,
          isHAGMA,
          usedAlbumin: albumin,
          deltaAG,
          deltaHCO3,
          deltaRatio,
          deltaInterpretation,
        };
        setData(updatedData);
        onNext();
      };

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 2</div>
            <h1 style={styles.title}>Analysis</h1>
          </div>

          {/* Primary Disorder */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
              <div>
                <div style={styles.resultLabel}>Primary Disorder</div>
                <div style={{ fontSize: '18px', fontWeight: '600' }}>{primaryDisorder}</div>
              </div>
              <span style={styles.statusBadge(statusType)}>
                pH {pH.toFixed(2)}
              </span>
            </div>

            {/* Timing toggle for respiratory - only show for pure respiratory disorders */}
            {isRespiratory && !isMixed && (() => {
              // Calculate expected HCO3 for reference
              const deltaCO2 = Math.abs(paCO2 - 40) / 10;
              const expectedAcute = isAcidosis ? 24 + (deltaCO2 * 1) : 24 - (deltaCO2 * 2);
              const expectedChronic = isAcidosis ? 24 + (deltaCO2 * 4) : 24 - (deltaCO2 * 5);
              
              return (
                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                  <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '10px' }}>
                    How long has this respiratory problem been present?
                  </div>
                  
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    <button
                      style={{
                        padding: '12px',
                        border: '2px solid',
                        borderColor: timing === 'acute' ? 'var(--accent)' : 'var(--border)',
                        borderRadius: '10px',
                        background: timing === 'acute' ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                        textAlign: 'left',
                        cursor: 'pointer',
                        fontFamily: 'var(--font)',
                      }}
                      onClick={() => setTiming('acute')}
                    >
                      <div style={{ fontSize: '14px', fontWeight: '600' }}>Acute — hours to days</div>
                      <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                        New presentation, acute precipitant (PE, overdose, asthma, pneumonia, anxiety)
                      </div>
                    </button>
                    
                    <button
                      style={{
                        padding: '12px',
                        border: '2px solid',
                        borderColor: timing === 'chronic' ? 'var(--accent)' : 'var(--border)',
                        borderRadius: '10px',
                        background: timing === 'chronic' ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                        textAlign: 'left',
                        cursor: 'pointer',
                        fontFamily: 'var(--font)',
                      }}
                      onClick={() => setTiming('chronic')}
                    >
                      <div style={{ fontSize: '14px', fontWeight: '600' }}>Chronic — days to weeks</div>
                      <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                        Known COPD, ILD, obesity hypoventilation, or patient's usual baseline
                      </div>
                    </button>
                  </div>
                </div>
              );
            })()}
          </div>

          {/* Compensation */}
          {compensationResult && (
            <div style={styles.card} className="animate-in stagger-2">
              {isMixed ? (
                // Mixed disorder - stack vertically since text is long
                <>
                  <div style={styles.resultLabel}>Compensation</div>
                  <div style={{ 
                    marginTop: '8px', 
                    padding: '10px', 
                    background: 'var(--bg-tertiary)', 
                    borderRadius: '8px',
                    fontSize: '13px',
                    color: 'var(--text-secondary)',
                    lineHeight: '1.5'
                  }}>
                    Mixed disorder — classic single-disorder compensation rules do not apply
                  </div>
                </>
              ) : (
                // Single disorder - side by side layout
                <>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={styles.resultLabel}>Compensation</div>
                    <span style={{
                      fontSize: '12px', fontWeight: '500', padding: '4px 10px', borderRadius: '12px',
                      background: compensationType === 'success' ? 'var(--success-light)' : compensationType === 'warning' ? 'var(--warning-light)' : 'var(--bg-tertiary)',
                      color: compensationType === 'success' ? 'var(--success)' : compensationType === 'warning' ? 'var(--warning)' : 'var(--text-secondary)',
                    }}>{compensationResult}</span>
                  </div>
                  {compensationNote && (
                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '8px' }}>
                      {compensationNote}
                    </div>
                  )}
                  <ExpandableWorking>
                    {expectedPaCO2 !== null && (
                      <>
                        <p>Expected PaCO₂ = {expectedPaCO2.toFixed(0)} mmHg</p>
                        <p>Actual PaCO₂ = {paCO2} mmHg</p>
                        <p>Difference = {Math.abs(paCO2 - expectedPaCO2).toFixed(0)} mmHg {Math.abs(paCO2 - expectedPaCO2) <= 2 ? '(within ±2)' : ''}</p>
                      </>
                    )}
                    {expectedHCO3 !== null && (
                      <>
                        <p>Expected HCO₃ = {expectedHCO3.toFixed(0)} mmol/L ({timing})</p>
                        <p>Actual HCO₃ = {hco3} mmol/L</p>
                      </>
                    )}
                  </ExpandableWorking>
                </>
              )}
            </div>
          )}

          {/* Anion Gap - show for metabolic acidosis OR whenever elevated (catches compensated/mixed) */}
          {((isMetabolic && isAcidosis) || isHAGMA) && (
            <div style={styles.card} className="animate-in stagger-3">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <div style={styles.resultLabel}>Anion Gap</div>
                  <div style={{ fontSize: '16px', fontWeight: '600' }}>{correctedAG.toFixed(1)} mEq/L</div>
                </div>
                <span style={{
                  fontSize: '12px', fontWeight: '500', padding: '4px 10px', borderRadius: '12px',
                  background: isHAGMA ? 'var(--error-light)' : 'var(--success-light)',
                  color: isHAGMA ? 'var(--error)' : 'var(--success)',
                }}>
                  {isHAGMA ? '↑ Elevated' : 'Normal'}
                </span>
              </div>
              {isHAGMA && !isAcidosis && (
                <div style={{ marginTop: '8px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                  Note: Elevated AG despite {pHStatus === 'normal' ? 'normal pH' : 'alkalemia'} — consider compensated or mixed disorder
                </div>
              )}
              <ExpandableWorking>
                <p>Raw AG = {na} - {hco3} - {cl} = {rawAG.toFixed(1)}</p>
                <p>Albumin correction = +{correction.toFixed(1)}</p>
                <p>Corrected AG = {correctedAG.toFixed(1)} {!data.albumin && '(using default albumin 40)'}</p>
              </ExpandableWorking>
            </div>
          )}

          {/* Delta Ratio (for HAGMA) */}
          {isHAGMA && deltaInterpretation && (
            <div style={styles.card} className="animate-in stagger-4">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <div style={styles.resultLabel}>Delta Ratio</div>
                  <div style={{ fontSize: '16px', fontWeight: '600' }}>
                    {deltaRatio !== null ? deltaRatio.toFixed(2) : '—'}
                  </div>
                </div>
                <span style={{
                  fontSize: '12px', fontWeight: '500', padding: '4px 10px', borderRadius: '12px',
                  background: deltaInterpretation === 'No additional disorder' ? 'var(--success-light)' : 'var(--warning-light)',
                  color: deltaInterpretation === 'No additional disorder' ? 'var(--success)' : 'var(--warning)',
                }}>
                  {deltaInterpretation}
                </span>
              </div>
              <ExpandableWorking>
                <p>ΔAG = {correctedAG.toFixed(1)} - 12 = {deltaAG.toFixed(1)}</p>
                <p>ΔHCO₃ = 24 - {hco3} = {deltaHCO3.toFixed(1)}</p>
                {deltaRatio !== null ? (
                  <>
                    <p>Ratio = {deltaRatio.toFixed(2)}</p>
                    <Divider />
                    <p style={{ fontSize: '12px' }}>{"<"}0.4 +NAGMA | 0.4-0.8 mixed | 0.8-2 pure | {">"}2 +met alk</p>
                  </>
                ) : (
                  <p style={{ fontSize: '12px', color: 'var(--warning)' }}>
                    HCO₃ near normal despite ↑AG suggests concurrent metabolic alkalosis
                  </p>
                )}
              </ExpandableWorking>
            </div>
          )}

          <button className="animate-in stagger-5" style={styles.button} onClick={handleNext}>
            Next →
          </button>
        </div>
      );
    };

    // Step 2: Stewart/Physicochemical Analysis - COMPACT VERSION
    const Step2_StewartAnalysis = ({ data, setData, onNext, onBack }) => {
      const [showSheet, setShowSheet] = useState(null); // 'sid', 'sig', 'components', 'osmgap', 'timing', 'chart'
      const [timing, setTiming] = useState(data.timing || null); // null = not yet selected
      
      const pH = parseFloat(data.pH);
      const paCO2 = parseFloat(data.paCO2);
      const hco3 = parseFloat(data.hco3);
      const na = parseFloat(data.na);
      const cl = parseFloat(data.cl);
      const k = data.k ? parseFloat(data.k) : DEFAULTS.k;
      const ca = data.ca ? parseFloat(data.ca) : 1.15;
      const mg = data.mg ? parseFloat(data.mg) : 0.85;
      const lactate = data.lactate ? parseFloat(data.lactate) : 1.0;
      const albumin = data.albumin ? parseFloat(data.albumin) : DEFAULTS.albumin;
      const phosphate = data.phosphate ? parseFloat(data.phosphate) : 1.1;
      
      // pH Status
      const pHStatus = pH < 7.35 ? 'acidaemia' : pH > 7.45 ? 'alkalaemia' : 'normal';
      const statusType = pHStatus === 'acidaemia' ? 'error' : pHStatus === 'alkalaemia' ? 'warning' : 'success';
      
      // Primary disorder logic
      const lowHCO3 = hco3 < 22;
      const highHCO3 = hco3 > 26;
      const lowPaCO2 = paCO2 < 35;
      const highPaCO2 = paCO2 > 45;
      
      let primaryDisorder = '';
      let isMetabolic = false;
      let isRespiratory = false;
      
      if (pHStatus === 'acidaemia') {
        if (highPaCO2 && !lowHCO3) { primaryDisorder = 'Respiratory acidosis'; isRespiratory = true; }
        else if (lowHCO3 && !highPaCO2) { primaryDisorder = 'Metabolic acidosis'; isMetabolic = true; }
        else if (lowHCO3 && highPaCO2) { primaryDisorder = 'Mixed acidosis'; isMetabolic = true; isRespiratory = true; }
        else { primaryDisorder = 'Acidaemia'; isMetabolic = true; }
      } else if (pHStatus === 'alkalaemia') {
        if (lowPaCO2 && !highHCO3) { primaryDisorder = 'Respiratory alkalosis'; isRespiratory = true; }
        else if (highHCO3 && !lowPaCO2) { primaryDisorder = 'Metabolic alkalosis'; isMetabolic = true; }
        else if (highHCO3 && lowPaCO2) { primaryDisorder = 'Mixed alkalosis'; isMetabolic = true; isRespiratory = true; }
        else { primaryDisorder = 'Alkalaemia'; isMetabolic = true; }
      } else {
        if (lowHCO3 && lowPaCO2) { primaryDisorder = 'Compensated met acidosis'; isMetabolic = true; }
        else if (highHCO3 && highPaCO2) { primaryDisorder = 'Compensated disorder'; isMetabolic = true; isRespiratory = true; }
        else { primaryDisorder = 'Normal / check SIG'; isMetabolic = true; }
      }

      const isAcidosis = pHStatus === 'acidaemia' || primaryDisorder.toLowerCase().includes('acidosis');
      const isAlkalosis = pHStatus === 'alkalaemia' || primaryDisorder.toLowerCase().includes('alkalosis');

      // ========== STEWART CALCULATIONS ==========
      // Simplified SIDa (commonly used in clinical practice)
      // Note: Full SIDa includes Ca/Mg but they're rarely measured and add complexity
      const SIDa = na + k - cl - lactate;
      
      // Figge-Fencl formula for weak acid buffers (ATOT)
      // Albumin in g/L, phosphate in mmol/L
      const albuminCharge = albumin * (0.123 * pH - 0.631);
      const phosphateCharge = phosphate * (0.309 * pH - 0.469);
      const ATOT = albuminCharge + phosphateCharge;
      const SIDe = hco3 + ATOT;
      const SIG = SIDa - SIDe;
      
      // Component effects
      const naEffect = na - 140;
      const clEffect = 102 - cl;
      const lactateEffect = -(lactate - 1.0);
      const albuminEffect = (40 - albumin) * 0.25;
      
      // Interpretations
      const sidStatus = SIDa < 38 ? 'low' : SIDa > 42 ? 'high' : 'normal';
      // SIG threshold: >5 commonly used in clinical practice (some use >2, but this gives false positives)
      const sigElevated = SIG > 5;

      const handleNext = () => {
        setData(prev => ({
          ...prev,
          pHStatus, primaryDisorder, isMetabolic, isRespiratory, isAcidosis, isAlkalosis, timing,
          SIDa, SIDe, SIG, ATOT, albuminCharge, phosphateCharge,
          naEffect, clEffect, lactateEffect, albuminEffect,
          isHAGMA: SIG > 5,
          usedAlbumin: albumin,
        }));
        onNext();
      };

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 2 — Stewart</div>
            <h1 style={styles.title}>Analysis</h1>
          </div>

          {/* Summary box - now at TOP */}
          <div style={{ ...styles.card, background: 'var(--bg-tertiary)' }} className="animate-in stagger-1">
            <div style={{ fontSize: '14px', lineHeight: '1.6' }}>
              {(() => {
                const acidosisDrivers = [];
                const alkalosisDrivers = [];
                
                if (naEffect < -2) acidosisDrivers.push('free water excess');
                if (naEffect > 2) alkalosisDrivers.push('free water deficit');
                if (clEffect < -2) acidosisDrivers.push('hyperchloraemia');
                if (clEffect > 2) alkalosisDrivers.push('hypochloraemia');
                if (lactate > 2) acidosisDrivers.push(`lactate (${lactate.toFixed(1)})`);
                if (albumin < 30) alkalosisDrivers.push('hypoalbuminaemia');
                if (sigElevated) acidosisDrivers.push(`unmeasured anions (SIG ${SIG.toFixed(1)})`);
                
                return (
                  <>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <strong>{pHStatus === 'normal' ? 'Normal pH' : pHStatus.charAt(0).toUpperCase() + pHStatus.slice(1)}</strong>
                      <span style={styles.statusBadge(statusType)}>pH {pH.toFixed(2)}</span>
                    </div>
                    {acidosisDrivers.length > 0 && (
                      <div style={{ marginTop: '8px', color: 'var(--error)', fontSize: '13px' }}>
                        ↓ Acidosis from: {acidosisDrivers.join(', ')}
                      </div>
                    )}
                    {alkalosisDrivers.length > 0 && (
                      <div style={{ marginTop: '4px', color: 'var(--warning)', fontSize: '13px' }}>
                        ↑ Alkalosis from: {alkalosisDrivers.join(', ')}
                      </div>
                    )}
                    {acidosisDrivers.length === 0 && alkalosisDrivers.length === 0 && (
                      <div style={{ marginTop: '8px', color: 'var(--text-secondary)', fontSize: '13px' }}>
                        No significant metabolic derangement identified
                      </div>
                    )}
                    {isRespiratory && (
                      <div style={{ marginTop: '8px', paddingTop: '8px', borderTop: '1px solid var(--border)', fontSize: '13px' }}>
                        Respiratory component: {isAcidosis ? 'acidosis' : 'alkalosis'} (PaCO₂ {paCO2})
                        {timing && <span> — {timing}</span>}
                      </div>
                    )}
                  </>
                );
              })()}
            </div>
          </div>

          {/* Stewart details card */}
          <div style={styles.card} className="animate-in stagger-2">
            {/* Timing for respiratory - tap to open sheet */}
            {isRespiratory && (
              <button
                onClick={() => setShowSheet('timing')}
                style={{
                  width: '100%', padding: '10px 12px', marginBottom: '12px',
                  border: timing ? '1px solid var(--border)' : '2px solid var(--warning)',
                  borderRadius: '8px',
                  background: timing ? 'var(--bg-tertiary)' : 'var(--warning-light)',
                  textAlign: 'left',
                  cursor: 'pointer', fontFamily: 'var(--font)',
                  display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                }}
              >
                <span style={{ fontSize: '13px' }}>
                  <span style={{ color: 'var(--text-secondary)' }}>Respiratory onset: </span>
                  <span style={{ fontWeight: '600' }}>
                    {timing === 'acute' ? 'Acute' : timing === 'chronic' ? 'Chronic' : 'Not selected'}
                  </span>
                </span>
                <span style={{ fontSize: '12px', color: timing ? 'var(--accent)' : 'var(--warning)' }}>
                  {timing ? 'Change' : 'Select'}
                </span>
              </button>
            )}
            
            {/* SIDa row */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px' }}>SIDa</span>
                <InfoButton onClick={() => setShowSheet('sid')} label="ⓘ" />
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '15px', fontWeight: '600' }}>{SIDa.toFixed(1)}</span>
                <span style={{
                  fontSize: '11px', padding: '2px 6px', borderRadius: '4px',
                  background: sidStatus === 'low' ? 'var(--error-light)' : sidStatus === 'high' ? 'var(--warning-light)' : 'var(--success-light)',
                  color: sidStatus === 'low' ? 'var(--error)' : sidStatus === 'high' ? 'var(--warning)' : 'var(--success)',
                }}>{sidStatus === 'low' ? '↓Acid' : sidStatus === 'high' ? '↑Alk' : 'OK'}</span>
              </div>
            </div>
            
            {/* SIG row */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px' }}>SIG</span>
                <InfoButton onClick={() => setShowSheet('sig')} label="ⓘ" />
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '15px', fontWeight: '600' }}>{SIG.toFixed(1)}</span>
                <span style={{
                  fontSize: '11px', padding: '2px 6px', borderRadius: '4px',
                  background: sigElevated ? 'var(--error-light)' : 'var(--success-light)',
                  color: sigElevated ? 'var(--error)' : 'var(--success)',
                }}>{sigElevated ? '↑Unmeasured' : 'OK'}</span>
              </div>
            </div>
            
            {/* Quick buttons */}
            <div style={{ display: 'flex', gap: '8px', marginTop: '12px', flexWrap: 'wrap' }}>
              <button
                onClick={() => setShowSheet('components')}
                style={{ flex: '1 1 45%', padding: '10px', background: 'var(--bg-tertiary)', border: 'none', borderRadius: '8px', fontSize: '12px', fontWeight: '500', cursor: 'pointer', fontFamily: 'var(--font)' }}
              >Component Effects</button>
              <button
                onClick={() => setShowSheet('chart')}
                style={{ flex: '1 1 45%', padding: '10px', background: 'var(--bg-tertiary)', border: 'none', borderRadius: '8px', fontSize: '12px', fontWeight: '500', cursor: 'pointer', fontFamily: 'var(--font)' }}
              >Contribution Chart</button>
              {sigElevated && (
                <button
                  onClick={() => setShowSheet('osmgap')}
                  style={{ flex: '1 1 100%', padding: '10px', background: 'var(--warning-light)', border: 'none', borderRadius: '8px', fontSize: '12px', fontWeight: '500', cursor: 'pointer', fontFamily: 'var(--font)', color: 'var(--warning)' }}
                >↑SIG detected — check Osmolar Gap</button>
              )}
            </div>
          </div>

          {/* Warning if timing not selected for respiratory */}
          {isRespiratory && !timing && (
            <div style={{ ...styles.card, background: 'var(--warning-light)', borderLeft: '3px solid var(--warning)' }} className="animate-in stagger-3">
              <div style={{ fontSize: '13px', color: 'var(--warning)' }}>
                ⚠️ Select respiratory timing above to calculate expected compensation
              </div>
            </div>
          )}

          <button className="animate-in stagger-3" style={styles.button} onClick={handleNext}>
            View Summary →
          </button>

          {/* Bottom Sheets */}
          <BottomSheet isOpen={showSheet === 'sid'} onClose={() => setShowSheet(null)} title="Strong Ion Difference (SID)">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ padding: '12px', background: sidStatus === 'low' ? 'var(--error-light)' : sidStatus === 'high' ? 'var(--warning-light)' : 'var(--success-light)', borderRadius: '8px', marginBottom: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>SIDa</span>
                  <span style={{ fontSize: '18px', fontWeight: '700' }}>{SIDa.toFixed(1)} mEq/L</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: sidStatus === 'low' ? 'var(--error)' : sidStatus === 'high' ? 'var(--warning)' : 'var(--success)' }}>
                  {sidStatus === 'low' ? '↓ Low SID → metabolic acidosis' : sidStatus === 'high' ? '↑ High SID → metabolic alkalosis' : 'Normal range'}
                </div>
              </div>
              
              <p><strong>What is SID?</strong></p>
              <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                The difference between strong cations and strong anions. Because strong ions fully dissociate, their balance directly determines pH.
              </p>
              
              <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '12px', fontSize: '13px' }}>
                <p><strong>Formula:</strong> Na + K − Cl − Lactate</p>
                <p style={{ color: 'var(--text-secondary)', marginTop: '6px' }}>
                  = {na} + {k} − {cl} − {lactate} = <strong>{SIDa.toFixed(1)}</strong>
                </p>
                <p style={{ color: 'var(--text-secondary)', fontSize: '11px', marginTop: '6px' }}>
                  (Simplified formula — Ca/Mg omitted as rarely measured)
                </p>
              </div>
              
              <div style={{ marginTop: '12px', fontSize: '13px' }}>
                <p><strong>Normal:</strong> 38-42 mEq/L</p>
                <p style={{ marginTop: '8px' }}>• ↓SID → acidosis (too many anions relative to cations)</p>
                <p>• ↑SID → alkalosis (too few anions relative to cations)</p>
              </div>
              
              <div style={{ marginTop: '12px', padding: '10px', background: 'var(--surface)', borderRadius: '8px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                <strong>Clinical insight:</strong> SID changes can be from water (dilution/concentration), chloride (most common), or unmeasured strong ions like lactate/ketones.
              </div>
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'sig'} onClose={() => setShowSheet(null)} title="Strong Ion Gap (SIG)">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ padding: '12px', background: sigElevated ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px', marginBottom: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>SIG</span>
                  <span style={{ fontSize: '18px', fontWeight: '700' }}>{SIG.toFixed(1)} mEq/L</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: sigElevated ? 'var(--error)' : 'var(--success)' }}>
                  {sigElevated ? '↑ Elevated — unmeasured anions present' : 'Normal — no significant unmeasured anions'}
                </div>
              </div>
              
              <p><strong>What is SIG?</strong></p>
              <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                The gap between apparent and effective SID. Detects unmeasured strong anions like ketones, lactate beyond measured, toxins.
              </p>
              
              <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '12px', fontSize: '13px' }}>
                <p><strong>Formula:</strong> SIG = SIDa − SIDe</p>
                <p style={{ color: 'var(--text-secondary)', marginTop: '6px' }}>
                  = {SIDa.toFixed(1)} − {SIDe.toFixed(1)} = <strong>{SIG.toFixed(1)}</strong>
                </p>
                <p style={{ color: 'var(--text-secondary)', marginTop: '6px', fontSize: '12px' }}>
                  SIDe = HCO₃ + ATOT = {hco3} + {ATOT.toFixed(1)} = {SIDe.toFixed(1)}
                </p>
                <p style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>
                  ATOT = albumin charge ({albuminCharge.toFixed(1)}) + phosphate charge ({phosphateCharge.toFixed(1)})
                </p>
              </div>
              
              <div style={{ marginTop: '12px', fontSize: '13px' }}>
                <p><strong>Normal:</strong> &lt;5 mEq/L</p>
                <p style={{ marginTop: '8px' }}>Elevated SIG indicates unmeasured anions — analogous to elevated anion gap but more precise (accounts for albumin).</p>
              </div>
              
              {sigElevated && (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--error-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--error)' }}>Causes of elevated SIG:</strong>
                  <p style={{ marginTop: '4px' }}>• Ketoacidosis (DKA, starvation, alcoholic)</p>
                  <p>• Lactic acidosis</p>
                  <p>• Uraemia (renal failure)</p>
                  <p>• Toxic alcohols (methanol, ethylene glycol)</p>
                  <p>• Salicylate toxicity</p>
                </div>
              )}
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'components'} onClose={() => setShowSheet(null)} title="Component Effects">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              {[
                { 
                  label: 'Free water (Na⁺)', 
                  value: na, 
                  ref: 140, 
                  effect: naEffect, 
                  status: naEffect > 2 ? 'Deficit → alkalosis' : naEffect < -2 ? 'Excess → acidosis' : 'Normal',
                  explain: 'Na⁺ is tightly regulated. ↑Na⁺ = water deficit (concentration alkalosis). ↓Na⁺ = water excess (dilutional acidosis).'
                },
                { 
                  label: 'Chloride', 
                  value: cl, 
                  ref: 102, 
                  effect: -clEffect, 
                  status: clEffect > 2 ? 'Low → alkalosis' : clEffect < -2 ? 'High → acidosis' : 'Normal',
                  explain: 'Major SID anion. ↑Cl⁻ directly lowers SID → acidosis. ↓Cl⁻ raises SID → alkalosis.'
                },
                { 
                  label: 'Lactate', 
                  value: lactate.toFixed(1), 
                  ref: 1.0, 
                  effect: lactate - 1, 
                  status: lactate > 2 ? 'Elevated → acidosis' : 'Normal',
                  explain: 'Strong anion. Elevated lactate directly lowers SID causing acidosis.'
                },
                { 
                  label: 'Albumin', 
                  value: albumin, 
                  ref: 40, 
                  effect: 40 - albumin, 
                  status: albumin < 30 ? 'Low → alkalosis' : 'Normal',
                  explain: 'Weak acid buffer. ↓Albumin reduces ATOT causing apparent metabolic alkalosis.'
                },
              ].map((c, i) => (
                <div key={i} style={{ padding: '10px 0', borderBottom: i < 3 ? '1px solid var(--border)' : 'none' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                    <span style={{ fontWeight: '600' }}>{c.label}</span>
                    <span>{c.value} <span style={{ color: 'var(--text-secondary)' }}>(ref {c.ref})</span></span>
                  </div>
                  <div style={{ 
                    fontSize: '12px', 
                    padding: '4px 8px', 
                    borderRadius: '4px',
                    display: 'inline-block',
                    background: c.status === 'Normal' ? 'var(--success-light)' : 'var(--warning-light)',
                    color: c.status === 'Normal' ? 'var(--success)' : 'var(--warning)',
                    marginBottom: '6px'
                  }}>{c.status}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{c.explain}</div>
                </div>
              ))}
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'chart'} onClose={() => setShowSheet(null)} title="Contribution Chart">
            <div style={{ fontSize: '14px' }}>
              <div style={{ textAlign: 'center', fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
                ← Acidosis | Alkalosis →
              </div>
              
              {(() => {
                const contributions = [
                  { label: 'Free water', value: naEffect, threshold: 2 },
                  { label: 'Chloride', value: clEffect, threshold: 2 },
                  { label: 'Lactate', value: lactateEffect, threshold: 0.5 },
                  { label: 'Albumin', value: albuminEffect, threshold: 1 },
                  { label: 'Unmeasured', value: -(sigElevated ? SIG : 0), threshold: 0 },
                ].filter(c => Math.abs(c.value) > c.threshold);
                
                const maxVal = Math.max(10, ...contributions.map(c => Math.abs(c.value)));
                
                if (contributions.length === 0) {
                  return (
                    <div style={{ textAlign: 'center', padding: '20px', color: 'var(--text-secondary)' }}>
                      No significant metabolic contributions identified
                    </div>
                  );
                }
                
                return (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {contributions.map((c, i) => (
                      <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div style={{ width: '80px', fontSize: '12px', textAlign: 'right', flexShrink: 0 }}>
                          {c.label}
                        </div>
                        <div style={{ flex: 1, display: 'flex', alignItems: 'center', height: '24px' }}>
                          <div style={{ flex: 1, display: 'flex', justifyContent: 'flex-end' }}>
                            {c.value < 0 && (
                              <div style={{
                                width: `${Math.abs(c.value) / maxVal * 100}%`,
                                height: '20px',
                                background: 'rgba(255, 59, 48, 0.7)',
                                borderRadius: '4px 0 0 4px',
                              }} />
                            )}
                          </div>
                          <div style={{ width: '2px', height: '24px', background: 'var(--border)' }} />
                          <div style={{ flex: 1 }}>
                            {c.value > 0 && (
                              <div style={{
                                width: `${Math.abs(c.value) / maxVal * 100}%`,
                                height: '20px',
                                background: 'rgba(255, 149, 0, 0.7)',
                                borderRadius: '0 4px 4px 0',
                              }} />
                            )}
                          </div>
                        </div>
                        <div style={{ width: '40px', fontSize: '11px', color: 'var(--text-secondary)', flexShrink: 0 }}>
                          {c.value > 0 ? '+' : ''}{c.value.toFixed(1)}
                        </div>
                      </div>
                    ))}
                  </div>
                );
              })()}
              
              <div style={{ marginTop: '16px', padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                <strong>Reading the chart:</strong> Bars to the left (red) contribute to acidosis. Bars to the right (orange) contribute to alkalosis. The net effect determines the overall metabolic status.
              </div>
            </div>
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'osmgap'} onClose={() => setShowSheet(null)} title="Osmolar Gap">
            <OsmolarGapBottomSheetContent data={data} setData={setData} na={na} sigElevated={sigElevated} />
          </BottomSheet>

          <BottomSheet isOpen={showSheet === 'timing'} onClose={() => setShowSheet(null)} title="Respiratory Problem Duration">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <p style={{ color: 'var(--text-secondary)', fontWeight: '600', marginBottom: '16px' }}>
                How long has the respiratory disorder been present?
              </p>
              
              <button
                onClick={() => { setTiming('acute'); setShowSheet(null); }}
                style={{
                  width: '100%', padding: '14px', marginBottom: '10px',
                  border: timing === 'acute' ? '2px solid var(--accent)' : '1px solid var(--border)',
                  borderRadius: '12px',
                  background: timing === 'acute' ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                  textAlign: 'left', cursor: 'pointer', fontFamily: 'var(--font)',
                }}
              >
                <div style={{ fontSize: '15px', fontWeight: '600', marginBottom: '4px' }}>Acute — hours to days</div>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  New presentation, acute precipitant (PE, overdose, asthma, pneumonia, anxiety)
                </div>
              </button>
              
              <button
                onClick={() => { setTiming('chronic'); setShowSheet(null); }}
                style={{
                  width: '100%', padding: '14px',
                  border: timing === 'chronic' ? '2px solid var(--accent)' : '1px solid var(--border)',
                  borderRadius: '12px',
                  background: timing === 'chronic' ? 'var(--accent-light)' : 'var(--bg-tertiary)',
                  textAlign: 'left', cursor: 'pointer', fontFamily: 'var(--font)',
                }}
              >
                <div style={{ fontSize: '15px', fontWeight: '600', marginBottom: '4px' }}>Chronic — days to weeks</div>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  Known COPD, ILD, obesity hypoventilation, or patient's usual baseline
                </div>
              </button>
            </div>
          </BottomSheet>
        </div>
      );
    };
    // Step 3: Osmolar Gap (optional, for HAGMA)
    const Step3_OsmolarGap = ({ data, setData, onNext, onBack }) => {
      const [wantOG, setWantOG] = useState(null);
      
      // Robust parsing helper
      const parseVal = (v) => {
        if (!v || v === '') return null;
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      };
      
      const na = parseFloat(data.na) || 140;
      const glucose = parseVal(data.glucose);
      const urea = parseVal(data.urea);
      const measuredOsm = parseVal(data.measuredOsm);
      
      let osmGap = null;
      let canCalculate = glucose !== null && urea !== null && measuredOsm !== null;
      
      if (canCalculate) {
        const calculatedOsm = (2 * na) + glucose + urea;
        osmGap = measuredOsm - calculatedOsm;
      }

      const highOG = osmGap !== null && osmGap > 10;
      const highAG = data.isHAGMA;

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Step 3</div>
            <h1 style={styles.title}>Osmolar Gap</h1>
          </div>

          {wantOG === null && (
            <div style={styles.card} className="animate-in stagger-1">
              <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '14px', lineHeight: '1.5' }}>
                Detects abnormal solutes in plasma. Interpreted alongside the anion gap.
              </p>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                <button
                  style={{ ...styles.button, ...styles.buttonSmall }}
                  onClick={() => setWantOG(true)}
                >
                  Calculate
                </button>
                <button
                  style={{ ...styles.button, ...styles.buttonSmall, ...styles.buttonSecondary }}
                  onClick={() => { setWantOG(false); onNext(); }}
                >
                  Skip
                </button>
              </div>
            </div>
          )}

          {wantOG === true && (
            <>
              <div style={styles.card} className="animate-in stagger-1">
                <div style={styles.grid}>
                  <Input 
                    label="Glucose" 
                    unit="mmol/L" 
                    value={data.glucose || ''} 
                    onChange={v => setData(prev => ({...prev, glucose: v}))} 
                    placeholder="5.5"
                    autoFocus
                  />
                  <Input 
                    label="Urea" 
                    unit="mmol/L" 
                    value={data.urea || ''} 
                    onChange={v => setData(prev => ({...prev, urea: v}))} 
                    placeholder="5.0"
                  />
                </div>
                <Input 
                  label="Measured Osm" 
                  unit="mOsm/kg" 
                  value={data.measuredOsm || ''} 
                  onChange={v => setData(prev => ({...prev, measuredOsm: v}))} 
                  placeholder="285"
                />
              </div>

              {canCalculate && (
                <>
                  <div style={styles.card} className="animate-in">
                    <div style={styles.resultBox}>
                      <div style={styles.resultLabel}>Osmolar Gap</div>
                      <span style={styles.statusBadge(highOG ? 'error' : 'success')}>
                        {osmGap.toFixed(0)} mOsm/kg {highOG ? '(Elevated)' : '(Normal)'}
                      </span>
                    </div>
                    
                    <ExpandableWorking>
                      <p><Formula>OG = Measured − Calculated</Formula></p>
                      <p>Calculated = (2 × Na) + Glucose + Urea</p>
                      <p>= (2 × {na}) + {glucose} + {urea} = {((2 * na) + glucose + urea).toFixed(0)}</p>
                      <p>OG = {measuredOsm} − {((2 * na) + glucose + urea).toFixed(0)} = {osmGap.toFixed(0)}</p>
                      <Divider />
                      <p style={{ fontSize: '12px' }}>Normal {"<"} 10 mOsm/kg</p>
                    </ExpandableWorking>
                  </div>

                  {/* Interpretation based on OG + AG combination */}
                  <div style={styles.card} className="animate-in stagger-2">
                    <div style={styles.cardTitle}>
                      {highOG && highAG && 'High OG + High AG'}
                      {highOG && !highAG && 'High OG + Normal AG'}
                      {!highOG && highAG && 'Normal OG + High AG'}
                      {!highOG && !highAG && 'Normal OG + Normal AG'}
                    </div>
                    
                    {highOG && highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          Foreign solute that has dissociated
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>• Toxic alcohol (mid-stage)</p>
                          <p>• Salicylate intoxication</p>
                          <p>• Lactic acidosis</p>
                          <p>• Ketoacidosis</p>
                          <p>• AKI</p>
                        </div>
                      </>
                    )}
                    
                    {highOG && !highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          Foreign solute that has not dissociated
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>• Mannitol</p>
                          <p>• Ethanol</p>
                          <p>• Toxic alcohol (early)</p>
                          <p>• Glycine (TURP syndrome)</p>
                        </div>
                      </>
                    )}
                    
                    {!highOG && highAG && (
                      <>
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '12px', fontStyle: 'italic' }}>
                          No foreign osmoles — consider other HAGMA causes
                        </p>
                        <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                          <p>• Toxic alcohol (late — fully metabolised)</p>
                          <p>• Ketoacidosis</p>
                          <p>• Lactic acidosis</p>
                          <p>• Uraemia</p>
                        </div>
                      </>
                    )}
                    
                    {!highOG && !highAG && (
                      <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                        No evidence of abnormal solute.
                      </p>
                    )}
                  </div>

                  {/* Toxic alcohol timeline */}
                  {highOG && (
                    <div style={styles.card} className="animate-in stagger-3">
                      <div style={styles.cardTitle}>Toxic Alcohol Timeline</div>
                      <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Early</strong> — non-polar, not yet metabolised → ↑OG only</p>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Middle</strong> — partially metabolised to organic acids → ↑OG and ↑AG</p>
                        <p><strong style={{ color: 'var(--text-primary)' }}>Late</strong> — fully metabolised → ↑AG, normal OG</p>
                      </div>
                    </div>
                  )}
                </>
              )}

              <button
                className="animate-in stagger-4"
                style={styles.button}
                onClick={() => {
                  setData(prev => ({ ...prev, osmGap, highOG, ogCalculated: true }));
                  onNext();
                }}
              >
                Next →
              </button>
            </>
          )}
        </div>
      );
    };

    // Find Cause Screen (Step Two)
    // Lactate Causes Screen (sub-screen)
    // ============================================
    // FIND CAUSE - STEPWISE WORKFLOW
    // ============================================

    // Sub-screen: Lactate Causes
    // Lactic Acidosis Bottom Sheet Content
    const LactateCausesContent = () => (
      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Tissue Hypoxia</div>
          <div style={{ paddingLeft: '12px' }}>
            Hypoxaemia, insufficient cardiac output, anaemia, regional ischaemia (limb, mesenteric), COHb, MetHb
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Metabolic</div>
          <div style={{ paddingLeft: '12px' }}>
            Ketoacidosis, hyperglycaemia, thiamine deficiency, liver failure, sepsis, malignancy, inborn errors of metabolism
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Drugs &amp; Toxins</div>
          <div style={{ paddingLeft: '12px' }}>
            Toxic alcohols, metformin, cyanide, propofol infusion syndrome, paracetamol, salicylates
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Other</div>
          <div style={{ paddingLeft: '12px' }}>
            Beta-2 agonism, seizures, strenuous exercise
          </div>
        </div>
        
        <div style={{ padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '8px' }}>
          <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '4px' }}>Lactate Gap</div>
          <div style={{ fontSize: '12px', lineHeight: '1.5' }}>
            If <strong>POC lactate − Lab lactate &gt;5</strong>, suspect <strong style={{ color: 'var(--error)' }}>ethylene glycol</strong> poisoning (POC assay cross-reacts with glycolate).
          </div>
        </div>
      </div>
    );

    // Ketoacidosis Bottom Sheet Content
    const KetoacidosisCausesContent = () => (
      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Diabetic Ketoacidosis</div>
          <div style={{ paddingLeft: '12px' }}>
            Insulin deficiency + counter-regulatory hormones. Usually glucose &gt;14 mmol/L but euglycaemic DKA exists (especially with SGLT2 inhibitors).
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Alcoholic Ketoacidosis</div>
          <div style={{ paddingLeft: '12px' }}>
            Binge drinking + poor nutrition + vomiting. Glucose often low-normal. β-hydroxybutyrate predominates (nitroprusside test may be negative).
          </div>
        </div>
        
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '14px', fontWeight: '600', color: 'var(--text-primary)', marginBottom: '6px' }}>Starvation Ketosis</div>
          <div style={{ paddingLeft: '12px' }}>
            Prolonged fasting, anorexia, hyperemesis gravidarum. Ketones rarely high enough to cause significant acidosis.
          </div>
        </div>
      </div>
    );

    // Osmolar Gap Calculator for BottomSheet (with local state for stability)
    const OsmolarGapBottomSheetContent = ({ data, setData, na, sigElevated }) => {
      // Use local state - simpler, no syncing needed for bottom sheet context
      const [localOsm, setLocalOsm] = useState(data?.measuredOsm ? String(data.measuredOsm) : '');
      const [localGlucose, setLocalGlucose] = useState(data?.glucose ? String(data.glucose) : '');
      const [localUrea, setLocalUrea] = useState(data?.urea ? String(data.urea) : '');
      
      const parseVal = (v) => {
        if (!v || v === '') return null;
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      };
      
      const measOsm = parseVal(localOsm);
      const glucose = parseVal(localGlucose);
      const urea = parseVal(localUrea);
      const canCalculate = measOsm !== null && glucose !== null && urea !== null;
      const calcOsm = canCalculate ? (2 * na) + glucose + urea : null;
      const osmGap = canCalculate ? measOsm - calcOsm : null;
      const isElevated = osmGap !== null && osmGap > 10;
      
      return (
        <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
          <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '12px', fontSize: '13px' }}>
            <strong>What is the osmolar gap?</strong>
            <p style={{ marginTop: '4px', color: 'var(--text-secondary)' }}>
              The difference between measured and calculated osmolality. Detects unmeasured osmotically active substances.
            </p>
          </div>
          
          <div style={styles.grid}>
            <Input label="Measured Osm" unit="mOsm/kg" value={localOsm} onChange={setLocalOsm} placeholder="285" />
            <Input label="Glucose" unit="mmol/L" value={localGlucose} onChange={setLocalGlucose} placeholder="5.5" />
          </div>
          <Input label="Urea" unit="mmol/L" value={localUrea} onChange={setLocalUrea} placeholder="5.0" />
          
          {canCalculate && (
            <>
              <div style={{ marginTop: '12px', padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px' }}>
                <p>Calc Osm = 2×Na + Glucose + Urea = 2×{na} + {glucose} + {urea} = <strong>{calcOsm.toFixed(0)}</strong></p>
              </div>
              
              <div style={{ marginTop: '12px', padding: '12px', background: isElevated ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>Osmolar Gap</span>
                  <span style={{ fontSize: '20px', fontWeight: '700' }}>{osmGap.toFixed(0)}</span>
                </div>
                <div style={{ fontSize: '12px', marginTop: '4px', color: 'var(--text-secondary)' }}>
                  Normal: &lt;10 mOsm/kg
                </div>
              </div>
              
              {isElevated && (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--warning)' }}>Elevated OG — causes:</strong>
                  <p style={{ marginTop: '6px', color: 'var(--text-secondary)', fontSize: '12px' }}>
                    Toxic alcohols (methanol, ethylene glycol, isopropanol), ethanol, mannitol/sorbitol, glycine (TURP syndrome), severe hyperproteinaemia/hyperlipidaemia, contrast media
                  </p>
                </div>
              )}
              
              {isElevated && sigElevated && (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--error-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--error)' }}>⚠️ Elevated OG + elevated SIG</strong>
                  <p style={{ marginTop: '4px', color: 'var(--text-secondary)', fontSize: '12px' }}>
                    High suspicion for toxic alcohols — parent compound raises osmolality while metabolites (formic acid, glycolic acid) cause acidosis.
                  </p>
                </div>
              )}
            </>
          )}
        </div>
      );
    };

    // Sub-screen: Osmolar Gap Calculator
    const OsmolarGapScreen = ({ data, setData, onBack, onNext }) => {
      // Use local state for inputs - only sync back when leaving
      const [localOsm, setLocalOsm] = useState(data?.measuredOsm ? String(data.measuredOsm) : '');
      const [localGlucose, setLocalGlucose] = useState(data?.glucose ? String(data.glucose) : '');
      const [localUrea, setLocalUrea] = useState(data?.urea ? String(data.urea) : '');
      
      const na = parseFloat(data?.na) || 140;
      
      // Robust parsing - only return number if valid
      const parseVal = (v) => {
        if (!v || v === '') return null;
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      };
      
      const measOsm = parseVal(localOsm);
      const glucose = parseVal(localGlucose);
      const urea = parseVal(localUrea);
      
      const canCalculate = measOsm !== null && glucose !== null && urea !== null;
      const calcOsm = canCalculate ? (2 * na) + glucose + urea : null;
      const osmGap = canCalculate ? measOsm - calcOsm : null;
      const isElevated = osmGap !== null && osmGap > 10;
      const correctedAG = parseFloat(data?.correctedAG) || 12;
      const highAG = correctedAG > 14;
      
      // Sync back to parent when leaving
      const syncAndExit = (callback) => {
        if (setData) {
          setData(prev => ({
            ...prev, 
            measuredOsm: localOsm, 
            glucose: localGlucose, 
            urea: localUrea,
            osmGapCalculated: canCalculate,
            osmGapValue: osmGap,
            osmGapElevated: isElevated
          }));
        }
        callback();
      };
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={() => syncAndExit(onBack)}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <h1 style={styles.title}>Osmolar Gap</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
              Detects unmeasured osmotically active substances
            </div>
            <div style={styles.grid}>
              <Input label="Measured Osm" unit="mOsm/kg" value={localOsm} onChange={setLocalOsm} placeholder="285" />
              <Input label="Glucose" unit="mmol/L" value={localGlucose} onChange={setLocalGlucose} placeholder="5.5" />
            </div>
            <Input label="Urea" unit="mmol/L" value={localUrea} onChange={setLocalUrea} placeholder="5.0" />
            
            {canCalculate && (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px', background: isElevated ? 'var(--error-light)' : 'var(--success-light)', borderRadius: '8px', marginTop: '12px' }}>
                <div>
                  <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>Osmolar Gap</div>
                  <div style={{ fontSize: '20px', fontWeight: '700' }}>{osmGap.toFixed(0)}</div>
                  <div style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>Normal &lt;10</div>
                </div>
                <span style={styles.statusBadge(isElevated ? 'error' : 'success')}>{isElevated ? '↑Elevated' : 'Normal'}</span>
              </div>
            )}
          </div>

          {canCalculate && (
            <div style={styles.card} className="animate-in stagger-2">
              <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '10px' }}>
                Calc Osm = 2×{na} + {glucose} + {urea} = {calcOsm.toFixed(0)}
              </div>
              
              {isElevated && highAG && (
                <div style={{ padding: '10px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '10px' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: 'var(--error)', marginBottom: '4px' }}>↑OG + ↑AG pattern:</div>
                  <div style={{ fontSize: '12px', lineHeight: '1.6', color: 'var(--text-secondary)' }}>
                    Toxic alcohol (mid-stage), salicylate intoxication, severe lactic acidosis, ketoacidosis
                  </div>
                </div>
              )}
              {isElevated && !highAG && (
                <div style={{ padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', marginBottom: '10px' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', color: 'var(--warning)', marginBottom: '4px' }}>↑OG + normal AG pattern:</div>
                  <div style={{ fontSize: '12px', lineHeight: '1.6', color: 'var(--text-secondary)' }}>
                    Toxic alcohol (early), ethanol, mannitol/sorbitol, glycine (TURP syndrome), contrast media
                  </div>
                </div>
              )}
              {!isElevated && highAG && (
                <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '10px' }}>
                  <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '4px' }}>Normal OG + ↑AG pattern:</div>
                  <div style={{ fontSize: '12px', lineHeight: '1.6', color: 'var(--text-secondary)' }}>
                    Toxic alcohol (late — fully metabolised), ketoacidosis, lactic acidosis, uraemia
                  </div>
                </div>
              )}
              {!isElevated && !highAG && (
                <div style={{ fontSize: '12px', color: 'var(--success)' }}>No evidence of abnormal solute load.</div>
              )}
              
              {isElevated && (
                <div style={{ padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px', fontSize: '11px', color: 'var(--text-secondary)' }}>
                  <strong>Toxic alcohol timeline:</strong><br/>
                  Early: ↑OG only → Mid: ↑OG+↑AG → Late: ↑AG only
                </div>
              )}
            </div>
          )}

          {onNext && (
            <button className="animate-in stagger-3" style={styles.button} onClick={() => syncAndExit(onNext)}>
              Continue →
            </button>
          )}
          
          <button className="animate-in stagger-3" style={{ ...styles.button, ...styles.buttonSecondary, marginTop: onNext ? '8px' : '0' }} onClick={() => syncAndExit(onBack)}>
            ← Back
          </button>
        </div>
      );
    };

    // Process Screen: HAGMA Workup
    const HAGMAWorkupScreen = ({ data, setData, onNext, onBack }) => {
      const [subScreen, setSubScreen] = useState(null);
      const [showSheet, setShowSheet] = useState(null); // 'lactate', 'ketones', 'dlactate', 'pyroglutamic'
      const [investigatedUnexplained, setInvestigatedUnexplained] = useState(false);
      
      const correctedAG = parseFloat(data.correctedAG) || 12;
      const excessAG = Math.max(0, correctedAG - 12);
      const lactateVal = data.lactate && !isNaN(parseFloat(data.lactate)) ? parseFloat(data.lactate) : null;
      const lactateContribution = lactateVal !== null && lactateVal > 1 ? lactateVal - 1 : 0;
      const ketonesVal = data.ketones && !isNaN(parseFloat(data.ketones)) ? parseFloat(data.ketones) : null;
      const ketoneContribution = ketonesVal !== null && ketonesVal > 0.6 ? ketonesVal - 0.6 : 0;
      const explainedAG = lactateContribution + ketoneContribution;
      const unexplainedAG = Math.max(0, excessAG - explainedAG);
      const hasUnexplainedGap = unexplainedAG >= 2;
      const hasAnyInput = lactateVal !== null || ketonesVal !== null;
      
      // Can continue if gap is fully explained OR user has investigated
      const canContinue = !hasUnexplainedGap || investigatedUnexplained;
      
      // Calculate percentages for visual bar
      const totalBar = Math.max(excessAG, 1);
      const lactatePct = (lactateContribution / totalBar) * 100;
      const ketonePct = (ketoneContribution / totalBar) * 100;
      
      // Anion gap bar component - reusable
      const AnionGapBar = ({ showLegend = true }) => (
        <div>
          <div style={{ height: '28px', background: 'var(--bg-tertiary)', borderRadius: '6px', overflow: 'hidden', display: 'flex', border: '1px solid var(--border)' }}>
            {lactateContribution > 0 && (
              <div style={{ 
                width: `${lactatePct}%`, 
                background: 'linear-gradient(135deg, #FF9500, #FF6B00)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', fontWeight: '600', color: 'white',
                minWidth: lactateContribution > 0.5 ? '36px' : '0'
              }}>
                {lactateContribution >= 1 && `${lactateContribution.toFixed(1)}`}
              </div>
            )}
            {ketoneContribution > 0 && (
              <div style={{ 
                width: `${ketonePct}%`, 
                background: 'linear-gradient(135deg, #AF52DE, #8B3FC7)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', fontWeight: '600', color: 'white',
                minWidth: ketoneContribution > 0.5 ? '36px' : '0'
              }}>
                {ketoneContribution >= 1 && `${ketoneContribution.toFixed(1)}`}
              </div>
            )}
            {hasAnyInput && unexplainedAG > 0.1 && (
              <div style={{ 
                flex: 1,
                background: hasUnexplainedGap ? 'linear-gradient(135deg, #FF3B30, #D62D20)' : 'var(--success-light)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', fontWeight: '600', color: hasUnexplainedGap ? 'white' : 'var(--success)',
              }}>
                {unexplainedAG >= 0.5 && (hasUnexplainedGap ? `? ${unexplainedAG.toFixed(1)}` : '✓')}
              </div>
            )}
            {!hasAnyInput && (
              <div style={{ 
                flex: 1,
                background: 'repeating-linear-gradient(45deg, var(--border), var(--border) 10px, var(--bg-tertiary) 10px, var(--bg-tertiary) 20px)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                fontSize: '11px', color: 'var(--text-secondary)',
              }}>
                Enter values
              </div>
            )}
          </div>
          {showLegend && hasAnyInput && (
            <div style={{ display: 'flex', gap: '12px', marginTop: '6px', fontSize: '10px', color: 'var(--text-tertiary)' }}>
              {lactateContribution > 0 && (
                <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                  <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: '#FF9500' }} />
                  <span>Lactate</span>
                </div>
              )}
              {ketoneContribution > 0 && (
                <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                  <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: '#AF52DE' }} />
                  <span>Ketones</span>
                </div>
              )}
              {hasUnexplainedGap && (
                <div style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                  <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: '#FF3B30' }} />
                  <span>Unexplained</span>
                </div>
              )}
            </div>
          )}
        </div>
      );
      
      if (subScreen === 'osmolar') {
        return <OsmolarGapScreen 
          data={data} 
          setData={setData} 
          onBack={() => setSubScreen(null)} 
          onNext={() => { setInvestigatedUnexplained(true); setSubScreen(null); }}
        />;
      }
      
      if (subScreen === 'unexplained') {
        // Check if osmolar gap was calculated and elevated
        const ogElevated = data.osmGapElevated;
        const ogValue = data.osmGapValue;
        
        return (
          <div style={styles.container}>
            <button style={styles.backButton} onClick={() => { setSubScreen(null); setInvestigatedUnexplained(true); }}><BackIcon /> Back</button>
            
            <div style={styles.header} className="animate-in">
              <h1 style={styles.title}>Unexplained Anions</h1>
            </div>

            <div style={styles.card} className="animate-in stagger-1">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: '8px' }}>
                <span style={{ fontSize: '13px', fontWeight: '600' }}>Excess AG</span>
                <span style={{ fontSize: '16px', fontWeight: '700', color: 'var(--error)' }}>+{excessAG.toFixed(1)}</span>
              </div>
              <AnionGapBar showLegend={true} />
              <div style={{ marginTop: '10px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                Lactate contributes +{lactateContribution.toFixed(1)}, ketones +{ketoneContribution.toFixed(1)}.
                {ogElevated && <span style={{ display: 'block', color: 'var(--warning)', marginTop: '4px' }}>Osmolar gap elevated ({ogValue?.toFixed(0)}) — toxic alcohols may contribute.</span>}
                {!ogElevated && <strong style={{ display: 'block', color: 'var(--error)', marginTop: '4px' }}>+{unexplainedAG.toFixed(1)} remains unexplained.</strong>}
              </div>
              
              <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid var(--border)' }}>
                <div style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-secondary)', marginBottom: '10px', letterSpacing: '0.5px' }}>DIFFERENTIAL DIAGNOSIS</div>
                <div style={{ fontSize: '13px', lineHeight: '1.9', color: 'var(--text-secondary)' }}>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Renal failure</strong> — accumulation of sulphates, phosphates, organic anions</p>
                  <p>
                    <strong style={{ color: 'var(--text-primary)' }}>Pyroglutamic acidosis</strong>
                    <button onClick={() => setShowSheet('pyroglutamic')} style={{ marginLeft: '6px', fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font)' }}>ⓘ</button>
                  </p>
                  <p><strong style={{ color: 'var(--text-primary)' }}>Salicylate overdose</strong></p>
                  <p>
                    <strong style={{ color: 'var(--text-primary)' }}>D-lactate</strong>
                    <button onClick={() => setShowSheet('dlactate')} style={{ marginLeft: '6px', fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font)' }}>ⓘ</button>
                  </p>
                  {!ogElevated && <p><strong style={{ color: 'var(--text-primary)' }}>Toxic alcohols</strong> — check osmolar gap</p>}
                  {ogElevated && <p><strong style={{ color: 'var(--warning)' }}>⚠️ Toxic alcohols</strong> — elevated osmolar gap detected</p>}
                </div>
              </div>
            </div>

            {!data.osmGapCalculated && (
              <button 
                className="animate-in stagger-2"
                style={{ 
                  width: '100%', padding: '12px', background: 'var(--bg-tertiary)', color: 'var(--text-primary)',
                  border: '1px solid var(--border)', borderRadius: '10px', fontSize: '14px', fontWeight: '500',
                  cursor: 'pointer', fontFamily: 'var(--font)', marginBottom: '12px'
                }} 
                onClick={() => setSubScreen('osmolar')}
              >
                Check Osmolar Gap →
              </button>
            )}
            
            {data.osmGapCalculated && (
              <div style={{ ...styles.card, background: ogElevated ? 'var(--warning-light)' : 'var(--success-light)', marginBottom: '12px' }} className="animate-in stagger-2">
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ fontSize: '14px' }}>{ogElevated ? '⚠️' : '✓'}</span>
                  <div>
                    <div style={{ fontWeight: '600', fontSize: '13px' }}>Osmolar Gap: {ogValue?.toFixed(0)}</div>
                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                      {ogElevated ? 'Elevated — consider toxic alcohol' : 'Normal — toxic alcohol less likely'}
                    </div>
                  </div>
                </div>
                <button 
                  style={{ marginTop: '8px', fontSize: '12px', color: 'var(--accent)', background: 'none', border: 'none', padding: 0, cursor: 'pointer', fontFamily: 'var(--font)' }}
                  onClick={() => setSubScreen('osmolar')}
                >
                  Recalculate →
                </button>
              </div>
            )}

            <button className="animate-in stagger-3" style={styles.button} onClick={() => { setInvestigatedUnexplained(true); onNext(); }}>
              Continue →
            </button>
            
            {/* D-lactate info sheet */}
            <BottomSheet isOpen={showSheet === 'dlactate'} onClose={() => setShowSheet(null)} title="D-Lactate">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
                <p style={{ marginBottom: '12px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>D-lactate</strong> is produced by gut bacteria and not detected by standard L-lactate assays.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>When to suspect:</strong> Short bowel syndrome, jejunoileal bypass, or other conditions with bacterial overgrowth in a blind loop.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>Clinical features:</strong> Episodic encephalopathy, ataxia, slurred speech — often after high-carbohydrate meals.
                </p>
                <p>
                  <strong>Diagnosis:</strong> Request specific D-lactate assay (not routine).
                </p>
              </div>
            </BottomSheet>
            
            {/* Pyroglutamic acidosis info sheet */}
            <BottomSheet isOpen={showSheet === 'pyroglutamic'} onClose={() => setShowSheet(null)} title="Pyroglutamic Acidosis">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
                <p style={{ marginBottom: '12px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>5-oxoproline (pyroglutamic acid)</strong> accumulation causes HAGMA, often unrecognised.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>Risk factors:</strong> Chronic paracetamol use + malnutrition/sepsis/renal impairment. Glutathione depletion disrupts the γ-glutamyl cycle.
                </p>
                <p style={{ marginBottom: '12px' }}>
                  <strong>Clinical clues:</strong> Elderly female, chronic paracetamol (even therapeutic doses), poor nutrition, unexplained HAGMA.
                </p>
              </div>
            </BottomSheet>
          </div>
        );
      }
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process 1</div>
            <h1 style={styles.title}>HAGMA Workup</h1>
          </div>
          
          {/* Input section FIRST */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: '10px' }}>
              <span style={{ fontSize: '11px', fontWeight: '600', color: 'var(--text-tertiary)', letterSpacing: '0.5px' }}>MEASURED VALUES</span>
              <span style={{ fontSize: '14px', fontWeight: '600', color: 'var(--error)' }}>+{excessAG.toFixed(1)} to explain</span>
            </div>
            
            {/* Lactate row */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
              <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: lactateContribution > 0 ? '#FF9500' : 'var(--border)', flexShrink: 0 }} />
              <span style={{ fontSize: '13px', width: '55px', flexShrink: 0 }}>Lactate</span>
              <div style={{ width: '70px' }}>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.lactate || ''}
                  onChange={e => setData(prev => ({...prev, lactate: e.target.value}))}
                  placeholder="—"
                  style={{
                    width: '100%',
                    padding: '8px 10px',
                    fontSize: '15px',
                    fontWeight: '500',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    background: 'var(--bg-tertiary)',
                    fontFamily: 'var(--font)',
                    textAlign: 'center',
                  }}
                />
              </div>
              <span style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>mmol/L</span>
              <span style={{ marginLeft: 'auto', fontSize: '14px', fontWeight: '600', color: lactateContribution > 0 ? '#FF9500' : 'var(--text-tertiary)' }}>
                {lactateVal !== null ? `+${lactateContribution.toFixed(1)}` : ''}
              </span>
              {lactateVal > 2 && (
                <button onClick={() => setShowSheet('lactate')} style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font)', padding: '4px' }}>ⓘ</button>
              )}
            </div>
            
            {/* Ketones row */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
              <div style={{ width: '8px', height: '8px', borderRadius: '2px', background: ketoneContribution > 0 ? '#AF52DE' : 'var(--border)', flexShrink: 0 }} />
              <span style={{ fontSize: '13px', width: '55px', flexShrink: 0 }}>Ketones</span>
              <div style={{ width: '70px' }}>
                <input
                  type="text"
                  inputMode="decimal"
                  value={data.ketones || ''}
                  onChange={e => setData(prev => ({...prev, ketones: e.target.value}))}
                  placeholder="—"
                  style={{
                    width: '100%',
                    padding: '8px 10px',
                    fontSize: '15px',
                    fontWeight: '500',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    background: 'var(--bg-tertiary)',
                    fontFamily: 'var(--font)',
                    textAlign: 'center',
                  }}
                />
              </div>
              <span style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>mmol/L</span>
              <span style={{ marginLeft: 'auto', fontSize: '14px', fontWeight: '600', color: ketoneContribution > 0 ? '#AF52DE' : 'var(--text-tertiary)' }}>
                {ketonesVal !== null ? `+${ketoneContribution.toFixed(1)}` : ''}
              </span>
              {ketonesVal > 1 && (
                <button onClick={() => setShowSheet('ketones')} style={{ fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font)', padding: '4px' }}>ⓘ</button>
              )}
            </div>
          </div>

          {/* Visual bar BELOW inputs */}
          {hasAnyInput && (
            <div style={styles.card} className="animate-in stagger-2">
              <AnionGapBar showLegend={true} />
            </div>
          )}

          {/* Unexplained gap message */}
          {hasUnexplainedGap && !investigatedUnexplained && (
            <div style={{ ...styles.card, background: 'var(--warning-light)', borderLeft: '3px solid var(--warning)' }} className="animate-in stagger-3">
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
                Accounting for lactataemia and ketosis, there are still <strong style={{ color: 'var(--warning)' }}>+{unexplainedAG.toFixed(1)} unexplained anions</strong>.
              </div>
              <button 
                onClick={() => setSubScreen('unexplained')}
                style={{ 
                  marginTop: '12px', width: '100%', padding: '10px', 
                  background: 'var(--warning)', color: 'white',
                  border: 'none', borderRadius: '8px', fontSize: '13px', fontWeight: '600',
                  cursor: 'pointer', fontFamily: 'var(--font)'
                }}
              >
                Investigate unexplained gap →
              </button>
            </div>
          )}
          
          {/* Investigated but still unexplained */}
          {hasUnexplainedGap && investigatedUnexplained && (
            <div style={{ ...styles.card, background: 'var(--bg-tertiary)' }} className="animate-in stagger-3">
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '14px' }}>⚠️</span>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  +{unexplainedAG.toFixed(1)} remains unexplained
                </div>
              </div>
              <button 
                style={{ marginTop: '8px', fontSize: '12px', color: 'var(--accent)', background: 'none', border: 'none', padding: 0, cursor: 'pointer', fontFamily: 'var(--font)' }}
                onClick={() => setSubScreen('unexplained')}
              >
                Review differential →
              </button>
            </div>
          )}
          
          {/* Success state when fully explained */}
          {hasAnyInput && !hasUnexplainedGap && (
            <div style={{ ...styles.card, background: 'var(--success-light)', borderLeft: '3px solid var(--success)' }} className="animate-in stagger-3">
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <span style={{ fontSize: '16px' }}>✓</span>
                <div>
                  <div style={{ fontWeight: '600', color: 'var(--success)', fontSize: '14px' }}>Gap adequately explained</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                    Lactate and ketones account for the elevated AG
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Continue button */}
          {canContinue && (
            <button className="animate-in stagger-4" style={styles.button} onClick={onNext}>
              Continue →
            </button>
          )}
          
          {/* Bottom sheets for lactate/ketone info */}
          <BottomSheet isOpen={showSheet === 'lactate'} onClose={() => setShowSheet(null)} title="Lactic Acidosis">
            <LactateCausesContent />
          </BottomSheet>
          
          <BottomSheet isOpen={showSheet === 'ketones'} onClose={() => setShowSheet(null)} title="Ketoacidosis">
            <KetoacidosisCausesContent />
          </BottomSheet>
        </div>
      );
    };

    // Process Screen: NAGMA
    const NAGMAScreen = ({ onNext, onBack, processNumber }) => {
      const [showRTA, setShowRTA] = useState(false);
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Process {processNumber}</div>
            <h1 style={styles.title}>NAGMA</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
              Normal anion gap metabolic acidosis — HCO₃⁻ loss or impaired renal acid excretion
            </div>
            <div style={{ fontSize: '13px', lineHeight: '1.9', color: 'var(--text-secondary)' }}>
              <p><strong style={{ color: 'var(--text-primary)' }}>GI bicarbonate loss</strong></p>
              <p style={{ paddingLeft: '12px' }}>Diarrhoea, fistulae, ileostomy, ureterosigmoidostomy</p>
              
              <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Renal tubular acidosis</strong></p>
              <p style={{ paddingLeft: '12px' }}>Type 1 (distal), Type 2 (proximal), Type 4 (hypoaldosteronism)</p>
              
              <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Chloride excess</strong></p>
              <p style={{ paddingLeft: '12px' }}>0.9% saline infusion, TPN</p>
              
              <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Other</strong></p>
              <p style={{ paddingLeft: '12px' }}>Early renal failure, dilutional, post-DKA recovery, carbonic anhydrase inhibitors</p>
            </div>
          </div>
          
          <div style={styles.card} className="animate-in stagger-2">
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
              Urine anion gap helps differentiate:
            </div>
            <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '10px' }}>
              <Formula>UAG = Urine Na + Urine K − Urine Cl</Formula>
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              <div style={{ flex: 1, padding: '10px', background: 'var(--success-light)', borderRadius: '8px', fontSize: '12px' }}>
                <div style={{ fontWeight: '600', marginBottom: '4px' }}>Negative UAG</div>
                <div style={{ color: 'var(--text-secondary)' }}>GI loss (appropriate NH₄⁺ excretion)</div>
              </div>
              <div style={{ flex: 1, padding: '10px', background: 'var(--warning-light)', borderRadius: '8px', fontSize: '12px' }}>
                <div style={{ fontWeight: '600', marginBottom: '4px' }}>Positive UAG</div>
                <div style={{ color: 'var(--text-secondary)' }}>RTA (impaired renal acid excretion)</div>
              </div>
            </div>
            
            <button 
              style={{ ...styles.buttonSmall, marginTop: '12px', width: '100%', justifyContent: 'center' }}
              onClick={() => setShowRTA(!showRTA)}
            >
              {showRTA ? 'Hide' : 'Show'} RTA differentiation
            </button>
            
            {showRTA && (
              <div style={{ marginTop: '12px', fontSize: '12px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
                <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '8px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>Type 1 (Distal)</strong>
                  <p>Urine pH persistently &gt;5.5, hypokalaemia</p>
                  <p style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>Autoimmune (Sjögren's, SLE), nephrolithiasis, amphotericin B</p>
                </div>
                <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '8px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>Type 2 (Proximal)</strong>
                  <p>Urine pH variable, hypokalaemia, may have glycosuria/phosphaturia</p>
                  <p style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>Fanconi syndrome, myeloma, carbonic anhydrase inhibitors</p>
                </div>
                <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px' }}>
                  <strong style={{ color: 'var(--text-primary)' }}>Type 4 (Hypoaldosteronism)</strong>
                  <p>Urine pH &lt;5.5, <strong>hyperkalaemia</strong></p>
                  <p style={{ fontSize: '11px', color: 'var(--text-tertiary)' }}>Diabetes, CKD, ACEi/ARB, spironolactone, trimethoprim</p>
                </div>
                <div style={{ marginTop: '10px', padding: '8px', background: 'var(--accent-light)', borderRadius: '6px', fontSize: '11px' }}>
                  <strong>Key discriminator:</strong> Serum K⁺ — low in Type 1/2, high in Type 4
                </div>
              </div>
            )}
          </div>

          <button
            className="animate-in stagger-3"
            style={styles.button}
            onClick={onNext}
          >
            Continue →
          </button>
        </div>
      );
    };

    // Process Screen: Metabolic Alkalosis
    const MetAlkalosisScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>Metabolic Alkalosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={styles.cardTitle}>Differential</div>
          <div style={{ fontSize: '13px', lineHeight: '1.9', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Gain of HCO₃⁻</strong></p>
            <p style={{ paddingLeft: '12px' }}>NaHCO₃ administration, citrate (CRRT, blood transfusion)</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Loss of H⁺ from GIT</strong></p>
            <p style={{ paddingLeft: '12px' }}>Vomiting, NG suction</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Loss of H⁺ from kidneys</strong></p>
            <p style={{ paddingLeft: '12px' }}>Loop or thiazide diuretics</p>
            <p style={{ paddingLeft: '12px' }}>Mineralocorticoid excess (hyperaldosteronism, Cushing's, exogenous corticosteroid)</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Severe hypokalaemia</strong></p>
            <p style={{ paddingLeft: '12px' }}>Causes intracellular H⁺ shift and renal H⁺ excretion</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Hypovolaemia</strong></p>
            <p style={{ paddingLeft: '12px' }}>Contraction alkalosis</p>
          </div>
        </div>
        
        <div style={styles.card} className="animate-in stagger-2">
          <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
            Spot urine chloride can help differentiate:
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            <div style={{ flex: 1, padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px' }}>
              <div style={{ fontWeight: '600', marginBottom: '4px' }}>Cl⁻ &lt;20</div>
              <div style={{ color: 'var(--text-secondary)' }}>Vomiting, NG suction, remote diuretics</div>
            </div>
            <div style={{ flex: 1, padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px' }}>
              <div style={{ fontWeight: '600', marginBottom: '4px' }}>Cl⁻ &gt;20</div>
              <div style={{ color: 'var(--text-secondary)' }}>Mineralocorticoid excess, current diuretics</div>
            </div>
          </div>
        </div>

        <button
          className="animate-in stagger-3"
          style={styles.button}
          onClick={onNext}
        >
          Continue →
        </button>
      </div>
    );

    // Process Screen: Respiratory Acidosis
    const RespAcidosisScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>Resp. Acidosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
            Hypoventilation → CO₂ retention
          </div>
          <div style={{ fontSize: '13px', lineHeight: '1.9', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Reduced central drive</strong></p>
            <p style={{ paddingLeft: '12px' }}>Opioids, sedatives, anaesthesia, brainstem pathology, severe hypothyroidism</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Neuromuscular weakness</strong></p>
            <p style={{ paddingLeft: '12px' }}>Guillain-Barré, myasthenia gravis, MND, critical illness myopathy, high spinal cord injury, phrenic nerve injury</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Chest wall/pleural</strong></p>
            <p style={{ paddingLeft: '12px' }}>Flail chest, kyphoscoliosis, massive obesity, large pleural effusion, pneumothorax</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Airway obstruction</strong></p>
            <p style={{ paddingLeft: '12px' }}>Severe asthma/COPD, upper airway obstruction, OSA</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Severe parenchymal disease</strong></p>
            <p style={{ paddingLeft: '12px' }}>End-stage COPD, severe pneumonia, ARDS (late)</p>
          </div>
        </div>

        <button className="animate-in stagger-2" style={styles.button} onClick={onNext}>
          Continue →
        </button>
      </div>
    );

    // Process Screen: Respiratory Alkalosis
    const RespAlkalosisScreen = ({ onNext, onBack, processNumber }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Process {processNumber}</div>
          <h1 style={styles.title}>Resp. Alkalosis</h1>
        </div>

        <div style={styles.card} className="animate-in stagger-1">
          <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
            Hyperventilation → CO₂ washout
          </div>
          <div style={{ fontSize: '13px', lineHeight: '1.9', color: 'var(--text-secondary)' }}>
            <p><strong style={{ color: 'var(--text-primary)' }}>Hypoxaemia-driven</strong></p>
            <p style={{ paddingLeft: '12px' }}>Pneumonia, pulmonary embolism, pulmonary oedema, interstitial lung disease, high altitude, severe anaemia</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Central stimulation</strong></p>
            <p style={{ paddingLeft: '12px' }}>Pain, anxiety/panic, fever, sepsis, CNS pathology (stroke, infection, tumour), salicylate toxicity (early)</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Hormonal/metabolic</strong></p>
            <p style={{ paddingLeft: '12px' }}>Pregnancy, hepatic encephalopathy, hyperthyroidism</p>
            
            <p style={{ marginTop: '10px' }}><strong style={{ color: 'var(--text-primary)' }}>Iatrogenic</strong></p>
            <p style={{ paddingLeft: '12px' }}>Mechanical overventilation</p>
          </div>
        </div>
        
        <div style={styles.card} className="animate-in stagger-2">
          <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
            <strong style={{ color: 'var(--text-primary)' }}>Clinical tip:</strong> If hypoxaemic, the respiratory alkalosis is likely appropriate compensation for hypoxia. If normoxic, look for central causes.
          </div>
        </div>

        <button className="animate-in stagger-3" style={styles.button} onClick={onNext}>
          Continue →
        </button>
      </div>
    );

    // Summary Screen
    const SummaryScreen = ({ data, processes, approach, onRestart, onSwitchToStewart, onBack }) => {
      const [copied, setCopied] = useState(false);
      
      const generateRecordText = () => {
        const ag = parseFloat(data.correctedAG).toFixed(0);
        const processLabels = processes.map(p => p.label).join(', ');
        
        let interpretation = `Primary: ${data.primaryDisorder || processLabels}`;
        if (data.isHAGMA) interpretation += ` (AG ${ag})`;
        if (data.compensationResult) interpretation += `. ${data.compensationResult}`;
        if (data.deltaInterpretation && data.deltaInterpretation !== 'No additional disorder') {
          interpretation += `. Delta ratio: ${data.deltaInterpretation}`;
        }
        
        let drivers = [];
        if (data.lactate && parseFloat(data.lactate) > 2) drivers.push(`Lactate ${data.lactate}`);
        if (data.ketones && parseFloat(data.ketones) > 0.6) drivers.push(`Ketones ${data.ketones}`);
        
        let text = `ABG Analysis: pH ${data.pH} | pCO₂ ${data.paCO2} | HCO₃ ${data.hco3}. ${interpretation}`;
        if (drivers.length > 0) text += `. Drivers: ${drivers.join(', ')}.`;
        
        return text;
      };
      
      const copyToClipboard = () => {
        navigator.clipboard.writeText(generateRecordText()).then(() => {
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        });
      };
      
      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <div style={styles.stepIndicator}>Complete</div>
            <h1 style={styles.title}>Summary</h1>
          </div>

          <div style={styles.card} className="animate-in stagger-1">
            <div style={styles.cardTitle}>Identified Processes</div>
            <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
              {processes.map((p, i) => (
                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '6px 0' }}>
                  <span style={{ color: 'var(--success)', fontSize: '16px' }}>✓</span>
                  <span>{p.label}</span>
                </div>
              ))}
            </div>
            
            {/* HAGMA breakdown if applicable */}
            {data.isHAGMA && (
              <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                  Anion gap breakdown (AG {parseFloat(data.correctedAG).toFixed(0)}, excess +{(parseFloat(data.correctedAG) - 12).toFixed(1)}):
                </div>
                <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
                  {(() => {
                    const lactateVal = data.lactate ? parseFloat(data.lactate) : null;
                    const ketonesVal = data.ketones ? parseFloat(data.ketones) : null;
                    const lactateContrib = lactateVal && lactateVal > 1 ? lactateVal - 1 : 0;
                    const ketoneContrib = ketonesVal && ketonesVal > 0.6 ? ketonesVal - 0.6 : 0;
                    const excessAG = parseFloat(data.correctedAG) - 12;
                    const unexplained = Math.max(0, excessAG - lactateContrib - ketoneContrib);
                    const ogElevated = data.osmGapElevated;
                    const ogValue = data.osmGapValue;
                    
                    const items = [];
                    if (lactateContrib > 0) {
                      items.push(<div key="lactate" style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span>Lactate ({lactateVal} mmol/L)</span>
                        <span style={{ fontWeight: '500' }}>+{lactateContrib.toFixed(1)}</span>
                      </div>);
                    }
                    if (ketoneContrib > 0) {
                      items.push(<div key="ketones" style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span>Ketones ({ketonesVal} mmol/L)</span>
                        <span style={{ fontWeight: '500' }}>+{ketoneContrib.toFixed(1)}</span>
                      </div>);
                    }
                    if (unexplained >= 2 || (lactateContrib === 0 && ketoneContrib === 0)) {
                      if (ogElevated) {
                        items.push(<div key="other" style={{ display: 'flex', justifyContent: 'space-between', color: 'var(--warning)' }}>
                          <span>Other (↑OG {ogValue?.toFixed(0)} — toxic alcohol?)</span>
                          <span style={{ fontWeight: '500' }}>+{unexplained.toFixed(1)}</span>
                        </div>);
                      } else {
                        items.push(<div key="other" style={{ display: 'flex', justifyContent: 'space-between', color: unexplained >= 2 ? 'var(--text-primary)' : 'var(--text-secondary)' }}>
                          <span>Other/unexplained</span>
                          <span style={{ fontWeight: '500' }}>+{unexplained.toFixed(1)}</span>
                        </div>);
                      }
                    }
                    return items;
                  })()}
                </div>
              </div>
            )}
          </div>

          <button
            className="animate-in stagger-2"
            style={{ ...styles.button, marginTop: '12px', background: 'var(--bg-tertiary)', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}
            onClick={copyToClipboard}
          >
            {copied ? '✓ Copied to clipboard' : '📋 Copy for medical record'}
          </button>

          {approach === 'traditional' && (
            <button
              className="animate-in stagger-2"
              style={{ ...styles.button, marginTop: '8px' }}
              onClick={onSwitchToStewart}
            >
              Analyse with Physicochemical model →
            </button>
          )}

          <button
            className="animate-in stagger-2"
            style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '8px' }}
            onClick={onRestart}
          >
            New Analysis
          </button>

          <div style={{ textAlign: 'center', padding: '12px 16px 8px', fontSize: '11px', color: 'var(--text-tertiary)' }}>
            For educational purposes only.<br/>© 2025 Scott Santinon
          </div>
        </div>
      );
    };

    // Pattern matching for syndromes
    const checkSyndromePatterns = (data) => {
      const syndromes = [];
      
      const na = parseFloat(data.na) || 140;
      const k = parseFloat(data.k) || 4;
      const ca = parseFloat(data.ca) || 1.15;
      const mg = parseFloat(data.mg) || 0.85;
      const phosphate = parseFloat(data.phosphate) || 1.1;
      const glucose = parseFloat(data.glucose);
      const lactate = parseFloat(data.lactate) || 1;
      // Include hidden HAGMA (elevated AG despite normal/alkalemic pH)
      const isHAGMA = data.isHAGMA;
      const isNAGMA = data.isMetabolic && data.isAcidosis && !data.isHAGMA;
      const isMetAlk = data.isMetabolic && data.isAlkalosis;
      
      // Adrenal insufficiency (Addison's): Hyponatraemia, Hyperkalaemia, NAGMA
      if (na < 135 && k > 5.0) {
        syndromes.push({
          name: "Adrenal Insufficiency",
          findings: ['Hyponatraemia', 'Hyperkalaemia', isNAGMA ? 'NAGMA' : null].filter(Boolean),
          note: 'Check random cortisol, ACTH stimulation test',
          urgency: 'high'
        });
      }
      
      // Hyperaldosteronism (Conn's): Hypokalaemia, possible hypernatraemia, Metabolic alkalosis
      if (k < 3.5 && isMetAlk) {
        syndromes.push({
          name: "Hyperaldosteronism / Cushing's",
          findings: ['Hypokalaemia', 'Metabolic alkalosis', na > 145 ? 'Hypernatraemia' : null].filter(Boolean),
          note: 'Check aldosterone:renin ratio, cortisol',
          urgency: 'medium'
        });
      }
      
      // Refeeding syndrome: Hypophosphataemia, Hypokalaemia, Hypomagnesaemia
      const lowPO4 = phosphate < 0.8;
      const lowK = k < 3.5;
      const lowMg = mg < 0.7;
      if ((lowPO4 && lowK) || (lowPO4 && lowMg) || (lowK && lowMg && lowPO4)) {
        syndromes.push({
          name: "Refeeding Syndrome",
          findings: [lowPO4 ? 'Hypophosphataemia' : null, lowK ? 'Hypokalaemia' : null, lowMg ? 'Hypomagnesaemia' : null].filter(Boolean),
          note: 'Consider recent nutritional rehabilitation or malnutrition',
          urgency: 'high'
        });
      }
      
      // Tumour lysis syndrome: Hyperkalaemia, Hypocalcaemia, Hyperphosphataemia, HAGMA
      if (k > 5.5 && ca < 1.0 && phosphate > 1.5) {
        syndromes.push({
          name: "Tumour Lysis Syndrome",
          findings: ['Hyperkalaemia', 'Hypocalcaemia', 'Hyperphosphataemia', isHAGMA ? 'HAGMA' : null].filter(Boolean),
          note: 'Check uric acid, LDH. Urgent oncology review',
          urgency: 'high'
        });
      }
      
      // DKA pattern: HAGMA + high glucose + ketones
      if (isHAGMA && glucose > 14) {
        syndromes.push({
          name: "Diabetic Ketoacidosis",
          findings: ['HAGMA', 'Hyperglycaemia (' + glucose?.toFixed(1) + ')'],
          note: 'Check ketones to confirm',
          urgency: 'high'
        });
      }
      
      return syndromes;
    };

    // Syndrome Pattern Screen
    const SyndromeScreen = ({ data, syndromes, onContinue, onBack }) => (
      <div style={styles.container}>
        <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
        
        <div style={styles.header} className="animate-in">
          <div style={styles.stepIndicator}>Pattern Match</div>
          <h1 style={styles.title}>Consider</h1>
        </div>

        <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '16px', textAlign: 'center' }} className="animate-in stagger-1">
          The electrolyte pattern may suggest:
        </div>

        {syndromes.map((syndrome, i) => (
          <div 
            key={i} 
            style={{
              ...styles.card,
              borderLeft: `3px solid ${syndrome.urgency === 'high' ? 'var(--error)' : 'var(--warning)'}`,
            }} 
            className={`animate-in stagger-${i + 2}`}
          >
            <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '8px' }}>{syndrome.name}</div>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '10px' }}>
              {syndrome.findings.map((f, j) => (
                <span key={j} style={{
                  padding: '3px 8px',
                  background: 'var(--bg-tertiary)',
                  borderRadius: '4px',
                  fontSize: '12px',
                  color: 'var(--text-secondary)'
                }}>{f}</span>
              ))}
            </div>
            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
              {syndrome.note}
            </div>
          </div>
        ))}

        <button
          className="animate-in stagger-5"
          style={{ ...styles.button, marginTop: '16px' }}
          onClick={onContinue}
        >
          Continue to Differential →
        </button>
      </div>
    );

    // Main Find Cause Controller
    const FindCauseScreen = ({ data, setData, approach, onBack, onRestart, onSwitchToStewart }) => {
      // For Stewart pathway, skip directly to summary - the analysis IS the endpoint
      const initialStep = approach === 'stewart' ? 'summary' : 'syndromes';
      const [currentStep, setCurrentStep] = useState(initialStep); // syndromes, overview, process-0, process-1, ..., summary
      
      // Check for syndromes
      const syndromes = checkSyndromePatterns(data);
      
      // Identify all processes
      const processes = [];
      const isMixedPrimary = data.isMetabolic && data.isRespiratory;
      
      // HAGMA - show workup for any elevated AG (including hidden HAGMA with normal/alkalemic pH)
      if (data.isHAGMA) {
        // Label reflects whether it's frank acidosis or hidden
        const hagmaLabel = data.isAcidosis 
          ? 'High anion gap metabolic acidosis'
          : 'Elevated anion gap (hidden HAGMA)';
        processes.push({ type: 'hagma', label: hagmaLabel });
        
        if (data.deltaInterpretation === 'Mixed HAGMA + NAGMA' || data.deltaInterpretation === 'Concurrent NAGMA') {
          processes.push({ type: 'nagma', label: 'Normal anion gap metabolic acidosis' });
        } else if (data.deltaInterpretation && data.deltaInterpretation.includes('metabolic alkalosis')) {
          processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
        }
      } else if (data.isMetabolic && data.isAcidosis) {
        processes.push({ type: 'nagma', label: 'Normal anion gap metabolic acidosis' });
      } else if (data.isMetabolic && data.isAlkalosis) {
        processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
      }
      
      if (data.isRespiratory) {
        if (data.isAcidosis || data.pHStatus === 'acidaemia' || (data.primaryDisorder && data.primaryDisorder.toLowerCase().includes('acidosis'))) {
          processes.push({ type: 'respacidosis', label: 'Respiratory acidosis' });
        }
        if (data.isAlkalosis || data.pHStatus === 'alkalaemia' || (data.primaryDisorder && data.primaryDisorder.toLowerCase().includes('alkalosis'))) {
          processes.push({ type: 'respalkalosis', label: 'Respiratory alkalosis' });
        }
      }
      
      if (!isMixedPrimary && data.compensationResult) {
        if (data.compensationResult.includes('Additional respiratory acidosis')) {
          processes.push({ type: 'respacidosis', label: 'Respiratory acidosis' });
        } else if (data.compensationResult.includes('Additional respiratory alkalosis')) {
          processes.push({ type: 'respalkalosis', label: 'Respiratory alkalosis' });
        } else if (data.compensationResult.includes('Additional metabolic acidosis')) {
          processes.push({ type: 'nagma', label: 'Metabolic acidosis' });
        } else if (data.compensationResult.includes('Additional metabolic alkalosis')) {
          processes.push({ type: 'metalkalosis', label: 'Metabolic alkalosis' });
        }
      }
      
      const uniqueProcesses = processes.filter((d, i, arr) => arr.findIndex(x => x.type === d.type) === i);
      
      // Progress calculation: show smooth progress through differential phase
      // Overview = 40%, each process step = proportional, summary = 100%
      const numProcesses = Math.max(uniqueProcesses.length, 1);
      const getProgressPercent = () => {
        if (currentStep === 'syndromes') return 35;
        if (currentStep === 'overview') return 40;
        if (currentStep === 'summary') return 100;
        if (currentStep.startsWith('process-')) {
          const idx = parseInt(currentStep.split('-')[1]);
          // Progress from 45% to 95% across all processes
          const progressPerProcess = 50 / numProcesses;
          return 45 + (idx * progressPerProcess);
        }
        return 40;
      };
      
      // Navigation helpers
      const goToNextProcess = (currentIndex) => {
        if (currentIndex + 1 < uniqueProcesses.length) {
          setCurrentStep(`process-${currentIndex + 1}`);
        } else {
          setCurrentStep('summary');
        }
      };
      
      const goToPrevProcess = (currentIndex) => {
        if (currentIndex > 0) {
          setCurrentStep(`process-${currentIndex - 1}`);
        } else {
          setCurrentStep('overview');
        }
      };
      
      // Syndrome screen (shows first if syndromes detected)
      if (currentStep === 'syndromes') {
        if (syndromes.length === 0) {
          // Skip to overview if no syndromes
          setCurrentStep('overview');
          return null;
        }
        return (
          <>
            <ProgressBar percent={getProgressPercent()} />
            <SyndromeScreen 
              data={data}
              syndromes={syndromes}
              onContinue={() => setCurrentStep('overview')}
              onBack={onBack}
            />
          </>
        );
      }
      
      // Overview screen
      if (currentStep === 'overview') {
        const normalPH = data.pHStatus === 'normal';
        const hiddenHAGMA = normalPH && data.isHAGMA;
        
        return (
          <>
            <ProgressBar percent={getProgressPercent()} />
            <div style={styles.container}>
              <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
              
              <div style={styles.header} className="animate-in">
                <h1 style={styles.title}>Processes to Investigate</h1>
              </div>

              <div style={styles.card} className="animate-in stagger-1">
                <div style={{ fontSize: '15px', lineHeight: '1.8' }}>
                  {uniqueProcesses.map((d, i) => (
                    <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '6px 0' }}>
                      <span style={{ width: '24px', height: '24px', borderRadius: '50%', background: 'var(--accent)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '13px', fontWeight: '600' }}>{i + 1}</span>
                      <span>{d.label}</span>
                    </div>
                ))}
                {uniqueProcesses.length === 0 && (
                  <span style={{ color: 'var(--text-secondary)' }}>Normal acid-base status</span>
                )}
              </div>
            </div>

            {hiddenHAGMA && (
              <div style={{ ...styles.warningBox, margin: '0 0 16px 0' }} className="animate-in stagger-1">
                <strong>Hidden HAGMA detected</strong><br/>
                Normal pH with elevated anion gap — suggests mixed disorder or early/compensated process
              </div>
            )}

            {uniqueProcesses.length > 0 ? (
              <button
                className="animate-in stagger-2"
                style={{ ...styles.button, marginTop: '20px' }}
                onClick={() => setCurrentStep('process-0')}
              >
                Begin Investigation →
              </button>
            ) : (
              <>
                <div style={styles.card} className="animate-in stagger-2">
                  <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                    pH, HCO₃, PaCO₂, and anion gap are within normal limits.
                  </p>
                  <div style={styles.infoBox}>
                    If clinical suspicion remains, consider repeat testing or venous blood gas.
                  </div>
                </div>
                <button
                  className="animate-in stagger-3"
                  style={{ ...styles.button, ...styles.buttonSecondary, marginTop: '20px' }}
                  onClick={onRestart}
                >
                  New Analysis
                </button>
              </>
            )}
          </div>
          </>
        );
      }
      
      // Summary screen
      if (currentStep === 'summary') {
        const lastProcessIndex = uniqueProcesses.length - 1;
        return (
          <>
            <ProgressBar percent={getProgressPercent()} />
            <SummaryScreen 
              data={data}
              processes={uniqueProcesses}
              approach={approach}
              onRestart={onRestart}
              onSwitchToStewart={onSwitchToStewart}
              onBack={() => lastProcessIndex >= 0 ? setCurrentStep(`process-${lastProcessIndex}`) : setCurrentStep('overview')}
            />
          </>
        );
      }
      
      // Process screens
      const processIndex = parseInt(currentStep.split('-')[1]);
      const currentProcess = uniqueProcesses[processIndex];
      const processNumber = processIndex + 1;
      
      if (!currentProcess) {
        setCurrentStep('summary');
        return null;
      }
      
      // Wrap process screens with progress bar
      const ProcessWrapper = ({ children }) => (
        <>
          <ProgressBar percent={getProgressPercent()} />
          {children}
        </>
      );
      
      switch (currentProcess.type) {
        case 'hagma':
          return (
            <ProcessWrapper>
              <HAGMAWorkupScreen 
                data={data}
                setData={setData}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'nagma':
          return (
            <ProcessWrapper>
              <NAGMAScreen 
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'metalkalosis':
          return (
            <ProcessWrapper>
              <MetAlkalosisScreen 
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'respacidosis':
          return (
            <ProcessWrapper>
              <RespAcidosisScreen 
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        case 'respalkalosis':
          return (
            <ProcessWrapper>
              <RespAlkalosisScreen 
                processNumber={processNumber}
                onNext={() => goToNextProcess(processIndex)}
                onBack={() => goToPrevProcess(processIndex)}
              />
            </ProcessWrapper>
          );
        default:
          return null;
      }
    };

    // ============================================
    // OXYGENATION SCREEN
    // ============================================

    const OxygenationScreen = ({ onBack }) => {
      const [paO2, setPaO2] = useState('');
      const [fiO2, setFiO2] = useState('21');
      const [paCO2, setPaCO2] = useState('');
      const [age, setAge] = useState('');
      const [showSheet, setShowSheet] = useState(null); // 'pf' or 'aa'
      
      // P/F Ratio calculation
      const fiO2Decimal = fiO2 ? parseFloat(fiO2) / 100 : null;
      const paO2Val = paO2 ? parseFloat(paO2) : null;
      const pfRatio = (paO2Val && fiO2Decimal && fiO2Decimal > 0) ? paO2Val / fiO2Decimal : null;
      
      // P/F interpretation
      const getPfInterpretation = (pf) => {
        if (!pf) return null;
        if (pf >= 400) return { text: 'Normal', color: 'success', desc: 'Normal oxygenation' };
        if (pf >= 300) return { text: 'Mild', color: 'warning', desc: 'Mild hypoxaemia' };
        if (pf >= 200) return { text: 'Moderate', color: 'warning', desc: 'Moderate ARDS criteria' };
        if (pf >= 100) return { text: 'Severe', color: 'error', desc: 'Severe ARDS criteria' };
        return { text: 'Critical', color: 'error', desc: 'Life-threatening' };
      };
      
      // A-a gradient calculation (sea level)
      const paCO2Val = paCO2 ? parseFloat(paCO2) : null;
      const ageVal = age ? parseFloat(age) : null;
      const patm = 760; // sea level
      const ph2o = 47;
      const R = 0.8;
      
      const pAO2 = (fiO2Decimal && paCO2Val) ? (fiO2Decimal * (patm - ph2o)) - (paCO2Val / R) : null;
      const aaGradient = (pAO2 && paO2Val) ? pAO2 - paO2Val : null;
      const expectedAa = ageVal ? (ageVal / 4) + 4 : null;
      const isAaElevated = aaGradient && expectedAa && aaGradient > expectedAa;
      
      const getAaInterpretation = () => {
        if (!aaGradient) return null;
        if (!isAaElevated) return { text: 'Normal', color: 'success' };
        if (aaGradient < 20) return { text: 'Mild ↑', color: 'warning' };
        if (aaGradient < 40) return { text: 'Moderate ↑', color: 'warning' };
        return { text: 'Severe ↑', color: 'error' };
      };
      
      const pfInterp = getPfInterpretation(pfRatio);
      const aaInterp = getAaInterpretation();

      return (
        <div style={styles.container}>
          <button style={styles.backButton} onClick={onBack}><BackIcon /> Back</button>
          
          <div style={styles.header} className="animate-in">
            <h1 style={styles.title}>Oxygenation</h1>
          </div>

          {/* Compact Input Row */}
          <div style={styles.card} className="animate-in stagger-1">
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '8px' }}>
              <Input label="PaO₂" unit="mmHg" value={paO2} onChange={setPaO2} placeholder="80" autoFocus />
              <Input label="FiO₂" unit="%" value={fiO2} onChange={setFiO2} placeholder="21" />
              <Input label="PaCO₂" unit="mmHg" value={paCO2} onChange={setPaCO2} placeholder="40" />
              <Input label="Age" unit="yrs" value={age} onChange={setAge} placeholder="40" />
            </div>
          </div>

          {/* Results Row - P/F and A-a side by side */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }} className="animate-in stagger-2">
            {/* P/F Ratio Card */}
            <div 
              style={{ ...styles.card, cursor: pfRatio ? 'pointer' : 'default', margin: 0 }}
              onClick={() => pfRatio && setShowSheet('pf')}
            >
              <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>P/F Ratio</div>
              {pfRatio ? (
                <>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                    <span style={{ fontSize: '32px', fontWeight: '700' }}>{pfRatio.toFixed(0)}</span>
                    <span style={styles.statusBadge(pfInterp.color)}>{pfInterp.text}</span>
                  </div>
                  <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '4px' }}>Tap for details</div>
                </>
              ) : (
                <div style={{ fontSize: '14px', color: 'var(--text-tertiary)' }}>Enter PaO₂ & FiO₂</div>
              )}
            </div>

            {/* A-a Gradient Card */}
            <div 
              style={{ ...styles.card, cursor: aaGradient ? 'pointer' : 'default', margin: 0 }}
              onClick={() => aaGradient && setShowSheet('aa')}
            >
              <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>A-a Gradient</div>
              {aaGradient ? (
                <>
                  <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                    <span style={{ fontSize: '32px', fontWeight: '700' }}>{aaGradient.toFixed(0)}</span>
                    <span style={styles.statusBadge(aaInterp.color)}>{aaInterp.text}</span>
                  </div>
                  {expectedAa && (
                    <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '4px' }}>
                      Expected &lt;{expectedAa.toFixed(0)} · Tap for details
                    </div>
                  )}
                </>
              ) : (
                <div style={{ fontSize: '14px', color: 'var(--text-tertiary)' }}>Enter all values</div>
              )}
            </div>
          </div>

          {/* Quick Reference */}
          <div style={{ ...styles.card, background: 'var(--bg-tertiary)' }} className="animate-in stagger-3">
            <div style={{ fontSize: '11px', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
              <strong>P/F:</strong> ≥400 normal · 300-399 mild · 200-299 moderate · &lt;200 severe<br/>
              <strong>A-a:</strong> Normal = (Age÷4)+4 on room air
            </div>
          </div>

          {/* P/F Bottom Sheet */}
          <BottomSheet isOpen={showSheet === 'pf'} onClose={() => setShowSheet(null)} title="P/F Ratio">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ 
                padding: '12px', 
                background: pfInterp?.color === 'success' ? 'var(--success-light)' : pfInterp?.color === 'error' ? 'var(--error-light)' : 'var(--warning-light)', 
                borderRadius: '8px', 
                marginBottom: '12px' 
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>P/F Ratio</span>
                  <span style={{ fontSize: '24px', fontWeight: '700' }}>{pfRatio?.toFixed(0)}</span>
                </div>
                <div style={{ fontSize: '13px', marginTop: '4px' }}>{pfInterp?.desc}</div>
              </div>
              
              <p><strong>What is P/F ratio?</strong></p>
              <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                PaO₂ divided by FiO₂ (as decimal). Assesses oxygenation efficiency independent of supplemental oxygen.
              </p>
              
              <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '12px', fontSize: '13px' }}>
                <p><strong>Calculation:</strong> {paO2Val} ÷ {fiO2Decimal?.toFixed(2)} = {pfRatio?.toFixed(0)}</p>
              </div>
              
              <div style={{ marginTop: '12px', fontSize: '13px' }}>
                <p><strong>ARDS Berlin Criteria:</strong></p>
                <p style={{ marginTop: '4px' }}>• ≥400: Normal</p>
                <p>• 300-399: Mild impairment</p>
                <p>• 200-299: Moderate ARDS (if bilateral infiltrates + PEEP ≥5)</p>
                <p>• 100-199: Severe ARDS</p>
                <p>• &lt;100: Critical hypoxaemia</p>
              </div>
            </div>
          </BottomSheet>

          {/* A-a Bottom Sheet */}
          <BottomSheet isOpen={showSheet === 'aa'} onClose={() => setShowSheet(null)} title="A-a Gradient">
            <div style={{ fontSize: '14px', lineHeight: '1.7' }}>
              <div style={{ 
                padding: '12px', 
                background: aaInterp?.color === 'success' ? 'var(--success-light)' : aaInterp?.color === 'error' ? 'var(--error-light)' : 'var(--warning-light)', 
                borderRadius: '8px', 
                marginBottom: '12px' 
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: '600' }}>A-a Gradient</span>
                  <span style={{ fontSize: '24px', fontWeight: '700' }}>{aaGradient?.toFixed(1)}</span>
                </div>
                {expectedAa && (
                  <div style={{ fontSize: '13px', marginTop: '4px' }}>
                    Expected for age {ageVal}: &lt;{expectedAa.toFixed(0)} mmHg
                  </div>
                )}
              </div>
              
              <p><strong>What is A-a gradient?</strong></p>
              <p style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>
                Difference between alveolar (calculated) and arterial (measured) oxygen. Detects gas exchange problems.
              </p>
              
              <div style={{ padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginTop: '12px', fontSize: '12px' }}>
                <p><strong>Formula:</strong> PAO₂ − PaO₂</p>
                <p style={{ marginTop: '4px' }}>PAO₂ = FiO₂×(760−47) − PaCO₂/0.8</p>
                <p style={{ marginTop: '4px' }}>= {fiO2Decimal?.toFixed(2)}×713 − {paCO2Val}/0.8 = {pAO2?.toFixed(1)}</p>
                <p style={{ marginTop: '4px' }}>A-a = {pAO2?.toFixed(1)} − {paO2Val} = {aaGradient?.toFixed(1)}</p>
              </div>
              
              {isAaElevated ? (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--error-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--error)' }}>Elevated A-a — causes:</strong>
                  <p style={{ marginTop: '4px' }}>• V/Q mismatch: PE, pneumonia, asthma</p>
                  <p>• Shunt: ARDS, ASD/VSD, hepatopulmonary</p>
                  <p>• Diffusion defect: ILD, pulmonary oedema</p>
                </div>
              ) : (
                <div style={{ marginTop: '12px', padding: '10px', background: 'var(--success-light)', borderRadius: '8px', fontSize: '13px' }}>
                  <strong style={{ color: 'var(--success)' }}>Normal A-a gradient</strong>
                  <p style={{ marginTop: '4px' }}>If hypoxic with normal A-a, consider:</p>
                  <p>• Hypoventilation (CNS, neuromuscular)</p>
                  <p>• Low inspired O₂</p>
                </div>
              )}
            </div>
          </BottomSheet>
        </div>
      );
    };

    // MAIN APP
    // ============================================

    const App = () => {
      const [approach, setApproach] = useState(null);
      const [step, setStep] = useState(0);
      const [data, setData] = useState({});
      const [showFindCause, setShowFindCause] = useState(false);

      const handleRestart = () => {
        setApproach(null);
        setStep(0);
        setData({});
        setShowFindCause(false);
      };

      const handleSwitchToStewart = () => {
        // Keep input data, switch to Stewart
        // Go to step 1 to let them fill in K, Ca, Mg, lactate, phosphate if needed
        // Data is preserved so basic values won't need re-entry
        setApproach('stewart');
        setShowFindCause(false);
        setStep(1);
      };

      const handleBackFromFindCause = () => {
        setShowFindCause(false);
        setStep(2);
      };

      // Landing
      if (!approach) {
        return <LandingScreen onSelect={(a) => { setApproach(a); setStep(1); }} />;
      }

      // Oxygenation screen
      if (approach === 'oxygenation') {
        return <OxygenationScreen onBack={handleRestart} />;
      }

      // Find Cause screen
      if (showFindCause) {
        return (
          <FindCauseScreen 
            data={data}
            setData={setData}
            approach={approach}
            onBack={handleBackFromFindCause} 
            onRestart={handleRestart}
            onSwitchToStewart={handleSwitchToStewart}
          />
        );
      }

      // Traditional pathway - condensed flow
      if (approach === 'traditional') {
        switch (step) {
          case 1:
            return (
              <>
                <ProgressBar percent={15} />
                <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />
              </>
            );
          case 2:
            return (
              <>
                <ProgressBar percent={30} />
                <Step2_FullAnalysis 
                  data={data} 
                  setData={setData} 
                  onNext={() => setShowFindCause(true)} 
                  onBack={() => setStep(1)} 
                />
              </>
            );
        }
      }

      // Stewart/Physicochemical pathway
      if (approach === 'stewart') {
        switch (step) {
          case 1:
            return (
              <>
                <ProgressBar percent={15} />
                <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />
              </>
            );
          case 2:
            return (
              <>
                <ProgressBar percent={30} />
                <Step2_StewartAnalysis 
                  data={data} 
                  setData={setData} 
                  onNext={() => setShowFindCause(true)} 
                  onBack={() => setStep(1)} 
                />
              </>
            );
        }
      }

      // Both - show traditional then can switch to Stewart
      if (approach === 'both') {
        switch (step) {
          case 1:
            return (
              <>
                <ProgressBar percent={15} />
                <Step1_AllValues data={data} setData={setData} onNext={() => setStep(2)} onBack={handleRestart} approach={approach} />
              </>
            );
          case 2:
            return (
              <>
                <ProgressBar percent={30} />
                <Step2_FullAnalysis 
                  data={data} 
                  setData={setData} 
                  onNext={() => setShowFindCause(true)} 
                  onBack={() => setStep(1)} 
                />
              </>
            );
        }
      }

      return null;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
